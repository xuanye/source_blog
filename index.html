<!DOCTYPE html><html class="theme-next gemini use-motion" lang="en"><head><meta name="generator" content="Hexo 3.9.0"><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1"><meta name="theme-color" content="#222"><script src="/lib/pace/pace.min.js?v=1.0.2"></script><link href="/lib/pace/pace-theme-minimal.min.css?v=1.0.2" rel="stylesheet"><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><link href="//fonts.googleapis.com/css?family=Monda:300,300italic,400,400italic,700,700italic|Roboto Slab:300,300italic,400,400italic,700,700italic|Lobster Two:300,300italic,400,400italic,700,700italic|Input Mono:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css"><link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css"><link href="/css/main.css?v=6.0.3" rel="stylesheet" type="text/css"><link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=6.0.3"><link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=6.0.3"><link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=6.0.3"><link rel="mask-icon" href="/images/logo.svg?v=6.0.3" color="#222"><script type="text/javascript" id="hexo.configurations">var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Gemini',
    version: '6.0.3',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: false,
    fastclick: false,
    lazyload: false,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };</script><meta name="keywords" content="Hexo,xuanye,blog"><meta name="description" content="xgcalendar xjplugin dotbpe 假正经哥哥 nodejs dotnet"><meta property="og:type" content="website"><meta property="og:title" content="假正经哥哥"><meta property="og:url" content="https://xuanye.github.io/index.html"><meta property="og:site_name" content="假正经哥哥"><meta property="og:description" content="xgcalendar xjplugin dotbpe 假正经哥哥 nodejs dotnet"><meta property="og:locale" content="en"><meta name="twitter:card" content="summary"><meta name="twitter:title" content="假正经哥哥"><meta name="twitter:description" content="xgcalendar xjplugin dotbpe 假正经哥哥 nodejs dotnet"><link rel="alternate" href="/atom.xml" title="假正经哥哥" type="application/atom+xml"><link rel="canonical" href="https://xuanye.github.io/"><script type="text/javascript" id="page.configurations">CONFIG.page = {
    sidebar: "",
  };</script><title>假正经哥哥 - 有心思时干有意义的活，没心情时做有意思的事</title><script type="text/javascript">var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "https://hm.baidu.com/hm.js?ca7707d791c93c26f752f47474db5e66";
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(hm, s);
    })();</script><noscript><style type="text/css">.use-motion .motion-element,
    .use-motion .brand,
    .use-motion .menu-item,
    .sidebar-inner,
    .use-motion .post-block,
    .use-motion .pagination,
    .use-motion .comments,
    .use-motion .post-header,
    .use-motion .post-body,
    .use-motion .collection-title { opacity: initial; }

    .use-motion .logo,
    .use-motion .site-title,
    .use-motion .site-subtitle {
      opacity: initial;
      top: initial;
    }

    .use-motion {
      .logo-line-before i { left: initial; }
      .logo-line-after i { right: initial; }
    }</style></noscript></head><body itemscope itemtype="http://schema.org/WebPage" lang="en"><div class="container sidebar-position-left page-home"><div class="headband"></div><header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="header-inner"><div class="site-brand-wrapper"><div class="site-meta"><div class="custom-logo-site-title"><a href="/" class="brand" rel="start"><span class="logo-line-before"><i></i></span> <span class="site-title">假正经哥哥</span> <span class="logo-line-after"><i></i></span></a></div><h1 class="site-subtitle" itemprop="description">有心思时干有意义的活，没心情时做有意思的事</h1></div><div class="site-nav-toggle"><button><span class="btn-bar"></span> <span class="btn-bar"></span> <span class="btn-bar"></span></button></div></div><nav class="site-nav"><ul id="menu" class="menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="menu-item-icon fa fa-fw fa-home"></i><br>Home</a></li><li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="menu-item-icon fa fa-fw fa-tags"></i><br>Tags</a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="menu-item-icon fa fa-fw fa-archive"></i><br>Archives</a></li><li class="menu-item menu-item-search"><a href="javascript:;" class="popup-trigger"><i class="menu-item-icon fa fa-search fa-fw"></i><br>Search</a></li></ul><div class="site-search"><div class="popup search-popup local-search-popup"><div class="local-search-header clearfix"><span class="search-icon"><i class="fa fa-search"></i> </span><span class="popup-btn-close"><i class="fa fa-times-circle"></i></span><div class="local-search-input-wrapper"><input autocomplete="off" placeholder="Searching..." spellcheck="false" type="text" id="local-search-input"></div></div><div id="local-search-result"></div></div></div></nav></div></header><main id="main" class="main"><div class="main-inner"><div class="content-wrap"><div id="content" class="content"><section id="posts" class="posts-expand"><article class="post post-type-normal" itemscope itemtype="http://schema.org/Article"><div class="post-block"><link itemprop="mainEntityOfPage" href="https://xuanye.github.io/new-style-4-plantuml-and-c4model/"><span hidden itemprop="author" itemscope itemtype="http://schema.org/Person"><meta itemprop="name" content="Xuanye"><meta itemprop="description" content><meta itemprop="image" content="/uploads/avatar.png"></span><span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content="假正经哥哥"></span><header class="post-header"><h2 class="post-title" itemprop="name headline"><a class="post-title-link" href="/new-style-4-plantuml-and-c4model/" itemprop="url">自定义PlantUML和C4 Model样式</a></h2><div class="post-meta"><span class="post-time"><span class="post-meta-item-icon"><i class="fa fa-calendar-o"></i> </span><span class="post-meta-item-text">Posted on</span> <time title="Post created" itemprop="dateCreated datePublished" datetime="2019-03-17T20:01:07+08:00">2019-03-17</time> </span><span class="post-category"><span class="post-meta-divider">|</span> <span class="post-meta-item-icon"><i class="fa fa-folder-o"></i> </span><span class="post-meta-item-text">In</span> <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/原创/" itemprop="url" rel="index"><span itemprop="name">原创</span></a></span></span></div></header><div class="post-body" itemprop="articleBody"><p><img src="https://www.plantuml.com/plantuml/png/RLAnRjim4Dtv5TSfzc1fwIGNQ8eW3RgqWJ9qB5ZgP14vaIhl65T_7rACR1WG1u6wU-_ntIFlMNIGE19e8_RDodnmU3wm7YT2zSawGx7360W6aOcRkWxwN9si3F5lP0p6Eq4dbV5Z_JzgDsCzaNPPyS0o4nxCvthKB1XgumDMK-geEuWkCSR411aGUa_apzQTWAn3qAw3cxODd7OU8YEGDvfeLdUhERZgggVsyV7ddszj--ktKcgPJJKFPCth2uOtGgc694xOuh-8BBlzKJLfNfZq2O_Azh1xJhlAknSqCQGq7WOqh_limi5EGiIzWhIQ3zWFPnUHNCjiozzzEElGVLqvpXT6OGLla1boQi4J5-9ApbNh8i9KO2cF3PcoMFnqAQ3hR7yZPVdPirpOC_8jVVMVKDd_bwiKCPRJjk1FcD7Rvrv0RIfZABWLKsHxJPm2BALii_CGiBC1pORNPcsjUHmNcP9r8VSbxEqvcu-hW50k-wYs1soAuUKDWE0uaHQyCRzyrHBvVVg98xq3" alt="流程图"></p><h2>什么是PlantUml</h2><p><a href="http://plantuml.com/" target="_blank" rel="noopener">PlantUml</a>是一个支持快速绘制的开源项目.其定义了一套完整的语言用于实现UML关系图的描述.并基于强大的graphviz图形渲染库进行UML图的生成.绘制的UML图还可以导出为图片,以及通用的矢量SVG格式文件.</p><p>如以下代码，可实现时序图</p><p></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">@startuml</span><br><span class="line">Alice -&gt; Bob: Authentication Request</span><br><span class="line">Bob --&gt; Alice: Authentication Response</span><br><span class="line"></span><br><span class="line">Alice -&gt; Bob: Another authentication Request</span><br><span class="line">Alice &lt;-- Bob: another authentication Response</span><br><span class="line">@enduml</span><br></pre></td></tr></table></figure><p></p><p><img src="http://www.plantuml.com/plantuml/png/PP11QnD15CVlyocUlUIKh8YdfOHkDb71QY6RKZo5SVRP3CxEh3DlMkFDIp7W9r1FuaamX-95qNuQr_JcLt2cNMaMOM4PVk_t_y-RFKVSagyKkoMrKBv4RnKiY6gN9edbfuDZIGl_r3kqmcX2JGDXgkIbvtg9IQsuZdRVqL9XNznDAku8RIACnK4TStlWTJ2gO08j49uPfSofrCUWf4RWkeGEbjOHa87G2Ce8hjIIzVvT3cvoMMy_Ut9mE9jdnRnuE9db3qBLvVfYytEz-VxnSdM-MNzfFdtzy-Djy-QiUN_HhD_z-hRw_M7Ld9rlFhzcqybudasd1qUizsXoV_9ubhL7Hf8KmgwJhp2zStjOyAeEvm9VUDG2TvC8XennGSR2eKFBQcv92bbpJR1pxsg3N77dTe0xoBguG65qkSL7NRxFEtREMAo0_X2o5CRcoDZdiLgUSCAGhKtucHEq4TD2EWWVRvynGfP5TvH2RZ4gqxY7evkC4MEZE9B_7v-p7FhNTWHZev6LGRPc6LZKhg_LPhOLPPZPJi-knk8MARGHMmlieIvzfVu2" alt="时序图"></p><p>可以使用常用的编辑器vscode 或者sublime 或者其他IDE工具继承PlantUml</p><p>也可以使用在线的版本 <a href="https://www.planttext.com/" target="_blank" rel="noopener">https://www.planttext.com/</a></p><p>想了解更多PlantUml或者使用方法，可参考官网<a href="http://plantuml.com/zh/" target="_blank" rel="noopener">http://plantuml.com/zh/</a>，上面详细的中英文说明</p><h2>什么是C4 Model</h2><p><a href="https://c4model.com/" target="_blank" rel="noopener">C4 Model</a> 在我眼里更像是一个标准，一个方法论。让架构师、程序员、业务人员在讨论IT系统架构时候统一维度，统一标准，更方便的理解和沟通IT系统中的真实问题。<strong>强烈推荐</strong>！！！</p><p>C4 模型由一系列分层的软件架构图组成，这些架构图用于描述上下文（Context）、容器(Container)、组件(Component)和代码(Code)。C4 图的层次结构提供了不同的抽象级别，每种抽象级别都与不同的受众有关</p><p><img src="https://c4model.com/img/bigbankplc-Containers.png" alt="C4 Model"></p><p>这篇Infoq的文章是有一个比较详细的介绍<a href="https://infoq.cn/article/C4-architecture-model" target="_blank" rel="noopener">https://infoq.cn/article/C4-architecture-model</a></p><h2>本库只是一个样式库</h2><p>本库的目的是美化PlantUml和C4 Model所绘制系统架构图的样式，统一审美而产生。</p><p>详细的使用方法，可参考sample文件夹中的示例代码 <a href="https://github.com/xuanye/plantuml-style-c4/blob/master/samples/" target="_blank" rel="noopener">https://github.com/xuanye/plantuml-style-c4/blob/master/samples/</a></p><p>&lt;!--more--&gt;</p><h3>1.时序图</h3><p>在PlantUml代码中引用</p><p></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">@startuml sequence-sample</span><br><span class="line">!includeurl https://raw.githubusercontent.com/xuanye/plantuml-style-c4/master/core.puml</span><br><span class="line">&apos; 如果使用本地，则需要注释上一行，取消注释下一行</span><br><span class="line">&apos;!include core.puml</span><br><span class="line"></span><br><span class="line">&apos; 使用红色箭头，默认为灰色</span><br><span class="line">RED_ARROW</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">@enduml</span><br></pre></td></tr></table></figure><p></p><p><img src="https://www.plantuml.com/plantuml/img/PP71RjD054NtxoiUtMJb625MKHNLTW9852h5gQgkec7yQ4QCPypCk2Nis5H4wXS0AzGL4bbKR43Ghy6aEtw16MFKH4YMxD5vzzvvrtlMCUFgKgAbbpKfJf5bPIK9xWZ5PLrGRIJEdQli88uDE-kV23UldzMM3DVAaN9zhiluLStKWk9ACXNS8kiMaY9-FowPTMHYhWtrAq-WXxNoYj8hqSq9dsifzPbG9oY58cIgm2qiZFLV6dqYIisPb0le_RiStlf2RpyvFZYSpf9ybZyUJxD7FkfcTRt-iLf_-tYpl5glFZUNNtv_lsZUdZVlhvlLkvzVbxy-B9lpg_MdDp0PZsR9P79m1BqduuVZfzEaEu8JJXBkMl6Q1lVk3lEs7yoxldRZ08O0Z3jjyD0N0vNlL71H-J9mvq6xGIQPjJl8B2RRE2VVOx71qss-pxRK6K28m6Y8oG17-aYR5o5Qd397tbjf_zAdVi9ZDnSM_SEw6WE496ZJ0MQ6WcGIzh3krYC5ICD8zhzz1Xb6VzK1ZBGYABpOw4MuMDf2dzjvTX65dzbqJzgni4L8Q2qs5W3O8rMqVnJW3m00" alt="时序图"></p><h3>2. 类图</h3><p>以下为示例</p><p></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">@startuml 示例类图</span><br><span class="line"></span><br><span class="line">!includeurl https://raw.githubusercontent.com/xuanye/plantuml-style-c4/master/core.puml</span><br><span class="line">&apos; uncomment the following line and comment the first to use locally</span><br><span class="line">&apos;!include core.puml</span><br><span class="line"></span><br><span class="line">GREY_ARROW</span><br><span class="line"></span><br><span class="line">abstract class BaseClass &#123;</span><br><span class="line">    +  AbstractMethod() : void</span><br><span class="line">    #  VirtualMethod(s:string) : int</span><br><span class="line">&#125;</span><br><span class="line">class SubClass &#123;</span><br><span class="line">    + AbstractMethod() : void</span><br><span class="line">    # VirtualMethod(s:string) : int</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">interface IInterfaceA &#123;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">interface &quot;IInterfaceA`1&quot;&lt;T&gt; &#123;</span><br><span class="line">    Value : T &lt;&lt;get&gt;&gt;</span><br><span class="line">&#125;</span><br><span class="line">class ImplementClass &#123;</span><br><span class="line">    + Value : int &lt;&lt;get&gt;&gt;</span><br><span class="line">&#125;</span><br><span class="line">BaseClass &lt;|-- SubClass</span><br><span class="line">IInterfaceA &lt;|-- &quot;IInterfaceA`1&quot;</span><br><span class="line">&quot;IInterfaceA`1&quot; &quot;&lt;int&gt;&quot; &lt;|-- ImplementClass</span><br><span class="line"></span><br><span class="line">@enduml</span><br></pre></td></tr></table></figure><p></p><p><img src="http://www.plantuml.com/plantuml/png/9Osn3S9G30Lxfe01yjrGKMKLurWaah_pPJyBiZr4LAShJZSdE53TBhVDnMhH2hkkmCW7KV2xlJQizQpKaDsXZYPxfq-n7qh3sCzwIXocazofSqA3alimJHBZpEblRPoVMNtvyGi0" alt="类图"></p><h3>3. 状态图</h3><p></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">@startuml state-sample</span><br><span class="line">!includeurl https://raw.githubusercontent.com/xuanye/plantuml-style-c4/master/core.puml</span><br><span class="line">&apos; uncomment the following line and comment the first to use locally</span><br><span class="line">&apos;!include core.puml</span><br><span class="line"></span><br><span class="line">GREEN_ARROW</span><br><span class="line"></span><br><span class="line">title HTTP Request Parsing States</span><br><span class="line"></span><br><span class="line">[*] --&gt; RequestLine</span><br><span class="line"></span><br><span class="line">RequestLine : Parse HTTP</span><br><span class="line">RequestLine : request line</span><br><span class="line">RequestLine --&gt; Headers : Ok</span><br><span class="line">RequestLine --&gt; Error : Failure</span><br><span class="line"></span><br><span class="line">Headers : Parse HTTP</span><br><span class="line">Headers : headers</span><br><span class="line">Headers --&gt; Host : Ok</span><br><span class="line">Headers --&gt; Error : Failure</span><br><span class="line"></span><br><span class="line">Host : Check host</span><br><span class="line">Host : header is present</span><br><span class="line">Host --&gt; Length : Not chunked</span><br><span class="line">Host --&gt; Chunked : Chunked</span><br><span class="line">Host --&gt; Error : Failure</span><br><span class="line"></span><br><span class="line">Length : Check if required,</span><br><span class="line">Length : valid &amp; size</span><br><span class="line">Length --&gt; Error : Failure</span><br><span class="line">Length --&gt; Error : Entity Too Large</span><br><span class="line">Length --&gt; [*] : Ok</span><br><span class="line"></span><br><span class="line">Chunked : Parse HTTP</span><br><span class="line">Chunked : chunk header</span><br><span class="line">Chunked --&gt; Error : Failure</span><br><span class="line">Chunked --&gt; [*] : Ok</span><br><span class="line"></span><br><span class="line">@enduml</span><br></pre></td></tr></table></figure><p></p><p><img src="http://www.plantuml.com/plantuml/png/9Oqn3i8m34LtJW47IBmmCVKg9hLe9SUDx6z1RmyHqzCRdjuIO4TslTnsQvghfEjr0qOyY9pVzRLZosU6U3iCOgZjwFH9jbDeADkiI-1KAUrEdGFY5Do7Ib208ULlTSpF8hR--0K0" alt="状态图"></p><h3>4. 用例图</h3><p></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">@startuml usecase-sample</span><br><span class="line">!includeurl https://raw.githubusercontent.com/xuanye/plantuml-style-c4/master/core.puml</span><br><span class="line">&apos; uncomment the following line and comment the first to use locally</span><br><span class="line">&apos;!include core.puml</span><br><span class="line"></span><br><span class="line">&apos; 设置方向</span><br><span class="line">LAYOUT_LEFT_RIGHT</span><br><span class="line">&apos;LAYOUT_TOP_DOWN</span><br><span class="line">&apos;LAYOUT_AS_SKETCH</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">actor customer</span><br><span class="line">actor clerk</span><br><span class="line"></span><br><span class="line">UserCasePackage(&quot;checkout&quot;,&quot;买单&quot;) &#123;</span><br><span class="line">    customer -- (checkout)</span><br><span class="line">    (checkout) .&gt; (payment) : include</span><br><span class="line">    (help) .&gt; (checkout) : extends</span><br><span class="line">    (checkout) -- clerk</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">@enduml</span><br></pre></td></tr></table></figure><p></p><p><img src="http://www.plantuml.com/plantuml/img/9Oqx3i9030LxJW47oBgXeifLZFD48dcTbJ-2t1uYgj4KevaZsREwNcwRYTQ2ShskcICUHCxlzjfohMS5N7PBM3RPEtsAxG0DPJlhAV9GJ7Adpf5m2kv34LG1uS3qzpREqmnRVlm2" alt="用例图"></p><h3>5. 活动图</h3><p></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">@startuml activity-new-sample</span><br><span class="line">!includeurl https://raw.githubusercontent.com/xuanye/plantuml-style-c4/master/core.puml</span><br><span class="line">&apos; uncomment the following line and comment the first to use locally</span><br><span class="line">&apos;!include core.puml</span><br><span class="line"></span><br><span class="line">GREEN_ARROW</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">start</span><br><span class="line">:ClickServlet.handleRequest();</span><br><span class="line">:new page;</span><br><span class="line">if (Page.onSecurityCheck) then (true)</span><br><span class="line">    :Page.onInit();</span><br><span class="line">    if (isForward?) then (no)</span><br><span class="line">        :Process controls;</span><br><span class="line">        if (continue processing?) then (no)</span><br><span class="line">            stop</span><br><span class="line">        endif</span><br><span class="line">        if (isPost?) then (yes)</span><br><span class="line">            :Page.onPost();&lt;</span><br><span class="line">        else (no)</span><br><span class="line">            :Page.onGet();</span><br><span class="line">        endif</span><br><span class="line">        :Page.onRender();</span><br><span class="line">    endif</span><br><span class="line">else (false)</span><br><span class="line">endif</span><br><span class="line">if (do redirect?) then (yes)</span><br><span class="line">    :redirect process;</span><br><span class="line">else</span><br><span class="line">    if (do forward?) then (yes)</span><br><span class="line">        :Forward request;</span><br><span class="line">    else (no)</span><br><span class="line">        :Render page template;</span><br><span class="line">    endif</span><br><span class="line">endif</span><br><span class="line"></span><br><span class="line">stop</span><br><span class="line">@enduml</span><br></pre></td></tr></table></figure><p></p><p><img src="https://www.plantuml.com/plantuml/img/9Or13i8m30JlVGKy8F654wT-nQGMZUIuKRoczFTGk8r66itiu85eEatNQaLZaHXwMO7kTwB1UtvMhF48br4sWnXosHgzW-qGwifsvibngAHoeyOE6UJSkeeJ5zHNnP5CzlINkVz-izZoXGy0" alt="活动图"></p><h3>6. 其他组件</h3><p></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">@startuml element</span><br><span class="line">!includeurl https://raw.githubusercontent.com/xuanye/plantuml-style-c4/master/core.puml</span><br><span class="line">&apos; uncomment the following line and comment the first to use locally</span><br><span class="line">&apos;!include core.puml</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">actor actor</span><br><span class="line">agent agent</span><br><span class="line">artifact artifact</span><br><span class="line">boundary boundary</span><br><span class="line">card card</span><br><span class="line">cloud cloud</span><br><span class="line">component component</span><br><span class="line">control control</span><br><span class="line">database database</span><br><span class="line">entity entity</span><br><span class="line">file file</span><br><span class="line">folder folder</span><br><span class="line">frame frame</span><br><span class="line">interface  interface</span><br><span class="line">node node</span><br><span class="line">package package</span><br><span class="line">queue queue</span><br><span class="line">stack stack</span><br><span class="line">rectangle rectangle</span><br><span class="line">storage storage</span><br><span class="line">usecase usecase</span><br><span class="line">@enduml</span><br></pre></td></tr></table></figure><p></p><p><img src="https://www.plantuml.com/plantuml/img/7Sqx3eD034NHdbKa2m0tgLAn5MTu2aYs6VcZXDqdqDtcwCwHx5agmt3Vh4ajA9VRcjdZIUJycTvRhlMgWBVT4fPJsvM-nNQ0kh2TV8my16Dxa78ad8Ar2u8WqDFqwp73bd_y0000" alt="其他组件"></p><h2>C4 模型</h2><h3>1.System Context</h3><p></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">@startuml system-context-diagram</span><br><span class="line"></span><br><span class="line">!includeurl https://raw.githubusercontent.com/xuanye/plantuml-style-c4/master/c4_context.puml</span><br><span class="line">&apos; uncomment the following line and comment the first to use locally</span><br><span class="line">&apos;!include c4_context.puml</span><br><span class="line"></span><br><span class="line">LAYOUT_WITH_LEGEND</span><br><span class="line"></span><br><span class="line">title System Context diagram for Internet Banking System</span><br><span class="line"></span><br><span class="line">Actor(customer, &quot;Personal Banking Customer&quot;, &quot;A customer of the bank, with personal bank accounts.&quot;)</span><br><span class="line">System(banking_system, &quot;Internet Banking System&quot;, &quot;Allows customers to view information about their bank accounts, and make payments.&quot;)</span><br><span class="line"></span><br><span class="line">System_Ext(mail_system, &quot;E-mail system&quot;, &quot;The internal Microsoft Exchange e-mail system.&quot;)</span><br><span class="line">System_Ext(mainframe, &quot;Mainframe Banking System&quot;, &quot;Stores all of the core banking information about customers, accounts, transactions, etc.&quot;)</span><br><span class="line"></span><br><span class="line">Rel(customer, banking_system, &quot;Uses&quot;)</span><br><span class="line">Rel_Back(customer, mail_system, &quot;Sends e-mails to&quot;)</span><br><span class="line">Rel_Neighbor(banking_system, mail_system, &quot;Sends e-mails&quot;, &quot;SMTP&quot;)</span><br><span class="line">Rel(banking_system, mainframe, &quot;Uses&quot;)</span><br><span class="line"></span><br><span class="line">@enduml</span><br></pre></td></tr></table></figure><p></p><p><img src="https://www.plantuml.com/plantuml/png/VL7DRjf04BxxAQPSe1BWIquzXQIeZHJIg11LFLd3Ck0L-sFjpXRyzXqRcq9AU_FkVl--Zuo1apNP1-sKIHjAmK39NCLFUHxmCDrfBjCwHGhAEoR7K-LjVapeQiehWwvXJoBNXYRgBhSOcKAkxeeMVkHfrQWF8JdXMU43bmHRRum_QBS3enq1kWrSFUiGvSk3-8Bn2esfis4V4TwhPyFdsSzlRwlYnzFgQ_4y_p9_-PnbhDaGB6i9PE7nX8UDnbr02riVu4ckWYE61tHxoT9Xisocs8UHIf6zfJ26mIk5w1sQC_AnUnl8umnw9FXj6tyjg34SP3ceUcPp1wYKJuxZTF0nEvcDrYV58hP7aVj7gjQf6IsUxMApq2zD1z1E-bXaxHtWsgTsHHskJSVjp1Rt11NMbheSNP1YVkIHHMt-99bFcZF4i_-g9B5Y2asXXLR1Hxzbc1zLYMv7G9S4qNudxRQoF8dEel--qN4fqrC4DAPVKya5T3FTQ7fUOtpHb0EwYAg1oObOjKs_axdugtyj_nOf2anGnGEg_GNqUfSbkKtioZR_eEEyaDwLQnz6ryB_PRUD5wlNayGjPZzQd-vUwCcQtm00" alt="System Context"></p><h3>2. Container</h3><p></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line">@startuml container-diagram</span><br><span class="line">!includeurl https://raw.githubusercontent.com/xuanye/plantuml-style-c4/master/c4_container.puml</span><br><span class="line">&apos; uncomment the following line and comment the first to use locally</span><br><span class="line">&apos;!include c4_container.puml</span><br><span class="line"></span><br><span class="line">LAYOUT_TOP_DOWN</span><br><span class="line">&apos;LAYOUT_AS_SKETCH</span><br><span class="line">LAYOUT_WITH_LEGEND_CN</span><br><span class="line"></span><br><span class="line">LAYOUT_TOP_DOWN</span><br><span class="line">&apos;LAYOUT_AS_SKETCH</span><br><span class="line">LAYOUT_WITH_LEGEND</span><br><span class="line"></span><br><span class="line">title Container diagram for Internet Banking System</span><br><span class="line"></span><br><span class="line">Actor(customer, Customer, &quot;A customer of the bank, with personal bank accounts&quot;)</span><br><span class="line"></span><br><span class="line">System_Boundary(c1, &quot;Internet Banking&quot;) &#123;</span><br><span class="line">    Container(web_app, &quot;Web Application&quot;, &quot;Java, Spring MVC&quot;, &quot;Delivers the static content and the Internet banking SPA&quot;)</span><br><span class="line">    Container(spa, &quot;Single-Page App&quot;, &quot;JavaScript, Angular&quot;, &quot;Provides all the Internet banking functionality to cutomers via their web browser&quot;)</span><br><span class="line">    Container(mobile_app, &quot;Mobile App&quot;, &quot;C#, Xamarin&quot;, &quot;Provides a limited subset of the Internet banking functionality to customers via their mobile device&quot;)</span><br><span class="line">    ContainerDb(database, &quot;Database&quot;, &quot;SQL Database&quot;, &quot;Stores user registraion information, hased auth credentials, access logs, etc.&quot;)</span><br><span class="line">    Container(backend_api, &quot;API Application&quot;, &quot;Java, Docker Container&quot;, &quot;Provides Internet banking functionality via API&quot;)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">System_Ext(email_system, &quot;E-Mail System&quot;, &quot;The internal Microsoft Exchange system&quot;)</span><br><span class="line">System_Ext(banking_system, &quot;Mainframe Banking System&quot;, &quot;Stores all of the core banking information about customers, accounts, transactions, etc.&quot;)</span><br><span class="line"></span><br><span class="line">Rel(customer, web_app, &quot;Uses&quot;, &quot;HTTPS&quot;)</span><br><span class="line">Rel(customer, spa, &quot;Uses&quot;, &quot;HTTPS&quot;)</span><br><span class="line">Rel(customer, mobile_app, &quot;Uses&quot;)</span><br><span class="line"></span><br><span class="line">Rel_Neighbor(web_app, spa, &quot;Delivers&quot;)</span><br><span class="line">Rel(spa, backend_api, &quot;Uses&quot;, &quot;async, JSON/HTTPS&quot;)</span><br><span class="line">Rel(mobile_app, backend_api, &quot;Uses&quot;, &quot;async, JSON/HTTPS&quot;)</span><br><span class="line">Rel_Back_Neighbor(database, backend_api, &quot;Reads from and writes to&quot;, &quot;sync, JDBC&quot;)</span><br><span class="line"></span><br><span class="line">Rel_Back(customer, email_system, &quot;Sends e-mails to&quot;)</span><br><span class="line">Rel_Back(email_system, backend_api, &quot;Sends e-mails using&quot;, &quot;sync, SMTP&quot;)</span><br><span class="line">Rel_Neighbor(backend_api, banking_system, &quot;Uses&quot;, &quot;sync/async, XML/HTTPS&quot;)</span><br><span class="line">@enduml</span><br></pre></td></tr></table></figure><p></p><p><img src="https://www.plantuml.com/plantuml/img/bLN1Zjf84BtxAsh9OOXa1aNAQKzX06Kc6MROcEma9wlSBg2LThVLtOP1g_tthJQsmH1jTZdPvQfNhr-zQZuuZzPNXG9Xj4UfoOvoYHkBHVIRr49LELLMmTRxqlq-7blStswatrPPvSY66jB-LfXY_5gXFj2uLAW3tiZvWwAHU3ykq7coO_4-xLhSbfmHtK2bkR9W1F1RWhLHokobte3Y942TG--pj8wV371dK4QWKeVefYK9r_ZHu-JxyzTLkdfUfhFdbwVefWbCaZJvF5zDxxl8oyFgFdsSVvm_pQB8Iwy8fYqOD7emFmiFV62hoSCTwX-1QdBWqnLHD17UsA6ed3S5sHYctTDW0cqOpBe-IiR5CUnPHoZ9EgDHrJ508KoblHkyZQ8ZSdh7WHpjOIZUCTPb_y5R-2i2_dLqXtlAKYnBJdwX32PbgQH0BuqUSEWJxZ26fBI1--BFQOZDICaTqwYfiH-y5D1CjXv227Tzi_RSomcJx7Ts9MCF4lxCar_YXaBtjciYh2nz31EzgHJQ45vQivCvEU1H_hpBcXqIgAEI_X1cBwfQI0SxYQ54Mk3pGcRDdlrunQWmcLJKoB6eNrfEqpSnVCC2MOa-5tPV8JtbuAhCCPTcPl-5cxiYToG0EUsae4jwisoOeySC7OKnD8-1JVB78_JUsLpCBUmSMDf8voroQv2QJLdKqurXoyavOCMk4fPo7fz4vU9WAdAELsR3B-J5xPLC6OeVf7FMIGQ_BXz-RfkPuJHxgklfzWjzWYGCpAt_xgmzV_L3Ab2grDK1XfkF5lpUR5N0Nx7qieRc7Lb8OOqpQm_pLx55pGuxLZBi6MR3u8JAc7hDAqmNQticRR1WCsd1WUuKPme3PgRofp77tRh6mFFG3klpdaIElf0wkn9EY_dLaGkzxrUhPSA9_RpZ6lrxJi_OTUgnNVf4ShFDpDarS8Hhbxn1geFziRSDqHsqYE5JylmqFcz-tl9_LQPtd7qYTh9y7-KBOUvWRKrHtpfxoql8Tv89o0tmx6xQdZDWdkbnOQE4OHtGA4HhZ1EH2yVrEVJhAXTksAvzibWj6w3kCBtoAz-rmeJwSQFEjyLZ9yu7BkL_gdy0" alt="容器图"></p><h3>3.Component</h3><p>组件图</p><p></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">@startuml component-diagram</span><br><span class="line">!includeurl https://raw.githubusercontent.com/xuanye/plantuml-style-c4/master/c4_component.puml</span><br><span class="line">&apos; uncomment the following line and comment the first to use locally</span><br><span class="line">&apos;!include c4_component.puml</span><br><span class="line"></span><br><span class="line">LAYOUT_WITH_LEGEND</span><br><span class="line"></span><br><span class="line">title Component diagram for Internet Banking System - API Application</span><br><span class="line"></span><br><span class="line">Container(spa, &quot;Single Page Application&quot;, &quot;javascript and angular&quot;, &quot;Provides all the internet banking functionality to customers via their web browser.&quot;)</span><br><span class="line">Container(ma, &quot;Mobile App&quot;, &quot;Xamarin&quot;, &quot;Provides a limited subset ot the internet banking functionality to customers via their mobile mobile device.&quot;)</span><br><span class="line">ContainerDb(db, &quot;Database&quot;, &quot;Relational Database Schema&quot;, &quot;Stores user registration information, hashed authentication credentials, access logs, etc.&quot;)</span><br><span class="line">System_Ext(mbs, &quot;Mainframe Banking System&quot;, &quot;Stores all of the core banking information about customers, accounts, transactions, etc.&quot;)</span><br><span class="line"></span><br><span class="line">Container_Boundary(api, &quot;API Application&quot;) &#123;</span><br><span class="line">    Component(sign, &quot;Sign In Controller&quot;, &quot;MVC Rest Controlle&quot;, &quot;Allows users to sign in to the internet banking system&quot;)</span><br><span class="line">    Component(accounts, &quot;Accounts Summary Controller&quot;, &quot;MVC Rest Controlle&quot;, &quot;Provides customers with a summory of their bank accounts&quot;)</span><br><span class="line">    Component(security, &quot;Security Component&quot;, &quot;Spring Bean&quot;, &quot;Provides functionality related to singing in, changing passwords, etc.&quot;)</span><br><span class="line">    Component(mbsfacade, &quot;Mainframe Banking System Facade&quot;, &quot;Spring Bean&quot;, &quot;A facade onto the mainframe banking system.&quot;)</span><br><span class="line"></span><br><span class="line">    Rel(sign, security, &quot;Uses&quot;)</span><br><span class="line">    Rel(accounts, mbsfacade, &quot;Uses&quot;)</span><br><span class="line">    Rel(security, db, &quot;Read &amp; write to&quot;, &quot;JDBC&quot;)</span><br><span class="line">    Rel(mbsfacade, mbs, &quot;Uses&quot;, &quot;XML/HTTPS&quot;)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">Rel(spa, sign, &quot;Uses&quot;, &quot;JSON/HTTPS&quot;)</span><br><span class="line">Rel(spa, accounts, &quot;Uses&quot;, &quot;JSON/HTTPS&quot;)</span><br><span class="line"></span><br><span class="line">Rel(ma, sign, &quot;Uses&quot;, &quot;JSON/HTTPS&quot;)</span><br><span class="line">Rel(ma, accounts, &quot;Uses&quot;, &quot;JSON/HTTPS&quot;)</span><br><span class="line"></span><br><span class="line">@enduml</span><br></pre></td></tr></table></figure><p></p><p><img src="https://www.plantuml.com/plantuml/img/fLLDKzim4BtxLsnpA646oAMddXe2BL1e6HpwSSgivOsZLXyUIIRDTFhVkv8Jsm6cmqnpYRnQxRvzxyb-vmEwq6W5mkhQ6ZBXk9HOETJPAsc4Qafgd89L2BL_EvauN9zKCgoQel7aX3M1JvpmsScl1is69hL24-iT-x1HT2pUJ3JwG6uYtYow5YSrPsG7q1WEQGv0M14ihL9sBKq5IXe2D2NiRKldUMM1EuEo0fNQP0SxaF2qVdPmFVt--Nw--7evlrXSdtyu_tJMnQRv8lzuFfzTP5cGGH7CTeTXEp_ZSN390pf30KxH_8pGyWrFe-4OfhUNCArh9GK6QKsMpPWCPE1kx6iyWb7EwLpt5YiQ9evuwmS-e1TErY5DYQPg5BguS-liWop90q-NffOx0CKMm999YtLGoR29T8Z61wl9UNYG6Cz81sige71spHgTZ0u7q7H4TcCBgHAesF8RQdJIx7Td2RGCL89l2i_TRVWFDBhjj_qhwK4AseDrLepBWlkVOS02FKKiTwImhGoxCEHYHHhZRXwiOvpHXE2eaZwubCq8MJQTraUmGh_Y6R1X72Pi1G3Xg8oFgFmHe13aFVkfuWSA8k9gDLwS_mfZNVX86ADSiYNeaGq6IA9UTfb84Xpe21hW0Ini4tg6KdFRcC0hXcyy9Yfx73r1YrFEAz5jnbXBRlh8VAD3-9q1_peJZxsiJ39XPTZ442ivlb-KN7RpPGPtnBUf2yVeD5w_bbCVfOmb67zSFgkzRpauVDIv7seqtIuXRpIRRFCY69q9Uokj-Ot3dlHSnNALbcSsLaJIaVW4Y2VHEBPbf66xx7UJTBMBSvmIxhj_tzGk6f5Tb1WnLIlg4OWLjWyrUh-shknrsuV15bgYm9B-OIHudpAU0JM5zZ0mHQqEkgknBqHoJ6pDDsSh_u21UqyxXk9-Bz8GtgEa_dYwdNU49Ro6DOU8sOZehivEPuC3WrhjnKa5uplcvdfoCP_Vvfpy9yjIyVYItBfqbtQLV_xKvNL90qCzcvWozGkgwPSKUqUcvA_7Nm00" alt="组件图"></p><h3>4 Code</h3><p>类图上面已经演示过了</p><h3>5. 扩展图</h3><p></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line">@startuml system-context-extend-diagram</span><br><span class="line">!includeurl https://raw.githubusercontent.com/xuanye/plantuml-style-c4/master/c4_context.puml</span><br><span class="line">&apos; uncomment the following line and comment the first to use locally</span><br><span class="line">&apos;!include c4_context.puml</span><br><span class="line"></span><br><span class="line">&apos;LAYOUT_TOP_DOWN</span><br><span class="line">&apos;LAYOUT_AS_SKETCH</span><br><span class="line">LAYOUT_WITH_LEGEND</span><br><span class="line"></span><br><span class="line">title System Landscape diagram for Big Bank plc</span><br><span class="line"></span><br><span class="line">Actor(customer, &quot;Personal Banking Customer&quot;, &quot;A customer of the bank, with personal bank accounts.&quot;)</span><br><span class="line"></span><br><span class="line">Enterprise_Boundary(c0, &quot;Big Bank plc&quot;) &#123;</span><br><span class="line">    System(banking_system, &quot;Internet Banking System&quot;, &quot;Allows customers to view information about their bank accounts, and make payments.&quot;)</span><br><span class="line"></span><br><span class="line">    System_Ext(atm, &quot;ATM&quot;, &quot;Allows customers to withdraw cash.&quot;)</span><br><span class="line">    System_Ext(mail_system, &quot;E-mail system&quot;, &quot;The internal Microsoft Exchange e-mail system.&quot;)</span><br><span class="line"></span><br><span class="line">    System_Ext(mainframe, &quot;Mainframe Banking System&quot;, &quot;Stores all of the core banking information about customers, accounts, transactions, etc.&quot;)</span><br><span class="line"></span><br><span class="line">    Person_Ext(customer_service, &quot;Customer Service Staff&quot;, &quot;Customer service staff within the bank.&quot;)</span><br><span class="line">    Person_Ext(back_office, &quot;Back Office Staff&quot;, &quot;Administration and support staff within the bank.&quot;)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">Rel_Neighbor(customer, banking_system, &quot;Uses&quot;)</span><br><span class="line">Rel_R(customer, atm, &quot;Withdraws cash using&quot;)</span><br><span class="line">Rel_Back(customer, mail_system, &quot;Sends e-mails to&quot;)</span><br><span class="line"></span><br><span class="line">Rel_R(customer, customer_service, &quot;Asks questions to&quot;, &quot;Telephone&quot;)</span><br><span class="line"></span><br><span class="line">Rel_D(banking_system, mail_system, &quot;Sends e-mail using&quot;)</span><br><span class="line">Rel_R(atm, mainframe, &quot;Uses&quot;)</span><br><span class="line">Rel_R(banking_system, mainframe, &quot;Uses&quot;)</span><br><span class="line">Rel_D(customer_service, mainframe, &quot;Uses&quot;)</span><br><span class="line">Rel_U(back_office, mainframe, &quot;Uses&quot;)</span><br><span class="line"></span><br><span class="line">Lay_D(atm, banking_system)</span><br><span class="line"></span><br><span class="line">Lay_D(atm, customer)</span><br><span class="line">Lay_U(mail_system, customer)</span><br><span class="line"></span><br><span class="line">@enduml</span><br></pre></td></tr></table></figure><p></p><p><img src="https://www.plantuml.com/plantuml/img/TLHDR-8m4BtxLynoAPNus4DFUogKQ5ijBLK1LNkAZEE0XMDdRQU0LllVT-maaBG12IcUppTlddrl7JMko2JOatKy6pAj73-w8VwvIeQ9e5j3C_9DA2QBX1T6miwvtFuOZmqzZBR2xOfDORa9YSgDcCx6nuAg4n_daYfVUsZTIV8Xknjd59kOCRkBgpwZ7Fta1Wg5UHdcWzjnIBMK-Y3K5gHG7AXAeEKMnkAN1kmBKZCgvOdSr13XStLoCv_yNgnNyMhn6iyMxozdmsGPBtz5guV7i-NzQVKOpwEVqSkC42USvB0CnC0SKLX6SmuL9uZIm5HiOKhL7dB929amfqsV5TRfZ9i1z5wviLfH6MByF0-LhuVE2TIHeDCms0QZ1d10JY6lCxqDA6EwKCwEUhU4H3YRoOsmF9wYDQ7cr6VViM0JJEyM_XB0Nmc_loa1nEMQCVZ9Lr7SdQ6LWG6OPz-UqLbFzOVW1n0APywe4re1tUWYh4EODiP1s5T6znnoUl9BAs5VmCJHqVMfyoWcg-Th7JqD2MeC6BKxN-5JWOmAUHad6lfpfM9VSeLyYZ0ZalWicD5MfmwY8zjHjUN0cmbT0D6jKjmpnsBFzNS7MqlSERU08gpNoD005U4Td9sd73GuSuOgIvaFmnDtx0ofr520L6V6UDy-1FF8Qa71iZJ1qj4qxJKzLJ1Oxmcq2dMMMqrieyk6idsiqxHiCCKJBCBfKdkIP489Yw3BkN3XjiXpRTprBly8UUCoVk5YkzkqhiaNRQujjvZXmzyQSQLatYjTs20CV0CmjGhsM1lnROKiyJsprTgzm3o_dpjq43onUmj_2cx3QdoU5nUNFDzfnUiYioyNx7hp5kItyY8qnTQQlgDiL-2iGnjNGjVj1NT4aJazOSK0hDs_xQjRtWRZkdqZBqvoZyFZG_mV" alt="扩展图"></p><h2>参考</h2><p>C4 Model的配色和实现大部分都是直接使用 <a href="https://github.com/RicardoNiepel/C4-PlantUML" target="_blank" rel="noopener">https://github.com/RicardoNiepel/C4-PlantUML</a>的,只有几个配色略有调整，并抽取出颜色的文件，可单独替换c4_theme 以实现其他配色</p></div><footer class="post-footer"><div class="post-eof"></div></footer></div></article><article class="post post-type-normal" itemscope itemtype="http://schema.org/Article"><div class="post-block"><link itemprop="mainEntityOfPage" href="https://xuanye.github.io/a-lightweight-and-fast-socket-lib-base-on-dotnetty/"><span hidden itemprop="author" itemscope itemtype="http://schema.org/Person"><meta itemprop="name" content="Xuanye"><meta itemprop="description" content><meta itemprop="image" content="/uploads/avatar.png"></span><span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content="假正经哥哥"></span><header class="post-header"><h2 class="post-title" itemprop="name headline"><a class="post-title-link" href="/a-lightweight-and-fast-socket-lib-base-on-dotnetty/" itemprop="url">使用Peach简化Socket网络通讯协议开发</a></h2><div class="post-meta"><span class="post-time"><span class="post-meta-item-icon"><i class="fa fa-calendar-o"></i> </span><span class="post-meta-item-text">Posted on</span> <time title="Post created" itemprop="dateCreated datePublished" datetime="2019-02-27T11:01:07+08:00">2019-02-27</time> </span><span class="post-category"><span class="post-meta-divider">|</span> <span class="post-meta-item-icon"><i class="fa fa-folder-o"></i> </span><span class="post-meta-item-text">In</span> <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/原创/" itemprop="url" rel="index"><span itemprop="name">原创</span></a></span></span></div></header><div class="post-body" itemprop="articleBody"><p><img src="http://ww1.sinaimg.cn/large/697065c1ly1g0ky6oxiznj21hc0gohdu.jpg" alt></p><p>Peach是基于<a href="https://github.com/Azure/DotNetty" target="_blank" rel="noopener">DotNetty</a>的Socket网络通讯帮助类库，可以帮助开发者简化使用DotNetty，关于DotNetty可参考我之前的<a href="http://xuanye.github.io/dotnetty-quickstart/">这篇文章</a>。 Peach内置实现了一个基于文本协议的CommandLineProtocol，下面的实例以这个协议展开，最后以<a href="https://github.com/dotbpe/dotbpe" target="_blank" rel="noopener">DotBPE</a>中Amp协议来介绍下如何扩展自定义协议。</p><p>Github地址: https://github.com/xuanye/Peach</p><h1>QuickStart 使用</h1><p>添加引用</p><blockquote><p>dotnet nuget add Peach</p></blockquote><p>要使用Peach编写网络程序，一般只需要三个步骤</p><ol><li>实现协议传输消息IMessage</li><li>实现协议打包和解包逻辑IProtocol</li><li>实现ISocketService完成服务端逻辑编写 &lt;!-- more --&gt; 在快速开始的实例中，我们使用内置的CommandLineProtocol，所以省去了步骤1,2让我们开始吧！</li></ol><h2>1 服务端</h2><h3>1.1 实现MyService</h3><p>可分别重写</p><ol><li><code>OnConnected</code> 有客户端连接上的事件</li><li><code>OnDisConnected</code> 客户端断开连接时的事件</li><li><code>OnReceive</code> 收到客户端消息的事件</li><li><code>OnException</code> 发生异常时的事件，如异常断开</li></ol><p></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line">public class MyService : Peach.AbsSocketService&lt;Peach.Messaging.CommandLineMessage&gt;</span><br><span class="line">&#123;</span><br><span class="line">    private readonly ILogger&lt;MyService&gt; _logger;</span><br><span class="line"></span><br><span class="line">    public MyService(ILogger&lt;MyService&gt; logger)</span><br><span class="line">    &#123;</span><br><span class="line">        _logger = logger;</span><br><span class="line">    &#125;</span><br><span class="line">    public override void OnConnected(ISocketContext&lt;CommandLineMessage&gt; context)</span><br><span class="line">    &#123;</span><br><span class="line">        _logger.LogInformation(&quot;client connected from &#123;0&#125;&quot;, context.RemoteEndPoint);</span><br><span class="line">        base.OnConnected(context);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public override void OnDisconnected(ISocketContext&lt;CommandLineMessage&gt; context)</span><br><span class="line">    &#123;</span><br><span class="line">        _logger.LogInformation(&quot;client disconnected from &#123;0&#125;&quot;, context.RemoteEndPoint);</span><br><span class="line">        base.OnDisconnected(context);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public override void OnException(ISocketContext&lt;CommandLineMessage&gt; context, Exception ex)</span><br><span class="line">    &#123;</span><br><span class="line">        _logger.LogError(ex,&quot;client from &#123;0&#125;, occ error &#123;1&#125;&quot;, context.RemoteEndPoint,ex.Message);</span><br><span class="line">        base.OnException(context, ex);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public override void OnReceive(ISocketContext&lt;CommandLineMessage&gt; context, CommandLineMessage msg)</span><br><span class="line">    &#123;</span><br><span class="line">        string replyMessage = string.Empty;</span><br><span class="line">        string replyCmd = string.Empty;</span><br><span class="line">        switch (msg.Command)</span><br><span class="line">        &#123;</span><br><span class="line">            case &quot;echo&quot;:</span><br><span class="line">                replyMessage = msg.Parameters[0];</span><br><span class="line">                replyCmd = &quot;echo&quot;;</span><br><span class="line">                break;</span><br><span class="line">            case &quot;init&quot;:</span><br><span class="line">                replyMessage = &quot;ok&quot;;</span><br><span class="line">                replyCmd = &quot;init_reply&quot;;</span><br><span class="line"></span><br><span class="line">                break;</span><br><span class="line">            default:</span><br><span class="line">                replyMessage = &quot;error unknow command&quot;;</span><br><span class="line">                break;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        Task.Run(async () =&gt;</span><br><span class="line">        &#123;</span><br><span class="line">            await context.SendAsync(new CommandLineMessage(replyCmd, replyMessage));</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><h3>2. 挂载服务</h3><p>服务默认挂载在5566端口</p><p></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">static void Main(string[] args)</span><br><span class="line">&#123;</span><br><span class="line">    var builder = new HostBuilder()          </span><br><span class="line">    .ConfigureServices((context,services) =&gt;</span><br><span class="line">    &#123;</span><br><span class="line">        //协议</span><br><span class="line">        services.AddSingleton&lt;IProtocol&lt;CommandLineMessage&gt;, CommandLineProtocol&gt;();</span><br><span class="line">        //挂载服务逻辑</span><br><span class="line">        services.AddSingleton&lt;ISocketService&lt;CommandLineMessage&gt;, MyService&gt;();</span><br><span class="line">        //添加挂载的宿主服务</span><br><span class="line">        services.AddTcpServer&lt;CommandLineMessage&gt;();</span><br><span class="line">    &#125;)</span><br><span class="line">    .ConfigureLogging(</span><br><span class="line">        logger =&gt;</span><br><span class="line">        &#123;                   </span><br><span class="line">            logger.AddConsole();</span><br><span class="line">        &#125;</span><br><span class="line">    );</span><br><span class="line">    builder.RunConsoleAsync().Wait();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><h2>2. 客户端</h2><h3>2.1 使用内置的TcpClient</h3><p>监听接收消息和链接的消息，如下所示：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">TcpClient&lt;CommandLineMessage&gt; client = new TcpClient&lt;CommandLineMessage&gt;(new CommandLineProtocol());</span><br><span class="line">client.OnReceived += Client_OnReceived;</span><br><span class="line">client.OnConnected += Client_OnConnected;</span><br><span class="line"></span><br><span class="line">Task.Run(async () =&gt;</span><br><span class="line">&#123;</span><br><span class="line">    //连接服务器</span><br><span class="line">    var socketContext = await client.ConnectAsync(new IPEndPoint(Hey.IPUtility.GetLocalIntranetIP(), 5566));</span><br><span class="line">    //发送消息</span><br><span class="line">    var initCmd = new Hey.Messaging.CommandLineMessage(&quot;init&quot;);</span><br><span class="line">    await socketContext.SendAsync(initCmd);</span><br><span class="line">&#125;).Wait();</span><br></pre></td></tr></table></figure><p></p><p>可用的事件:</p><ul><li><code>OnReceived</code> 当收到服务端消息时</li><li><code>OnError</code> 当通讯发生异常时</li><li><code>OnConnected</code> 当连接上服务器时</li><li><code>OnDisconnected</code> 当与服务端断开链接时</li><li><code>OnIdleState</code> 链接闲置时触发，一般在此事件中发送心跳包</li></ul><h2>3. 自定义协议</h2><p>Peach支持使用自定义协议，扩展协议需要自行实现两个接口:</p><h3>3.1. IMessage 接口</h3><p>实现类具体实现通讯消息的内容载体，只需实现如何获取消息长度的属性</p><p></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">public interface IMessage</span><br><span class="line">&#123;</span><br><span class="line">    int Length &#123; get;  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><h3>3.2. IProtocol 接口</h3><p>实现类需要描述消息头信息和具体打包解包逻辑，头信息描述参见<code>ProtocolMeta</code>字段描述</p><p></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">/// &lt;summary&gt;</span><br><span class="line">/// 协议接口</span><br><span class="line">/// &lt;/summary&gt;</span><br><span class="line">/// &lt;typeparam name=&quot;TMessage&quot;&gt;&lt;/typeparam&gt;</span><br><span class="line">public interface IProtocol&lt;TMessage&gt;</span><br><span class="line">    where TMessage :  Messaging.IMessage</span><br><span class="line">&#123;</span><br><span class="line">    ProtocolMeta GetProtocolMeta();</span><br><span class="line"></span><br><span class="line">    TMessage Parse(Buffer.IBufferReader reader);</span><br><span class="line"></span><br><span class="line">    void Pack(Buffer.IBufferWriter writer, TMessage message);</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><h3>3.3 Amp协议</h3><p>为了更好让读者理解自定义协议的操作，这里以DotBPE中的Amp协议为例，来具体讲解一下，先来看下Amp协议的说明:</p><p></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">      0        1 2 3 4   5 6 7 8     9     10 11 12 13   1415      16171819    20    &lt;length&gt;-21</span><br><span class="line">+------------+----------+---------+------+-------------+---------+---------+--------+------------+</span><br><span class="line">| &lt;ver/argc&gt; | &lt;length&gt; |  &lt;seq&gt;  |&lt;type&gt;| &lt;serviceId&gt; | &lt;msgId&gt; |  &lt;code&gt; | &lt;codec&gt;|   &lt;data&gt;   |</span><br><span class="line">+------------+----------+---------+------+-------------+---------+---------+--------+------------+</span><br></pre></td></tr></table></figure><p></p><p>Amp协议固定包头上21个字节，说明如下：</p><ul><li>ver/argc = 版本 固定填1</li><li>length = 为总包长</li><li>seq = 请求序列号</li><li>type = 消息类型<ul><li>1 = Request 请求消息</li><li>2 = Response 响应消息</li><li>3 = Notify 通知消息</li><li>4 = OneWayRequest 调用不关心返回值</li></ul></li><li>serId = serviceId 服务号</li><li>msgId = msgId 消息ID</li><li>code = 当 type = 0 （请求时）固定传0 ，其他即为响应码，如果响应码不为0 则认为请求失败，具体错误码再定义</li><li>codecType = 编码方式 0=默认 Protobuf 1=MessagePack 2=JSON</li><li>data = 实际的业务数据</li></ul><h3>3.3.1 AmpMessage实现</h3><p>为了避免干扰因素，这里的代码去除了一些，辅助行的字段和方法，AmpMessage其实是主要用于描述头信息的，并且包含body的buffer数据 <code>Data</code>字段，并实现获取消息体Length的方法（用于发送消息时，计算缓冲区）</p><p></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line">public class AmpMessage :  Peach.Messaging.IMessage</span><br><span class="line">   &#123;</span><br><span class="line">      /// &lt;summary&gt;</span><br><span class="line">       /// 第一个版本为18个字节头固定长度</span><br><span class="line">       /// &lt;/summary&gt;</span><br><span class="line">       public const int VERSION_0_HEAD_LENGTH = 18;</span><br><span class="line">       /// &lt;summary&gt;</span><br><span class="line">       /// 现有版本21个字节头固定长度</span><br><span class="line">       /// &lt;/summary&gt;</span><br><span class="line">       public const int VERSION_1_HEAD_LENGTH = 21;</span><br><span class="line">       /// &lt;summary&gt;</span><br><span class="line">       /// 状态码</span><br><span class="line">       /// &lt;/summary&gt;</span><br><span class="line">       public int Code &#123; get; set; &#125;</span><br><span class="line"></span><br><span class="line">       //0 默认为Protobuf 1 MessagePack 2 = JSON</span><br><span class="line">       public CodecType CodecType &#123; get; set; &#125;</span><br><span class="line"></span><br><span class="line">       /// &lt;summary&gt;</span><br><span class="line">       /// 实际的请求数据</span><br><span class="line">       /// &lt;/summary&gt;</span><br><span class="line">       public byte[] Data &#123; get; set; &#125;</span><br><span class="line"></span><br><span class="line">       public int Length &#123;</span><br><span class="line">           get</span><br><span class="line">           &#123;</span><br><span class="line">               var hl = Version == 0 ? VERSION_0_HEAD_LENGTH : VERSION_1_HEAD_LENGTH;</span><br><span class="line">               if(Data == null)</span><br><span class="line">               &#123;</span><br><span class="line">                   return hl;</span><br><span class="line">               &#125;</span><br><span class="line"></span><br><span class="line">               return hl + this.Data.Length;</span><br><span class="line">           &#125;</span><br><span class="line">       &#125;</span><br><span class="line">       </span><br><span class="line">       /// &lt;summary&gt;</span><br><span class="line">       /// 消息标识</span><br><span class="line">       /// &lt;/summary&gt;</span><br><span class="line">       public string Id =&gt; $&quot;&#123;ServiceId&#125;|&#123;MessageId&#125;|&#123;Sequence&#125;&quot;;</span><br><span class="line">       /// &lt;summary&gt;</span><br><span class="line">       /// 调用服务的唯一消息号 确定哪个方法</span><br><span class="line">       /// &lt;/summary&gt;</span><br><span class="line">       public ushort MessageId &#123; get; set; &#125;</span><br><span class="line">       /// &lt;summary&gt;</span><br><span class="line">       /// 请求的序列号</span><br><span class="line">       /// &lt;/summary&gt;</span><br><span class="line">       public int Sequence &#123; get; set; &#125;</span><br><span class="line">       /// &lt;summary&gt;</span><br><span class="line">       /// 调用服务的唯一服务号 确定哪个服务</span><br><span class="line">       /// &lt;/summary&gt;</span><br><span class="line">       public int ServiceId &#123; get; set; &#125;</span><br><span class="line"></span><br><span class="line">       /// &lt;summary&gt;</span><br><span class="line">       /// 协议版本0/1</span><br><span class="line">       /// &lt;/summary&gt;</span><br><span class="line">       public byte Version &#123; get; set; &#125;</span><br><span class="line"></span><br><span class="line">       public InvokeMessageType InvokeMessageType &#123; get; set; &#125;</span><br><span class="line">   &#125;</span><br><span class="line">   </span><br><span class="line">   public enum InvokeMessageType : byte</span><br><span class="line">   &#123;</span><br><span class="line">       Request = 1,</span><br><span class="line">       Response = 2,</span><br><span class="line">       Notify = 3,</span><br><span class="line">       OnewayRequest=4 //请求且不等待回复</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure><p></p><h3>3.3.2 AmpProtocol的实现</h3><p>AmpProtocol中的实现主要是对ProtocolMeta描述，代码中已有详细注释，至于打包和解包，就是根据协议Write或者Read对应的数据类型即可</p><p></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br></pre></td><td class="code"><pre><span class="line">/// &lt;summary&gt;</span><br><span class="line">    /// Amp Protocol</span><br><span class="line">    /// &lt;/summary&gt;</span><br><span class="line">    public class AmpProtocol : IProtocol&lt;AmpMessage&gt;</span><br><span class="line">    &#123;</span><br><span class="line">        private readonly ISerializer _serializer;</span><br><span class="line"></span><br><span class="line">        public AmpProtocol(ISerializer serializer)</span><br><span class="line">        &#123;</span><br><span class="line">            this._serializer = serializer;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        static readonly ProtocolMeta AMP_PROTOCOL_META = new ProtocolMeta</span><br><span class="line">        &#123;</span><br><span class="line">            InitialBytesToStrip = 0, //读取时需要跳过的字节数</span><br><span class="line">            LengthAdjustment = -5, //包实际长度的纠正，如果包长包括包头和包体，则要减去Length之前的部分</span><br><span class="line">            LengthFieldLength = 4, //长度字段的字节数 整型为4个字节</span><br><span class="line">            LengthFieldOffset = 1, //长度属性的起始（偏移）位</span><br><span class="line">            MaxFrameLength = int.MaxValue, //最大的数据包字节数</span><br><span class="line">            HeartbeatInterval = 30 * 1000 // 30秒没消息发一个心跳包</span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">        public ProtocolMeta GetProtocolMeta()</span><br><span class="line">        &#123;</span><br><span class="line">            return AMP_PROTOCOL_META;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        public void Pack(IBufferWriter writer, AmpMessage message)</span><br><span class="line">        &#123;</span><br><span class="line">            writer.WriteByte(message.Version);</span><br><span class="line">            writer.WriteInt(message.Length);</span><br><span class="line">            writer.WriteInt(message.Sequence);</span><br><span class="line">            writer.WriteByte((byte)message.InvokeMessageType);</span><br><span class="line"></span><br><span class="line">            if (message.Version == 0)</span><br><span class="line">            &#123;</span><br><span class="line">                writer.WriteUShort((ushort)message.ServiceId);</span><br><span class="line">            &#125;</span><br><span class="line">            else</span><br><span class="line">            &#123;</span><br><span class="line">                writer.WriteInt(message.ServiceId);</span><br><span class="line">            &#125;</span><br><span class="line">            writer.WriteUShort(message.MessageId);</span><br><span class="line">            writer.WriteInt(message.Code);</span><br><span class="line">            if(message.Version == 1)</span><br><span class="line">            &#123;</span><br><span class="line">                writer.WriteByte(_serializer.CodecType);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            if (message.Data != null)</span><br><span class="line">            &#123;</span><br><span class="line">                writer.WriteBytes(message.Data);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        public AmpMessage Parse(IBufferReader reader)</span><br><span class="line">        &#123;</span><br><span class="line">            if (reader.ReadableBytes == 0)</span><br><span class="line">            &#123;</span><br><span class="line">                return null;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            var msg = new AmpMessage &#123;Version = reader.ReadByte()&#125;;</span><br><span class="line"></span><br><span class="line">            int headLength;</span><br><span class="line">            if (msg.Version == 0 )</span><br><span class="line">            &#123;</span><br><span class="line">                headLength = AmpMessage.VERSION_0_HEAD_LENGTH;</span><br><span class="line">                if (reader.ReadableBytes &lt; AmpMessage.VERSION_0_HEAD_LENGTH - 1)</span><br><span class="line">                &#123;</span><br><span class="line">                    throw new RpcCodecException($&quot;decode error ,ReadableBytes=&#123;reader.ReadableBytes+1&#125;,HEAD_LENGTH=&#123;AmpMessage.VERSION_0_HEAD_LENGTH&#125;&quot;);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            else if (msg.Version == 1 )</span><br><span class="line">            &#123;</span><br><span class="line">                headLength = AmpMessage.VERSION_1_HEAD_LENGTH;</span><br><span class="line">                if (reader.ReadableBytes &lt; AmpMessage.VERSION_1_HEAD_LENGTH - 1)</span><br><span class="line">                &#123;</span><br><span class="line">                    throw new RpcCodecException($&quot;decode error ,ReadableBytes=&#123;reader.ReadableBytes+1&#125;,HEAD_LENGTH=&#123;AmpMessage.VERSION_1_HEAD_LENGTH&#125;&quot;);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            else</span><br><span class="line">            &#123;</span><br><span class="line">                throw new RpcCodecException($&quot;decode error ,&#123;msg.Version&#125; is not support&quot;);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            var length = reader.ReadInt();</span><br><span class="line">            msg.Sequence = reader.ReadInt();</span><br><span class="line">            var type = reader.ReadByte();</span><br><span class="line">            msg.InvokeMessageType = (InvokeMessageType)Enum.ToObject(typeof(InvokeMessageType), type);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">            msg.ServiceId = msg.Version == 0 ? reader.ReadUShort() : reader.ReadInt();</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">            msg.MessageId = reader.ReadUShort();</span><br><span class="line">            msg.Code = reader.ReadInt();</span><br><span class="line"></span><br><span class="line">            if (msg.Version == 1)</span><br><span class="line">            &#123;</span><br><span class="line">                byte codeType = reader.ReadByte();</span><br><span class="line">                if (codeType != this._serializer.CodecType)</span><br><span class="line">                &#123;</span><br><span class="line">                    throw  new RpcCodecException($&quot;CodecType:&#123;codeType&#125; is not Match &#123;this._serializer.CodecType&#125;&quot;);</span><br><span class="line">                &#125;</span><br><span class="line">                msg.CodecType = (CodecType)Enum.ToObject(typeof(CodecType), codeType);</span><br><span class="line">            &#125;</span><br><span class="line">            else</span><br><span class="line">            &#123;</span><br><span class="line">                msg.CodecType = CodecType.Protobuf;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            int left = length - headLength;</span><br><span class="line">            if (left &gt; 0)</span><br><span class="line">            &#123;</span><br><span class="line">                if (left &gt; reader.ReadableBytes)</span><br><span class="line">                &#123;</span><br><span class="line">                    throw new RpcCodecException(&quot;message not long enough!&quot;);</span><br><span class="line">                &#125;</span><br><span class="line">                msg.Data = new byte[left];</span><br><span class="line">                reader.ReadBytes(msg.Data);</span><br><span class="line">            &#125;</span><br><span class="line">            return msg;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><h2>4. 后记</h2><p>Peach的产生主要是源于对DotBPE的重构，因为在其他项目中有关于通讯的其他需求，所以这块虽然比较简单，也可比较独立，所以单独开了一个库来实现对DotNetty的封装。另外欢迎各位dotnet core的同学一起学习交流 QQ群号：699044833</p></div><footer class="post-footer"><div class="post-eof"></div></footer></div></article><article class="post post-type-normal" itemscope itemtype="http://schema.org/Article"><div class="post-block"><link itemprop="mainEntityOfPage" href="https://xuanye.github.io/xxl-job-executor-dotnet-port/"><span hidden itemprop="author" itemscope itemtype="http://schema.org/Person"><meta itemprop="name" content="Xuanye"><meta itemprop="description" content><meta itemprop="image" content="/uploads/avatar.png"></span><span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content="假正经哥哥"></span><header class="post-header"><h2 class="post-title" itemprop="name headline"><a class="post-title-link" href="/xxl-job-executor-dotnet-port/" itemprop="url">xxl-job dotnet core executor执行器开源</a></h2><div class="post-meta"><span class="post-time"><span class="post-meta-item-icon"><i class="fa fa-calendar-o"></i> </span><span class="post-meta-item-text">Posted on</span> <time title="Post created" itemprop="dateCreated datePublished" datetime="2019-01-19T18:00:00+08:00">2019-01-19</time> </span><span class="post-category"><span class="post-meta-divider">|</span> <span class="post-meta-item-icon"><i class="fa fa-folder-o"></i> </span><span class="post-meta-item-text">In</span> <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/原创/" itemprop="url" rel="index"><span itemprop="name">原创</span></a></span></span></div></header><div class="post-body" itemprop="articleBody"><h1>DotXxlJob</h1><p>[(github)https://github.com/xuanye/DotXxlJob][https://github.com/xuanye/DotXxlJob] xxl-job的dotnet core 执行器实现，支持XXL-JOB 2.0+</p><h2>1 XXL-JOB概述</h2><p>[XXL-JOB][1]是一个轻量级分布式任务调度平台，其核心设计目标是开发迅速、学习简单、轻量级、易扩展。现已开放源代码并接入多家公司线上产品线，开箱即用。以下是它的架构图 <img src="https://raw.githubusercontent.com/xuxueli/xxl-job/master/doc/images/img_Qohm.png" alt="架构图"></p><h2>2. 关于DotXxlJob产生</h2><p>在工作中调研过多个任务调度平台，如Hangfire、基于Quatz.NET的第三方扩展，都与实际的需求有一点差距。 之前一直使用Hangfire，Hangfire的执行器在同步调用业务服务时，如果即时业务服务正在重新部署或者重启，有一定概率会出现死锁，导致CPU100%，后来全部调整为异步，但是这样就无法获得执行结果，这样的设计有蛮大问题，XxlJob的回调机制很好的解决了这个问题。本身如果通过http的方式调用，只要部署springbootd的一个执行器就可以解决问题，但是扩展性较差。所以萌生了实现DotNet版本的执行器的想法，为避免重复造轮子，开始之前也进行过调研，以下仓库[https://github.com/yuniansheng/xxl-job-dotnet][2]给了较大的启发，但是该库只支持1.9版本的xxljob，还有一些其他小问题，所以还是自力更生。</p><h2>3. 如何使用</h2><p>目前只实现了BEAN的方式，即直接实现IJobHandler调用的方式，Glue源码的方式实际上实现起来也并不复杂（有需求再说把），或者各位有需求Fork 实现一下</p><p>可参考sample</p><p>安装:</p><blockquote><p>dotnet add package DotXxlJob.Core</p></blockquote><h3>3.1 在AspNetCore中使用</h3><ol><li>生命一个AspNet的Middleware中间件,并扩展ApplicationBuilder，本质是拦截Post请求，解析Body中的流信息</li></ol><p></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">public class XxlJobExecutorMiddleware</span><br><span class="line">&#123;</span><br><span class="line">    private readonly IServiceProvider _provider;</span><br><span class="line">    private readonly RequestDelegate _next;</span><br><span class="line"></span><br><span class="line">    private readonly XxlRpcServiceHandler _rpcService;</span><br><span class="line">    public XxlJobExecutorMiddleware(IServiceProvider provider, RequestDelegate next)</span><br><span class="line">    &#123;</span><br><span class="line">        this._provider = provider;</span><br><span class="line">        this._next = next;</span><br><span class="line">        this._rpcService = _provider.GetRequiredService&lt;XxlRpcServiceHandler&gt;();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public async Task Invoke(HttpContext context)</span><br><span class="line">    &#123;</span><br><span class="line"></span><br><span class="line">        if (&quot;POST&quot;.Equals(context.Request.Method, StringComparison.OrdinalIgnoreCase) &amp;&amp; </span><br><span class="line">            &quot;application/octet-stream&quot;.Equals(context.Request.ContentType, StringComparison.OrdinalIgnoreCase))</span><br><span class="line">        &#123;</span><br><span class="line">            var rsp =  await _rpcService.HandlerAsync(context.Request.Body);</span><br><span class="line">            context.Response.StatusCode = (int) HttpStatusCode.OK;</span><br><span class="line">            context.Response.ContentType = &quot;text/plain;utf-8&quot;;</span><br><span class="line">            await context.Response.Body.WriteAsync(rsp,0,rsp.Length);</span><br><span class="line">            return;</span><br><span class="line">        &#125;</span><br><span class="line">        await _next.Invoke(context);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><p>扩展ApplicationBuilderExtensions,可根据实际情况绑定在特殊的Url Path上</p><p></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">public static class ApplicationBuilderExtensions</span><br><span class="line">&#123;</span><br><span class="line">    public static IApplicationBuilder UseXxlJobExecutor(this IApplicationBuilder @this)</span><br><span class="line">    &#123;</span><br><span class="line">       return @this.UseMiddleware&lt;XxlJobExecutorMiddleware&gt;();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><p>在Startup中添加必要的引用,其中自动注册。</p><p></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">public class Startup</span><br><span class="line">&#123;</span><br><span class="line">    public Startup(IConfiguration configuration)</span><br><span class="line">    &#123;</span><br><span class="line">        Configuration = configuration;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    private IConfiguration Configuration &#123; get; &#125;</span><br><span class="line">    </span><br><span class="line">    public void ConfigureServices(IServiceCollection services)</span><br><span class="line">    &#123;</span><br><span class="line">      </span><br><span class="line">        services.AddXxlJobExecutor(Configuration);</span><br><span class="line">        services.AddSingleton&lt;IJobHandler, DemoJobHandler&gt;(); // 添加自定义的jobHandler</span><br><span class="line">        services.AddAutoRegistry(); // 自动注册</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    public void Configure(IApplicationBuilder app,IHostingEnvironment env)</span><br><span class="line">    &#123;</span><br><span class="line">        //启用XxlExecutor</span><br><span class="line">        app.UseXxlJobExecutor();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><p>编写JobHandler,继承AbstractJobHandler或者直接实现接口IJobHandler，通过context.JobLogger 记录执行过程和结果，在AdminWeb上可查看的哦</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">[JobHandler(&quot;demoJobHandler&quot;)]</span><br><span class="line">public class DemoJobHandler:AbstractJobHandler</span><br><span class="line">&#123;</span><br><span class="line">    public override Task&lt;ReturnT&gt; Execute(JobExecuteContext context)</span><br><span class="line">    &#123;</span><br><span class="line">        context.JobLogger.Log(&quot;receive demo job handler,parameter:&#123;0&#125;&quot;,context.JobParameter);</span><br><span class="line"></span><br><span class="line">        return Task.FromResult(ReturnT.SUCCESS);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><h2>3.2 配置信息</h2><p>管理端地址和端口是必填信息，其他根据实际情况，选择配置，配置项说明见下代码中的注释</p><p></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"> public class XxlJobExecutorOptions</span><br><span class="line">&#123;</span><br><span class="line">   </span><br><span class="line">    /// &lt;summary&gt;</span><br><span class="line">    /// 管理端地址，多个以;分隔</span><br><span class="line">    /// &lt;/summary&gt;</span><br><span class="line">    public string AdminAddresses &#123; get; set; &#125;</span><br><span class="line">    /// &lt;summary&gt;</span><br><span class="line">    /// appName自动注册时要去管理端配置一致</span><br><span class="line">    /// &lt;/summary&gt;</span><br><span class="line">    public string AppName &#123; get; set; &#125; = &quot;xxl-job-executor-dotnet&quot;;</span><br><span class="line">    /// &lt;summary&gt;</span><br><span class="line">    /// 自动注册时提交的地址，为空会自动获取内网地址</span><br><span class="line">    /// &lt;/summary&gt;</span><br><span class="line">    public string SpecialBindAddress &#123; get; set; &#125;</span><br><span class="line">    /// &lt;summary&gt;</span><br><span class="line">    /// 绑定端口</span><br><span class="line">    /// &lt;/summary&gt;</span><br><span class="line">    public int Port &#123; get; set; &#125;</span><br><span class="line">    /// &lt;summary&gt;</span><br><span class="line">    /// 是否自动注册</span><br><span class="line">    /// &lt;/summary&gt;</span><br><span class="line">    public bool AutoRegistry &#123; get; set; &#125;</span><br><span class="line">    /// &lt;summary&gt;</span><br><span class="line">    /// 认证票据</span><br><span class="line">    /// &lt;/summary&gt;</span><br><span class="line">    public string AccessToken &#123; get; set; &#125;</span><br><span class="line">    /// &lt;summary&gt;</span><br><span class="line">    /// 日志目录，默认为执行目录的logs子目录下，请配置绝对路径</span><br><span class="line">    /// &lt;/summary&gt;</span><br><span class="line">    public string LogPath &#123; get; set; &#125; = Path.Combine(AppContext.BaseDirectory, &quot;./logs&quot;);</span><br><span class="line">    /// &lt;summary&gt;</span><br><span class="line">    /// 日志保留天数</span><br><span class="line">    /// &lt;/summary&gt;</span><br><span class="line">    public int LogRetentionDays &#123; get; set; &#125; = 30;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><h2>在其他Http服务中使用</h2><p>只需要实现Http请求的拦截，并判断post请求中content-Type=&quot;application/octet-stream&quot;,并使用XxlRpcServiceHandler来处理流 即可。</p><h2>其他说明</h2><p>XXL-JOB内置的RPC是使用Hessian协议，这个有点坑。很多都是java特有的属性和标识，比如类名什么的。在本项目中，并没有实现完整的Hessian2协议，只实现了使用到的类型，当然扩展起来也非常方便。如果有人要单独使用Hessian 这个类库的话，要特别注意这个问题。</p><p>有任何问题，可Issue反馈 ,最后感谢 xxl-job</p></div><footer class="post-footer"><div class="post-eof"></div></footer></div></article><article class="post post-type-normal" itemscope itemtype="http://schema.org/Article"><div class="post-block"><link itemprop="mainEntityOfPage" href="https://xuanye.github.io/service-discovery-and-health-checks-in-aspnet-core-with-consul/"><span hidden itemprop="author" itemscope itemtype="http://schema.org/Person"><meta itemprop="name" content="Xuanye"><meta itemprop="description" content><meta itemprop="image" content="/uploads/avatar.png"></span><span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content="假正经哥哥"></span><header class="post-header"><h2 class="post-title" itemprop="name headline"><a class="post-title-link" href="/service-discovery-and-health-checks-in-aspnet-core-with-consul/" itemprop="url">(译) Service Discovery And Health Checks In ASP.NET Core With Consul</a></h2><div class="post-meta"><span class="post-time"><span class="post-meta-item-icon"><i class="fa fa-calendar-o"></i> </span><span class="post-meta-item-text">Posted on</span> <time title="Post created" itemprop="dateCreated datePublished" datetime="2019-01-05T09:23:00+08:00">2019-01-05</time> </span><span class="post-category"><span class="post-meta-divider">|</span> <span class="post-meta-item-icon"><i class="fa fa-folder-o"></i> </span><span class="post-meta-item-text">In</span> <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/翻译/" itemprop="url" rel="index"><span itemprop="name">翻译</span></a></span></span></div></header><div class="post-body" itemprop="articleBody"><p>在这篇文章中，我们将快速了解一下<code>服务发现</code>是什么，使用<a href="https://consul.io/" target="_blank" rel="noopener">Consul</a>在ASP.NET Core MVC框架中，并结合<a href="http://dnsclient.michaco.net/" target="_blank" rel="noopener">DnsClient.NET</a>实现基于Dns的客户端服务发现</p><blockquote><p>这篇文章的所有源代码都可以在GitHub上Demo项目获得.</p></blockquote><h2>Service Discovery</h2><p>在现代微服务架构中，服务可以在容器中运行，并且可以动态启动，停止和扩展。 这导致了一个非常动态的托管环境，可能有数百个实际端点，无法手动配置或找到正确的端点。</p><p>话虽这么说，我相信服务发现不仅适用于生活在容器中的粒状微服务。它可以被任何必须访问其他资源的应用程序使用。资源可以是数据库，其他Web服务，也可以是托管在其他地方的网站的一部分。服务发现有助于摆脱特定于环境的配置文件！</p><p>服务发现可用于解决此问题，但通常，有许多不同的方法来实现它</p><ul><li>客户端服务发现 一种解决方案是拥有一个中央服务注册表，其中所有服务实例都在这里注册。客户端必须实现逻辑以查询他们需要的服务，最终验证端点是否仍然存活并且可能将请求分发到多个端点。</li><li>服务器端/负载平衡 所有流量都通过负载均衡器，负载均衡器知道所有实际的，动态变化的端点，并相应地重定向所有请求</li></ul><p>Consul是一个服务注册表，可用于实现客户端服务发现。</p><p>除了使用这种方法的许多强大功能和优点之外，它的缺点是每个客户端应用程序都需要实现一些逻辑来使用此中央注册表。这个逻辑可能非常具体，因为Consul和任何其他技术都有自定义API和逻辑工作方式。</p><p>负载平衡也可能无法自动完成。客户端可以查询服务的所有可用/已注册端点，然后决定选择哪个端点。 好的是Consul不仅带有REST API来查询服务注册表，它还提供DNS端点，返回标准SRV和TXT记录。</p><p>DNS端点确实关心服务运行状况，因为它不会返回不健康的服务实例。它还通过以交替顺序返回记录来进行负载平衡！ 此外，它可能使服务具有更高的优先级，更接近客户端。</p><p>现在，让我们开始......</p><p>&lt;!--more--&gt;</p><h2>Consul 安装</h2><p><a href="https://consul.io/" target="_blank" rel="noopener">Consul</a>是由HashiCorp开发的软件，它不仅提供服务发现（如上所述），还提供“健康检查”，并提供分布式“密钥值存储”。</p><p>Consul旨在一个集群中运行，至少有三个实例处理集群环境中每个节点上的集群和“代理”的协调。应用程序始终只与本地代理通信，这使得通信速度非常快，并将网络延迟降至最低。</p><p>但是，对于本地开发，您可以在--dev模式下运行Consul，而不是设置完整集群。 但是请记住这一点，为了生产使用，需要做一些工作才能正确设置Consul。</p><h3>下载和运行Consul</h3><p><a href="https://www.consul.io/intro/getting-started/install.html" target="_blank" rel="noopener">官方文档</a>有很多例子，并且很好地解释了如何设置Consul。我不会详细介绍，我们只是将它作为本地开发代理运行。</p><p>要开始使用，请<a href="https://www.consul.io/downloads.html" target="_blank" rel="noopener">下载Consul</a></p><p>使用<code>consul agent --dev</code>命令和参数来运行启动Consul，这将在本地服务模式下启动Consul而无需配置文件，并且只能在localhost上访问。 访问http://localhost:8500 ,这应该可以打开Consul UI</p><p><img src="http://ww1.sinaimg.cn/mw690/697065c1gy1fyvgzhr3a7j20py0migly.jpg" alt="Consul UI"></p><h2>注册第一个服务</h2><p>Consul提供了添加或修改服务注册表的不同方法。一种选择是将JSON配置文件放入Consul的config目录中。下面的例子将注册一个Redis服务：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&#123; </span><br><span class="line">    &quot;service&quot;:&#123;</span><br><span class="line">        &quot;name&quot;: &quot;redis&quot;,</span><br><span class="line">        &quot;tags&quot;:[],</span><br><span class="line">        &quot;port&quot;: 6379</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><p>另一个更有趣的选择是通过REST API。幸运的是，已有许多语言的客户端库可用于此REST API，我们将使用<a href="https://github.com/PlayFab/consuldotnet" target="_blank" rel="noopener">https://github.com/PlayFab/consuldotnet</a>，.Net Core也可以使用</p><p>要通过代码注册新服务，请创建一个新的ConsulClient实例并注册新的服务注册</p><p></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">var client = new ConsulClient(); // uses default host:port which is localhost:8500</span><br><span class="line"></span><br><span class="line">var agentReg = new AgentServiceRegistration()</span><br><span class="line">&#123;</span><br><span class="line">    Address = &quot;127.0.0.1&quot;,</span><br><span class="line">    ID = &quot;uniqueid&quot;,</span><br><span class="line">    Name = &quot;serviceName&quot;,</span><br><span class="line">    Port = 5200</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">await client.Agent.ServiceRegister(agentReg);</span><br></pre></td></tr></table></figure><p></p><p>重要的是要注意，即使服务不再运行，该注册理论上也将永远存在于Consul集群中。</p><p></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">await client.Agent.ServiceDeregister(&quot;uniqueid&quot;);</span><br></pre></td></tr></table></figure><p></p><p>如果服务崩溃，则可能无法始终手动取消注册服务。这就是Consul的另一个特色：健康检查。</p><h2>健康检查 Health Checks</h2><p>Consul中的监控检查可用于监视群集中的所有服务的状态，还可以从Consul注册表中自动删除不健康的服务端点注册。可以将Consul配置为根据需要定期为每个注册服务运行尽可能多的运行状况检查。</p><p>最基本的健康检查让Consul尝试通过TCP连接到服务：</p><p></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">var tcpCheck = new AgentServiceCheck()</span><br><span class="line">&#123;</span><br><span class="line">    DeregisterCriticalServiceAfter = TimeSpan.FromMinutes(1),</span><br><span class="line">    Interval = TimeSpan.FromSeconds(30),</span><br><span class="line">    TCP = $&quot;127.0.0.1:&#123;port&#125;&quot;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p></p><p>Consul还可以检查HTTP端点。在这种情况下，只要端点返回HTTP状态代码200，服务就是健康的。 一个非常简单的健康检查控制器可以像这样实现：</p><p></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">[Route(&quot;[Controller]&quot;)]</span><br><span class="line">public class HealthCheckController : Controller</span><br><span class="line">&#123;</span><br><span class="line">    [HttpGet(&quot;&quot;)]</span><br><span class="line">    [HttpHead(&quot;&quot;)]</span><br><span class="line">    public IActionResult Ping()</span><br><span class="line">    &#123;</span><br><span class="line">        return Ok();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><p>在这次注册中，我们现在必须通过指定AgentServiceCheck的<code>Http</code>属性而不是<code>Tcp</code>属性来将Consul指向该节点：</p><p></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">var httpCheck = new AgentServiceCheck()</span><br><span class="line">&#123;</span><br><span class="line">    DeregisterCriticalServiceAfter = TimeSpan.FromMinutes(1),</span><br><span class="line">    Interval = TimeSpan.FromSeconds(30),</span><br><span class="line">    HTTP = $&quot;http://127.0.0.1:&#123;port&#125;/HealthCheck&quot;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p></p><p>更新之前注册代码，添加让Consul每30秒运行一次健康检查的部分。请注意，我还将检查配置为自动取消注册服务实例，以防它被标记为运行状况超过一分钟。</p><p></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">var registration = new AgentServiceRegistration()</span><br><span class="line">&#123;</span><br><span class="line">    Checks = new[] &#123; tcpCheck, httpCheck &#125;,</span><br><span class="line">    Address = &quot;127.0.0.1&quot;,</span><br><span class="line">    ID = id,</span><br><span class="line">    Name = name,</span><br><span class="line">    Port = port</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">await client.Agent.ServiceRegister(registration);</span><br></pre></td></tr></table></figure><p></p><p>这些基本示例应该足以开始。但是，运行健康检查可以执行更复杂的操作，Consul支持运行小脚本来验证响应。</p><h2>Endpoint Name, ID and Port</h2><p>您可能已经注意到，要注册服务，我们必须知道服务运行的实际端点(<code>Endpoint</code>)，我们必须给它一个<code>Name</code>和一个<code>ID</code>。</p><p><code>ID</code>应该是足够唯一的字符串来标识服务实例，而<code>Name</code>应该是同一服务的所有实例的通用名称。</p><p>其他客户端将使用Name来查询服务注册表，该ID仅用于引用确切的实例，例如取消注册服务实例时。 但是我们如何定义名称和端口以及IP地址？</p><p>如果我们自己使用Kestrel托管ASP.NET Core应用程序很简单，因为我们还在哪个端口和地址上配置Kestrel。当使用IIS（或任何其他反向代理）托管服务时，这种方法会分崩离析，因为在反向代理模式下，Kestrel使用了动态配置，并且实际的托管信息无法在应用程序代码中使用。（译者注:IIS对外的端口和内部Kestrel的端口并不一致）</p><p>要了解如何使用Kestrel托管它，让我们创建一个空的ASP.NET Core web api项目。</p><p>运行<code>dotnet new webapi</code>或在Visual Studio中使用WebAPI模板。</p><p>这将创建一个Program.cs和Startup.cs。 修改<code>Program.cs</code>以创建主机。我们将使用<code>host.Start</code>而不是<code>host.Run</code>，它不会阻塞线程。之后，我们将注册该服务并在服务停止时取消注册：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line">var host = new WebHostBuilder()</span><br><span class="line">    .UseKestrel()</span><br><span class="line">    .UseUrls(&quot;http://localhost:5200&quot;)</span><br><span class="line">    .UseContentRoot(Directory.GetCurrentDirectory())</span><br><span class="line">    .UseStartup&lt;Startup&gt;()</span><br><span class="line">    .Build();</span><br><span class="line"></span><br><span class="line">host.Start();</span><br><span class="line"></span><br><span class="line">var client = new ConsulClient();</span><br><span class="line"></span><br><span class="line">var name = Assembly.GetEntryAssembly().GetName().Name;</span><br><span class="line">var port = 5200;</span><br><span class="line">var id = $&quot;&#123;name&#125;:&#123;port&#125;&quot;;</span><br><span class="line"></span><br><span class="line">var tcpCheck = new AgentServiceCheck()</span><br><span class="line">&#123;</span><br><span class="line">    DeregisterCriticalServiceAfter = TimeSpan.FromMinutes(1),</span><br><span class="line">    Interval = TimeSpan.FromSeconds(30),</span><br><span class="line">    TCP = $&quot;127.0.0.1:&#123;port&#125;&quot;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">var httpCheck = new AgentServiceCheck()</span><br><span class="line">&#123;</span><br><span class="line">    DeregisterCriticalServiceAfter = TimeSpan.FromMinutes(1),</span><br><span class="line">    Interval = TimeSpan.FromSeconds(30),</span><br><span class="line">    HTTP = $&quot;http://127.0.0.1:&#123;port&#125;/HealthCheck&quot;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">var registration = new AgentServiceRegistration()</span><br><span class="line">&#123;</span><br><span class="line">    Checks = new[] &#123; tcpCheck, httpCheck &#125;,</span><br><span class="line">    Address = &quot;127.0.0.1&quot;,</span><br><span class="line">    ID = id,</span><br><span class="line">    Name = name,</span><br><span class="line">    Port = port</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">client.Agent.ServiceRegister(registration).GetAwaiter().GetResult();</span><br><span class="line"></span><br><span class="line">Console.WriteLine(&quot;DataService started...&quot;);</span><br><span class="line">Console.WriteLine(&quot;Press ESC to exit&quot;);</span><br><span class="line"></span><br><span class="line">while (Console.ReadKey().Key != ConsoleKey.Escape)</span><br><span class="line">&#123;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">client.Agent.ServiceDeregister(id).GetAwaiter().GetResult();</span><br></pre></td></tr></table></figure><p></p><p><img src="http://blog.michaco.net/media/aspNetCoreAndConsul/FirstServiceReg.png" alt="此处输入图片的描述"></p><p>并且（如果您已添加运行状况检查控制器），它将成功运行两个运行状况检查：</p><p><img src="http://blog.michaco.net/media/aspNetCoreAndConsul/FirstServiceCheck.png" alt="此处输入图片的描述"></p><p>我使用程序集名称作为服务名称，我正在硬编码端口和IP地址。显然，这需要是可配置的，阻止控制台线程的解决方案也不是很好。</p><h2>更复杂的方式</h2><p>了解基础知识以及注册过程的工作原理，让我们稍微改进一下实现。</p><p><strong>目标</strong>：</p><ul><li>可以通过appsettings.json配置服务名称</li><li>主机和端口不应该是硬编码的</li><li>使用Microsoft.Extensions.Configuration和Options来正确配置我们需要的所有内容</li><li>将注册设置为Startup管道的一部分</li></ul><h3>Configuration</h3><p>我定义了一个新的POCOs的配置文件在<code>appsetting.json</code>文件中，如下所示:</p><p></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">...</span><br><span class="line">  &quot;ServiceDiscovery&quot;: &#123;</span><br><span class="line">    &quot;ServiceName&quot;: &quot;DataService&quot;,</span><br><span class="line">    &quot;Consul&quot;: &#123;</span><br><span class="line">      &quot;HttpEndpoint&quot;: &quot;http://127.0.0.1:8500&quot;,</span><br><span class="line">      &quot;DnsEndpoint&quot;: &#123;</span><br><span class="line">        &quot;Address&quot;: &quot;127.0.0.1&quot;,</span><br><span class="line">        &quot;Port&quot;: 8600</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><p>C#:</p><p></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">public class ServiceDisvoveryOptions</span><br><span class="line">&#123;</span><br><span class="line">    public string ServiceName &#123; get; set; &#125;</span><br><span class="line"></span><br><span class="line">    public ConsulOptions Consul &#123; get; set; &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">public class ConsulOptions</span><br><span class="line">&#123;</span><br><span class="line">    public string HttpEndpoint &#123; get; set; &#125;</span><br><span class="line"></span><br><span class="line">    public DnsEndpoint DnsEndpoint &#123; get; set; &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">public class DnsEndpoint</span><br><span class="line">&#123;</span><br><span class="line">    public string Address &#123; get; set; &#125;</span><br><span class="line"></span><br><span class="line">    public int Port &#123; get; set; &#125;</span><br><span class="line"></span><br><span class="line">    public IPEndPoint ToIPEndPoint()</span><br><span class="line">    &#123;</span><br><span class="line">        return new IPEndPoint(IPAddress.Parse(Address), Port);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><p>然后在Startup.ConfigureServices方法中进行配置：</p><p></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">services.AddOptions();</span><br><span class="line">services.Configure&lt;ServiceDisvoveryOptions&gt;(Configuration.GetSection(&quot;ServiceDiscovery&quot;));</span><br></pre></td></tr></table></figure><p></p><p>使用此配置来设置consul客户端：</p><p></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">services.AddSingleton&lt;IConsulClient&gt;(p =&gt; new ConsulClient(cfg =&gt;</span><br><span class="line">&#123;</span><br><span class="line">    var serviceConfiguration = p.GetRequiredService&lt;IOptions&lt;ServiceDisvoveryOptions&gt;&gt;().Value;</span><br><span class="line"></span><br><span class="line">    if (!string.IsNullOrEmpty(serviceConfiguration.Consul.HttpEndpoint))</span><br><span class="line">    &#123;</span><br><span class="line">        // if not configured, the client will use the default value &quot;127.0.0.1:8500&quot;</span><br><span class="line">        cfg.Address = new Uri(serviceConfiguration.Consul.HttpEndpoint);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;));</span><br></pre></td></tr></table></figure><p></p><p><code>ConsulClient</code>不一定需要配置，如果没有指定，它将使用默认地址（localhost：8500）。</p><h3>动态服务注册</h3><p>只要使用<code>Kestrel</code>在某个端口上托管服务，就可以使用<code>app.Properties[&quot;server.Features&quot;]</code>来确定托管服务的位置。如上所述，如果使用IIS集成或任何其他反向代理，此解决方案将不再起作用，并且必须使用服务可访问的实际端点来在Consul中注册服务，并且在启动期间无法获取该信息。</p><p>如果要将IIS集成与服务发现一起使用，请不要使用以下代码。而是通过配置配置端点，或手动注册服务。</p><p>无论如何，对于Kestrel，我们可以执行以下操作：获取URIs kestrel托管服务（这不适用于像<code>UseUrls(&quot;*:5000&quot;)</code>这样的通配符，然后循环地址以在Consul中注册所有地址：</p><p></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line">ublic void Configure(</span><br><span class="line">        IApplicationBuilder app,</span><br><span class="line">        IApplicationLifetime appLife,</span><br><span class="line">        ILoggerFactory loggerFactory,</span><br><span class="line">        IOptions&lt;ServiceDisvoveryOptions&gt; serviceOptions,</span><br><span class="line">        IConsulClient consul)</span><br><span class="line">    &#123;</span><br><span class="line">        ...</span><br><span class="line"></span><br><span class="line">        var features = app.Properties[&quot;server.Features&quot;] as FeatureCollection;</span><br><span class="line">        var addresses = features.Get&lt;IServerAddressesFeature&gt;()</span><br><span class="line">            .Addresses</span><br><span class="line">            .Select(p =&gt; new Uri(p));</span><br><span class="line"></span><br><span class="line">        foreach (var address in addresses)</span><br><span class="line">        &#123;</span><br><span class="line">            var serviceId = $&quot;&#123;serviceOptions.Value.ServiceName&#125;_&#123;address.Host&#125;:&#123;address.Port&#125;&quot;;</span><br><span class="line"></span><br><span class="line">            var httpCheck = new AgentServiceCheck()</span><br><span class="line">            &#123;</span><br><span class="line">                DeregisterCriticalServiceAfter = TimeSpan.FromMinutes(1),</span><br><span class="line">                Interval = TimeSpan.FromSeconds(30),</span><br><span class="line">                HTTP = new Uri(address, &quot;HealthCheck&quot;).OriginalString</span><br><span class="line">            &#125;;</span><br><span class="line"></span><br><span class="line">            var registration = new AgentServiceRegistration()</span><br><span class="line">            &#123;</span><br><span class="line">                Checks = new[] &#123; httpCheck &#125;,</span><br><span class="line">                Address = address.Host,</span><br><span class="line">                ID = serviceId,</span><br><span class="line">                Name = serviceOptions.Value.ServiceName,</span><br><span class="line">                Port = address.Port</span><br><span class="line">            &#125;;</span><br><span class="line"></span><br><span class="line">            consul.Agent.ServiceRegister(registration).GetAwaiter().GetResult();</span><br><span class="line"></span><br><span class="line">            appLife.ApplicationStopping.Register(() =&gt;</span><br><span class="line">            &#123;</span><br><span class="line">                consul.Agent.ServiceDeregister(serviceId).GetAwaiter().GetResult();</span><br><span class="line">            &#125;);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        ...</span><br></pre></td></tr></table></figure><p></p><p><code>serviceId</code>必须足够独特，以便稍后再次找到该服务的特定实例，以取消注册它。我正在使用主机和端口以及实际的服务名称的连接方式，这应该足够好了。</p><p>这样我们就达到了所有的目标，虽然在启动的时候写了很多的代码，不过我们可以重构一下使用扩展方法来改善。</p><h2>查询服务注册信息</h2><p>新服务正在运行并在Consul中注册，现在应该很容易通过Consul API或DNS找到它。</p><h3>使用Consul客户端查询</h3><p>使用Consul客户端，我们可以使用两种Consul服务</p><ul><li><p>使用Catalog端点，它提供有关服务的原始信息，这个将返回未过滤的结果</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">var consulResult = await _consul.Catalog.Service(_options.Value.ServiceName);</span><br></pre></td></tr></table></figure><p></p></li><li><p>使用Health端点，它将返回已经过滤过的结果</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">var healthResult = await _consul.Health.Service(_options.Value.ServiceName, tag: null, passingOnly: true);</span><br></pre></td></tr></table></figure><p></p></li></ul><p>这里需要注意的重要一点是，这些端点返回的服务列表（如果多个实例正在运行）将始终采用相同的顺序。您必须实现逻辑，以便不会一直调用相同的服务端点，并在所有端点之间传播流量。</p><p>同样，这就是我们可以使用DNS的方式。除了建立负载平衡之外，优点还在于，我们不必再进行另一次昂贵的http调用，并且并且把最终结果缓存一小段时间。使用DNS，我们只需几行代码就可以实现这一切。</p><h3>使用DNS查询</h3><p>让我们用<code>dig</code>命令检查DNS端点，以了解响应的样子：</p><p>要求SRV记录的域名语法是<code>&lt;servicename&gt;.consul.service</code>，这意味着我们可以使用<code>dig @127.0.0.1 -p 8600 dataservice.service.consul SRV</code>查询我们的<code>dataService</code>：</p><p></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"> ; &lt;&lt;&gt;&gt; DiG 9.11.0-P2 &lt;&lt;&gt;&gt; @127.0.0.1 -p 8600 dataservice.service.consul SRV</span><br><span class="line">; (1 server found)</span><br><span class="line">;; global options: +cmd</span><br><span class="line">;; Got answer:</span><br><span class="line">;; -&gt;&gt;HEADER&lt;&lt;- opcode: QUERY, status: NOERROR, id: 25053</span><br><span class="line">;; flags: qr aa rd; QUERY: 1, ANSWER: 1, AUTHORITY: 0, ADDITIONAL: 1</span><br><span class="line">;; WARNING: recursion requested but not available</span><br><span class="line"></span><br><span class="line">;; QUESTION SECTION:</span><br><span class="line">;dataservice.service.consul.    IN      SRV</span><br><span class="line"></span><br><span class="line">;; ANSWER SECTION:</span><br><span class="line">dataservice.service.consul. 0   IN      SRV     1 1 5200 machinename.node.eu-west.consul.</span><br><span class="line"></span><br><span class="line">;; ADDITIONAL SECTION:</span><br><span class="line">machinename.node.eu-west.consul. 0 IN      CNAME   localhost.</span><br><span class="line"></span><br><span class="line">;; Query time: 0 msec</span><br><span class="line">;; SERVER: 127.0.0.1#8600(127.0.0.1)</span><br><span class="line">;; WHEN: Tue Apr 25 21:08:19 DST 2017</span><br><span class="line">;; MSG SIZE  rcvd: 109</span><br></pre></td></tr></table></figure><p></p><p>我们获取<code>SRV</code>记录中的端口，相应的<code>CNAME</code>记录包含我们用于注册服务的主机名或地址.</p><p>Consul DNS端点还允许我们查询标签并限制查询仅查看一个特定的数据中心。 要查询标记，我们必须在标记和服务名称前加上<code>_: _&lt;tag&gt;._&lt;serviceName&gt;.service.consul</code>,要指定数据中心查询，将根域更改为<code>&lt;servicename&gt;.service.&lt;datacenter&gt;.consul</code>.</p><h4>DNS负载均衡</h4><p>DNS端点通过以交替顺序返回结果来执行负载均衡。如果我在另一个端口上启动另一个服务实例，我们得到：</p><p></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">;; QUESTION SECTION:</span><br><span class="line">;dataservice.service.consul.    IN      SRV</span><br><span class="line"></span><br><span class="line">;; ANSWER SECTION:</span><br><span class="line">dataservice.service.consul. 0   IN      SRV     1 1 5200 machinename.node.eu-west.consul.</span><br><span class="line">dataservice.service.consul. 0   IN      SRV     1 1 5300 machinename.node.eu-west.consul.</span><br><span class="line"></span><br><span class="line">;; ADDITIONAL SECTION:</span><br><span class="line">machinename.node.eu-west.consul. 0 IN      CNAME   localhost.</span><br><span class="line">machinename.node.eu-west.consul. 0 IN      CNAME   localhost.</span><br></pre></td></tr></table></figure><p></p><p>如果您运行查询几次，您将看到答案以不同的顺序返回。</p><h4>使用DnsClient</h4><p>要通过C#代码查询DNS，我将使用我的<a href="http://dnsclient.michaco.net/" target="_blank" rel="noopener"><code>DnsClient</code></a>库。我将<code>ResolveService</code>扩展方法添加到库中，以使这些<code>SRV</code>查找非常简单。 安装<code>DnsClient</code> NuGet包后，我只需在DI中注册一<code>个DnsLookup</code>客户端：</p><p></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">services.AddSingleton&lt;IDnsQuery&gt;(p =&gt;</span><br><span class="line">&#123;</span><br><span class="line">    return new LookupClient(IPAddress.Parse(&quot;127.0.0.1&quot;), 8600);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><p></p><p></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">private readonly IDnsQuery _dns;</span><br><span class="line">private readonly IOptions&lt;ServiceDisvoveryOptions&gt; _options;</span><br><span class="line"></span><br><span class="line">public SomeController(IDnsQuery dns, IOptions&lt;ServiceDisvoveryOptions&gt; options)</span><br><span class="line">&#123;</span><br><span class="line">    _dns = dns ?? throw new ArgumentNullException(nameof(dns));</span><br><span class="line">    _options = options ?? throw new ArgumentNullException(nameof(options));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">[HttpGet(&quot;&quot;)]</span><br><span class="line">[HttpHead(&quot;&quot;)]</span><br><span class="line">public async Task&lt;IActionResult&gt; DoSomething()</span><br><span class="line">&#123;</span><br><span class="line">    var result = await _dns.ResolveServiceAsync(&quot;service.consul&quot;, _options.Value.ServiceName);</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><p><code>DnsClient.NET</code>的<code>ResolveServiceAsync</code>执行DNS <code>SRV</code>查找，匹配<code>CNAME</code>记录并为包含主机名和端口（以及使用的地址）的每个条目返回一个对象。 现在，我们可以使用简单的<code>HttpClient</code>调用（或生成的客户端）来调用服务：</p><p></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">var address = result.First().AddressList.FirstOrDefault();</span><br><span class="line">var port = result.First().Port;</span><br><span class="line"></span><br><span class="line">using (var client = new HttpClient())</span><br><span class="line">&#123;</span><br><span class="line">    var serviceResult = await client.GetStringAsync($&quot;http://&#123;address&#125;:&#123;port&#125;/Values&quot;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><h2>结论</h2><p>Consul是一个伟大，灵活和稳定的工具。我喜欢它的API和使用模式并不是固定的，你可以有很多选择来使用服务注册和其他功能。与此同时，它的性能表现也是非常优异。 在今天来说，因为有了众多的工具，在.NET中使用Consul也是非常简单方便。如果你的程序有不同部分需要通讯，那我确定它可以帮助你。</p><blockquote><p>我在GitHub上整理了一个包含<a href="https://github.com/MichaCo/AspNetCore.Services/tree/master/ConsulExample" target="_blank" rel="noopener">完整演示项目</a>，把你的想法在评论中告诉我</p></blockquote><p>原文地址:http://michaco.net/blog/ServiceDiscoveryAndHealthChecksInAspNetCoreWithConsul</p></div><footer class="post-footer"><div class="post-eof"></div></footer></div></article><article class="post post-type-normal" itemscope itemtype="http://schema.org/Article"><div class="post-block"><link itemprop="mainEntityOfPage" href="https://xuanye.github.io/serilog-tutorial/"><span hidden itemprop="author" itemscope itemtype="http://schema.org/Person"><meta itemprop="name" content="Xuanye"><meta itemprop="description" content><meta itemprop="image" content="/uploads/avatar.png"></span><span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content="假正经哥哥"></span><header class="post-header"><h2 class="post-title" itemprop="name headline"><a class="post-title-link" href="/serilog-tutorial/" itemprop="url">(译) Serilog Tutorial</a></h2><div class="post-meta"><span class="post-time"><span class="post-meta-item-icon"><i class="fa fa-calendar-o"></i> </span><span class="post-meta-item-text">Posted on</span> <time title="Post created" itemprop="dateCreated datePublished" datetime="2018-02-26T13:19:11+08:00">2018-02-26</time> </span><span class="post-category"><span class="post-meta-divider">|</span> <span class="post-meta-item-icon"><i class="fa fa-folder-o"></i> </span><span class="post-meta-item-text">In</span> <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/翻译/" itemprop="url" rel="index"><span itemprop="name">翻译</span></a></span></span></div></header><div class="post-body" itemprop="articleBody"><p>在过去的几年中，结构化日志已经大受欢迎。而Serilog是 .NET 中最著名的结构化日志类库 ,我们提供了这份的精简指南来帮助你快速了解并运用它。</p><h2>0. 内容</h2><ol><li>设定目标</li><li>认识Serilog</li><li>事件和级别</li><li>触发和收集结构化数据</li><li>为过滤和关联添加事件标记</li><li>大海捞针 [Finding needles in the haystack]</li><li>下一步是什么？</li><li>获得帮助</li></ol><h2>1. 设定目标</h2><p>你可能之前已经在项目中使用了Serilog，或者你有一个新的项目希望使用Serilog，又或者你只是对结构化日志记录感兴趣: 那就非常好！ 你来对地方了。</p><p>然而，更进一步来说，你的目标可能是：</p><ol><li>希望在用户之前发现代码中的BUG和错误</li><li>为了更快的找到生产环境中的问题</li><li>深入的了解系统运行表现</li></ol><p>Serilog使用json格式来记录应用程序中的事件，方便我们可以快速的查询日志，关键是可以方便地过滤和查询日志，而不用编写正则表达式。</p><p>在本教程中，我们将介绍最关键的几个部分，帮助我们可以在生成环境中提供令人惊叹的诊断能力。[注：原文这句挺拗口]</p><p>&lt;!-- more --&gt;</p><h2>2. 认识 Serilog</h2><p>那就让我们开始吧！为了更好的理解，你可以先创建一个新的.Net console 项目，可以是netcore或者传统的NETFramework版本。</p><p>Serilog 通过NuGet分发，项目包括一个Seirlog核心项目<em>Seirlog</em>和很多接收器<em>sinks</em>(超过100个)，这些接收是通过插件的方式来实现将日志写入到各种终端，文件,邮件,数据库或日志服务器</p><p>我们将通过使用<em>Serilog</em>和<em>Serilog.Sinks.Console</em>这两个组件开始，在稍后讨论其他选项：</p><p></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">dotnet add package Serilog</span><br><span class="line">dotnet add package Serilog.Sinks.Console</span><br></pre></td></tr></table></figure><p></p><p>这是世界上最简单的<em>Serilog</em>配置：</p><p></p><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> Serilog;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title">Program</span>  </span><br><span class="line">&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">Main</span>(<span class="params"><span class="keyword">string</span>[] args</span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        <span class="keyword">using</span> (<span class="keyword">var</span> log = <span class="keyword">new</span> LoggerConfiguration()</span><br><span class="line">            .WriteTo.Console()</span><br><span class="line">            .CreateLogger())</span><br><span class="line">        &#123;</span><br><span class="line">            log.Information(<span class="string">"Hello, Serilog!"</span>);</span><br><span class="line">            log.Warning(<span class="string">"Goodbye, Serilog."</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><p>让我们稍微分解一下:</p><ul><li><code>LoggerConfiguration</code> 类提供一个流式接口用于构建一个日志记录管道</li><li><code>WriteTo.Console（)</code> 将控制台接收器添加到上述管道中</li><li><code>CreateLogger（）</code> 组装并返回一个实现<code>ILogger</code>接口的<code>Logger</code>对象</li><li>上述Logger对象同样实现了IDisposable，所以我们可以在<code>using</code>中调用它</li><li>最后<code>log.Information（）</code>和<code>log.Warning（）</code> 触发记录日志</li></ul><p>这个日志记录管道是一个可释放的[disposable],这可能会让你有点意外，但是请记住，记录器通常是要写入文件，数据库等等： 很多<em>sinks</em> 必须被完全地关闭掉。尽管这样，也仅仅在应用程序退出前，根logger才需要被释放。而在应用程序中使用logger是不需要关心这些细节的。</p><p>你运行了这个程序嘛？这是你看到的效果吧？ <img src="http://ww1.sinaimg.cn/large/697065c1gy1fottdd5d6nj20sf0dht8r.jpg" alt></p><p>Apart from just passing it around everywhere, there are two possibilities. [ 除了在各地传递外，还有两种可能性。] If you're using an IoC container, you might have components receive an ILogger through dependency injection. [ 如果您使用的是IoC容器，则可能会让组件通过依赖注入来接收ILogger。] Packages like AutofacSerilogIntegration can help with that. [ 像AutofacSerilogIntegration这样的软件包可以提供帮助。]</p><p>现在最直接的问题是：我们在应用程序的其他类里面如何获得这个<code>log</code>对象,除了到处传递之外，还有两个办法。</p><ol><li>如果你使用IoC容器，你可以组件注入一个ILogger对象来接收，像<code>AutofacSerilogIntegration</code>的包括帮助你实现这种方式。</li><li>或者，您可以将Logger对象存储在众所周知的位置; Serilog 已经内容内置了一个静态的Log对象，就像这样：</li></ol><p></p><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">Log.Logger = <span class="keyword">new</span> LoggerConfiguration()  </span><br><span class="line">    .WriteTo.Console()</span><br><span class="line">    .CreateLogger();</span><br><span class="line"></span><br><span class="line">Log.Information(<span class="string">"Hello again, Serilog!"</span>);</span><br><span class="line"></span><br><span class="line">Log.CloseAndFlush();</span><br></pre></td></tr></table></figure><p></p><p><code>Log</code>类提供所有与<code>ILogger</code>接口相同的方法,这里我们显示调用<code>Log.CloseAndFlush（）</code>来关闭它，而不是使用<code>using</code>代码块</p><p>你可以使用依赖注入的方式，也可以是静态属性的方式 - 这取决你的个人喜好问题。为了简单起见，我们在本教程中使用了静态Log的方式。</p><blockquote><p>也许，你不是在编写一个控制台应用程序。我们将使用Console应用作为广为人知的示例，但是你一旦完成了本教程，您应该查看目标平台的文档（例如，<a href="https://nblumhardt.com/2017/08/use-serilog/" title="Leaner, meaner ASP.NET Core 2 logging" target="_blank" rel="noopener">ASP.NET Core</a>）。</p></blockquote><h2>3. Event and Level [时间和级别]</h2><p>和一些老的日志类库相比（如log4net），在使用Serilog时，你需要做的就是最大改变就是思考日志<em>事件</em>[log <em>events</em>]，而不是日志<em>消息</em>[log <em>message</em>]，一条事件[event]由以下几个内容组成:</p><ul><li>事件发生时的<strong>时间戳</strong>[<strong>timestamp</strong>]</li><li>描述何时应该捕获事件的<strong>级别</strong>[<strong>level</strong>]</li><li>记录事件的消息[<strong>message</strong>]内容]</li><li>描述事件的命名<strong>属性</strong>[<strong>properties</strong>]</li><li>还可能有一个<strong>Exception</strong>对象</li></ul><p>您可以将日志事件格式化为控制台的可读文本，正如我们在第一个示例中看到的那样：</p><pre><code>11:33:01 [INF] Hello, Serilog!  
</code></pre><p>或者，您可以将相同的事件格式化为JSON并将其发送到远程日志服务器：</p><p></p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;<span class="attr">"@t"</span>:<span class="string">"2017-11-20T11:33:01.22138"</span>,<span class="attr">"@m"</span>:<span class="string">"Hello, Serilog!"</span>&#125;</span><br></pre></td></tr></table></figure><p></p><p>在背后，应用程序中的日志语句会创建<code>LogEvent</code>对象，而连接到管道的接收器[<em>sinks</em>]会知道如何记录它们。</p><h3>Logging levels</h3><p>Serilog速度很快，但始终构建和记录详细的日志事件会浪费CPU，磁盘和网络资源。为了管理这个，Serilog事件被赋予了多种级别：<code>Debug</code>, <code>Information</code>, <code>Warning</code> 和 <code>Error</code>等。对应的有一个<code>Log.*()</code>方法来对应各个级别。</p><p>在开发过程中，可能会打开调试级别的事件：</p><p></p><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"> Log.Logger = <span class="keyword">new</span> LoggerConfiguration()  </span><br><span class="line">    .MinimumLevel.Debug() <span class="comment">// &lt;- Set the minimum level</span></span><br><span class="line">    .WriteTo.Console()</span><br><span class="line">    .CreateLogger();</span><br><span class="line"></span><br><span class="line"><span class="comment">// In a tight loop...</span></span><br><span class="line">Log.Debug(<span class="string">"Processing item &#123;ItemNumber&#125; of &#123;ItemCount&#125;"</span>, itemNumber, itemCount);</span><br></pre></td></tr></table></figure><p></p><p>在生成环境中，通常关闭调试的日志，并将最小的日志级别设置成<code>Information</code>,以便只记录重要的事件，在<a href="https://github.com/serilog/serilog/wiki/Writing-Log-Events#log-event-levels" target="_blank" rel="noopener">这篇文档</a>中可以获得有关Serilog Logger Lever的更多信息</p><p>Tip: Serilog has special handling for Exception objects; methods like Log.Error() take the exception as the first parameter, e.g. [ 提示：Serilog对Exception对象有特殊的处理;] Log.Error(ex, &quot;Task {TaskName} was canceled&quot;, task). [ Log.Error（例如，“任务{任务名称}被取消”，任务）。] Don't include exceptions in the log message itself. [ 不要在日志消息本身中包含异常。] <strong>提示</strong>:Serilog对Exception对象有特殊的处理; 像方法<code>Log.Error()</code> 将 <em>exception</em> 作为第一个参数，例如<code>Log.Error(ex, &quot;Task {TaskName} was canceled&quot;, task)</code>，不要将异常的包括在message消息中</p><h2>4. 触发和收集结构化数据</h2><p>让我们回到最后一个代码片段：</p><p></p><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> itemNumber = <span class="number">10</span>;  </span><br><span class="line"><span class="keyword">var</span> itemCount = <span class="number">999</span>;  </span><br><span class="line">Log.Debug(<span class="string">"Processing item &#123;ItemNumber&#125; of &#123;ItemCount&#125;"</span>, itemNumber, itemCount);</span><br></pre></td></tr></table></figure><p></p><p>您是否注意到日志消息中的<code>{ItemNumber}</code>这样的占位符？ 这不是一个C#的内插字符串[<em>Interpolated string</em> C# 6.0的新特性],<code>Log.*()</code>方法接收一个<a href="https://messagetemplates.org" target="_blank" rel="noopener">消息模板</a>,另外一种.NET格式化字符串，除了支持传统的<code>{0}</code>的方式，还支持<code>{Name}</code>的方式。</p><p>这看起来有点奇怪，除非您意识到通过这样做，Serilog可以将这些消息的一部分作为类的属性与人性化的文本一起捕获：</p><p></p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="attr">"@t"</span>: <span class="string">"2017-11-20T11:33:01.22138"</span>,</span><br><span class="line">    <span class="attr">"@l"</span>: <span class="string">"Debug"</span>,</span><br><span class="line">    <span class="attr">"@m"</span>: <span class="string">"Processing item 10 of 999"</span>,</span><br><span class="line">    <span class="attr">"ItemNumber"</span>: <span class="number">10</span>,</span><br><span class="line">    <span class="attr">"ItemCount"</span>: <span class="number">999</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><p>我们为什么要这样做？因为通过这种有趣的字段插入方式，并作为属性记录到事件日志中，我们可以立即使用优雅的简单的过滤器来查找事件，就像<code>ItemNumber &gt; 900</code>,而无需通过正则表达式从消息中提取了。</p><p>进一步，我们可以使用 <code>@</code> 结构捕获运算符 来获取不仅仅是平坦的属性值，而是完整的对象：</p><p></p><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> user = <span class="keyword">new</span> &#123; Name = <span class="string">"Nick"</span>, Id = <span class="string">"nblumhardt"</span> &#125;;  </span><br><span class="line">Log.Information(<span class="string">"Logged on user &#123;@User&#125;"</span>, user);</span><br></pre></td></tr></table></figure><p></p><p>在这里，<code>user</code>对象被捕获，并生成的JSON中，以便我们可以使用查询来查找事件,如:<code>User.Id = 'nblumhardt'</code></p><p></p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="attr">"@t"</span>: <span class="string">"2017-11-20T11:33:01.22138"</span>,</span><br><span class="line">    <span class="attr">"@m"</span>: <span class="string">"Logged on user &#123;\"Name\": \"Nick\", \"Id\": \"nblumhardt\"&#125;"</span>,</span><br><span class="line">    <span class="attr">"User"</span>: &#123;<span class="attr">"Name"</span>: <span class="string">"Nick"</span>, <span class="attr">"Id"</span>: <span class="string">"nblumhardt"</span>&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><p>生产环境的监控和调试已经非常困难和耗时，而且经常是压力山大的任务：而通过将相关的数据放在手边，Serilog除去了运维操作相关活动的最大难题之一。</p><p><strong>Tip</strong>: 从Visual Studio Marketplace安装令人惊叹的<a href="https://marketplace.visualstudio.com/items?itemName=Suchiman.SerilogAnalyzer" target="_blank" rel="noopener">Serilog Analyzer</a>，可以帮助你检查你的消息模板类型（ 注：这个插件还能帮你通过配置代码生成appsetting.json的内容，但是只支持生成一级配置:( ）</p><p>这实际上有多大的差异取决于你如何收集Serilog的事件。一般来说，日志事件进入文本文件并用<code>grep</code>进行搜索。Serilog也可以记录文本文件，但不能在记事本中执行<code>ItemNumber&gt; 900</code>，因此您需要评估更强大的工具来执行此操作。</p><h3>写 JSON 格式的日志文件</h3><p>如果您的需求很简单，您可以将JSON写入日志文件，并使用支持JSON的工具直接查询文件。] [ Serilog的文件接收器[<em>sink</em>]和紧凑的JSON格式化类库[compact JSON formatter]使第一部分变得简单。 让我们重新建一个控制台应用程序，并安装下列软件包：</p><p></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">dotnet add package Serilog</span><br><span class="line">dotnet add package Serilog.Sinks.File  </span><br><span class="line">dotnet add package Serilog.Formatting.Compact</span><br></pre></td></tr></table></figure><p></p><p>在<code>Main</code>函数中插入:</p><p></p><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">Log.Logger = <span class="keyword">new</span> LoggerConfiguration()  </span><br><span class="line">    .MinimumLevel.Debug()</span><br><span class="line">    .WriteTo.File(<span class="keyword">new</span> CompactJsonFormatter(), <span class="string">"log.clef"</span>)</span><br><span class="line">    .CreateLogger();</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> itemCount = <span class="number">99</span>;  </span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">var</span> itemNumber = <span class="number">0</span>; itemNumber &lt; itemCount; ++itemNumber)  </span><br><span class="line">    Log.Debug(<span class="string">"Processing item &#123;ItemNumber&#125; of &#123;ItemCount&#125;"</span>, itemNumber, itemCount);</span><br><span class="line"></span><br><span class="line">Log.CloseAndFlush();</span><br></pre></td></tr></table></figure><p></p><p>运行这个程序将产生使用Serilog的紧凑格式[compact]，在文件log.clef中生成以<a href="https://en.wikipedia.org/wiki/JSON_streaming" title="newline-delimited JSON stream" target="_blank" rel="noopener">换行符分隔的<code>JSON</code>流</a>,如果没有使用<code>CompactJsonFormatter</code>，则会创建一个简单饿扁平日志文件。</p><p>如果你在文本编辑器中打开文件，你会看到JSON事件，就像我们上面使用的例子。</p><p><a href="https://github.com/datalust/clef-tool" target="_blank" rel="noopener">CLEF-tool</a> 是查询CLEF格式的日志文件的方便的命令行应用程序：(注:貌似只支持windows)</p><p><img src="http://ww1.sinaimg.cn/large/697065c1gy1fotvarg5n7j20xe0dzdgb.jpg" alt></p><p>注意第二行的过滤器<code>ItemNumber&gt; 95</code>：毫不费力地在大型日志流中定位事件,就是结构化日志记录的好处吧。</p><h3>将日志写入日志服务器</h3><p>将日志事件从多个应用程序发送到中央服务器或日志聚合服务非常方便,而不是试图在生产环境中多个日志进行浑水摸鱼[shuffle log files]</p><p>日志服务器通常通过HTTP/S或UDP在网络上接收事件，并为开发人员和操作员工程师提供用户界面，以便在出现问题时搜索和分析日志流。</p><p><a href="https://github.com/serilog/serilog/wiki/Provided-Sinks" target="_blank" rel="noopener">Serilog接收器</a>[sinks]支持大量的日志服务器，其中许多具有结构化数据支持。</p><p>注：这段是广告就不翻译了，读者可以根据实际需求选择自己的日志服务器。</p><h2>5. 为过滤和关联标记事件</h2><p>我们刚刚看到消息模板如何实现我们传统上认为可以有效搜索和分析的日志“消息”。</p><p>结构化日志记录的另一方面是通过某种因果关系或空间关联来识别相关事件集合。事件触发:[Events raised: ]</p><ul><li>在处理单个HTTP请求期间</li><li>从特定的机器，应用程序，服务或组件</li><li>关于单个客户，订单或交易</li><li>起因于事件的因果链</li></ul><p>Serilog通过<em>enrichment</em>来处理所有这些情况（以及其他情况）。<em>Enrichment</em>只是为事件添加附加属性，而不是源自消息模板的属性</p><h3>添加[Enriching]特定的属性</h3><p>最简单的enrichment方法将固定属性值添加到源自日志记录管道的所有事件，可以通过<code>Enrich.WithProperty()</code>方法快速实现</p><p></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Log.Logger = new LoggerConfiguration()  </span><br><span class="line">    .Enrich.WithProperty(&quot;Application&quot;, &quot;Demo&quot;)</span><br><span class="line">    .WriteTo.Seq(&quot;http://localhost:5341&quot;) //Seq 日志服务器</span><br><span class="line">    .CreateLogger();</span><br></pre></td></tr></table></figure><p></p><p>在<code>LogEvents</code>上，通过<em>enrichment</em>添加的属性看起来与源自消息模板的属性相同</p><p></p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"> &#123;</span><br><span class="line">    <span class="attr">"@t"</span>: <span class="string">"2017-11-20T11:33:01.22138"</span>,</span><br><span class="line">    <span class="attr">"@l"</span>: <span class="string">"Debug"</span>,</span><br><span class="line">    <span class="attr">"@m"</span>: <span class="string">"Processing item 10 of 999"</span>,</span><br><span class="line">    <span class="attr">"ItemNumber"</span>: <span class="number">10</span>,</span><br><span class="line">    <span class="attr">"ItemCount"</span>: <span class="number">999</span>,</span><br><span class="line">    <span class="attr">"Application"</span>: <span class="string">"Demo"</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><h3>丰富特殊的属性</h3><p>通过创建和使用上下文记录器，可以将属性添加到一个或几个相关事件中，而不是增加具有相同值的所有事件</p><p></p><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> orderLog = Log.ForContext(<span class="string">"OrderId"</span>, order.Id);  </span><br><span class="line">orderLog.Information(<span class="string">"Looking up product codes"</span>);  </span><br><span class="line"><span class="comment">// ...</span></span><br><span class="line">orderLog.Information(<span class="string">"Product lookup took &#123;Elapsed&#125; ms"</span>, elapsed.TotalMilliseconds);</span><br></pre></td></tr></table></figure><p></p><p>在这里，通过<code>orderLog</code>发出的两个事件都会附加一个<code>OrderId</code>属性。 <code>Enrichmen</code>是附加的:如果应用程序属性设置在管道级别，则上面的第二个事件将携带<code>Elapsed</code>（来自消息），<code>OrderId</code>（来自上下文记录器）和<code>Application</code>（来自记录管道）。</p><h3>丰富消息源类型信息</h3><p>记录器特定的<em>enrichment</em>一个特例是关于如何使用创建它们的类标记事件</p><p>在名为<code>HomeController</code>的类中，使用以下命令创建类型特定的记录器：</p><p></p><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">readonly</span> ILogger _log = Log.ForContext&lt;HomeController&gt;();</span><br></pre></td></tr></table></figure><p></p><p>通过<code>_log</code>发出的事件将携带一个值为<code>MyApp.Controllers.HomeController</code>的<code>SourceContext</code>属性。</p><h3>充分利用上下文</h3><p>为了丰富工作单元中所有事件[为所有事件添加特定属性],<code>Serilog</code>提供了<code>LogContext</code>,首先需要使用<code>Enrich.FromLogContext()</code>在<code>LoggerConfiguration</code>级别启用：</p><p></p><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Log.Logger = <span class="keyword">new</span> LoggerConfiguraition()  </span><br><span class="line">     .Enrich.FromLogContext()</span><br><span class="line">     <span class="comment">// ...</span></span><br></pre></td></tr></table></figure><p></p><p>LogContext可以被认为是一堆<code>(key,value)</code>键值对;</p><p></p><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> (LogContext.PushProperty(<span class="string">"MessageId"</span>, message.Id))  </span><br><span class="line">&#123;</span><br><span class="line">    Log.Debug(<span class="string">"Dispatching message of type &#123;MessageType&#125;"</span>, message.GetType());</span><br><span class="line">    <span class="keyword">await</span> handler.HandleAsync(message);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><p>关于LogContext有趣的是没有什么需要对象需要传递。在示例代码中，<code>HandleAsync()</code>以及由它调用的任何其他方法的实现可以直接使用<code>Log</code>和<code>ILogger</code> - MessageId属性将自动T并添加<code>LogEvent</code>中。</p><p><strong>Tip</strong>: <code>LogContext</code>是一个堆栈;推送到堆栈上的属性必须通过释放从PushProperty()返回的对象， -- 上述通过手动使用<code>using</code>块的方式</p><h3>已经存在的Enricher</h3><p>所有<em>enrichment</em> API都是使用<code>Enricher</code>的实现Serilog的<code>ILogEventEnricher</code>接口的对象来实现的。</p><p>NuGet中为线程细节，机器信息和用户详细信息等内容提供了一些有趣的预先构建的Enricher实现。</p><p><a href="https://github.com/serilog/serilog-enrichers-thread" target="_blank" rel="noopener">Serilog.Enrichers.Thread</a> 通过 Enrich.WithThreadId() 来添加线程ID相关的扩展:</p><p></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Log.Logger = new LoggerConfiguration()  </span><br><span class="line">    .Enrich.WithThreadId()</span><br><span class="line">    // ...</span><br></pre></td></tr></table></figure><p></p><p>这将为事件附加一个<code>ThreadId</code>属性，以便交错事件可以再次分开。</p><p>我们将在下一节中看到一个简单的例子，说明如何编写和插入自己的应用程序专用的<code>Enricher</code>程序。</p><h2>6. 大海捞针 Finding needles in the haystack</h2><p>如果我们已经知道如何使用Serilog调用消息模板和enrichment结构化日志的两个支柱，那么第三个支柱就是隐式事件类型的概念。</p><p>结构化日志适合有效处理大量日志数据。关于大型日志流的一个有趣的观察是，真实产生的事件比编写日志语句代码块时要多的多（注:这算什么发现）</p><p></p><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Log.Debug(<span class="string">"Processing item &#123;ItemNumber&#125; of &#123;ItemCount&#125;"</span>, itemNumber, itemCount);</span><br></pre></td></tr></table></figure><p></p><p>这意味着,尽管生成了许多独特的消息字符串,如<code>&quot;Processing item 31 of 4159&quot;</code>,但由此日志记录语句生成的每个事件共享相同的消息模板，即<code>&quot;Processing item {ItemNumber} of {ItemCount}&quot;</code></p><p>Serilog及其许多sinks 利用这一事实从根本上改进了查询和过滤日志事件的体验。如果消息模板与事件一起保存，则下面的过滤器可以立即从嘈杂的日志记录语句中排除成千上万的事件，从而更容易看到否则会被淹没的有趣事件：</p><p></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">@MessageTemplate &lt;&gt; &apos;Processing item &#123;ItemNumber&#125; of &#123;ItemCount&#125;&apos;</span><br></pre></td></tr></table></figure><p></p><p>反转也适用 - 放大事件类型可以从单个日志记录语句中查找所有事件</p><p>如何利用此功能取决于您存储和搜索日志的位置。接下来我们会看看细节。</p><p><strong>Tip</strong>:字符串链接，C#内插字符串，以及其他技术手段来预格式化传递给Serilog的消息内容，会取消此功能。详细请看 <a href="https://nblumhardt.com/2014/09/how-not-to-parameterize-serilog-events/" target="_blank" rel="noopener">How (not) to parameterize Serilog events</a></p><h3>隐式事件类型</h3><p>存储，然后过滤罗嗦的消息模板并不总是理想的。 相反，通常从消息模板创建一个数字哈希值，并将其与事件一起存储： <img src="http://ww1.sinaimg.cn/large/697065c1gy1fotxujxoo9j21690h0q3j.jpg" alt></p><h3>事件类型 enrichment</h3><p>日志文件和本地不支持消息模板的日志服务器仍然可以通过在Serilog管道中明确地<code>enricher</code>事件来接收事件类型。</p><p>为此，自定义<code>enricher</code>程序将<code>EventType</code>属性附加到每个事件</p><p></p><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Install-Package Murmurhash</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title">EventTypeEnricher</span> : <span class="title">ILogEventEnricher</span>  </span><br><span class="line">&#123;</span><br><span class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">Enrich</span>(<span class="params">LogEvent logEvent, ILogEventPropertyFactory propertyFactory</span>)</span></span><br><span class="line"><span class="function"></span>   &#123;</span><br><span class="line">      <span class="keyword">var</span> murmur = MurmurHash.Create32();</span><br><span class="line">      <span class="keyword">var</span> bytes = Encoding.UTF8.GetBytes(logEvent.MessageTemplate.Text);</span><br><span class="line">      <span class="keyword">var</span> hash = murmur.ComputeHash(bytes);</span><br><span class="line">      <span class="keyword">var</span> numericHash = BitConverter.ToUInt32(hash, <span class="number">0</span>);</span><br><span class="line">      <span class="keyword">var</span> eventType = propertyFactory.CreateProperty(<span class="string">"EventType"</span>, numericHash);</span><br><span class="line">      logEvent.AddPropertyIfAbsent(eventType);</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><p>当插入管道时，这会使<code>{EventType}</code>属性可用于<code>sinks</code></p><p></p><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Log.Logger = <span class="keyword">new</span> LoggerConfiguration()  </span><br><span class="line">   .Enrich.With&lt;EventTypeEnricher&gt;()</span><br><span class="line">   .WriteTo.Console(outputTemplate:</span><br><span class="line">       <span class="string">"&#123;Timestamp:HH:mm:ss&#125; [&#123;EventType:x8&#125; &#123;Level:u3&#125;] &#123;Message:lj&#125;&#123;NewLine&#125;&#123;Exception&#125;"</span>)</span><br><span class="line">   .CreateLogger();</span><br></pre></td></tr></table></figure><p></p><p><code>WriteTo.Console()</code>的参数是一个Serilog输出模板，描述了如何将日志事件的属性格式化为文本。 大多数基于文本的sinks（包括<code>Serilog.Sinks.File</code>）都可以接受输出模板来指导格式化。</p><p>[ 输出如下所示：]</p><p><img src="http://ww1.sinaimg.cn/large/697065c1gy1foty29nelmj21eo0b3dg5.jpg" alt></p><h2>7. 下一步做什么</h2><p>Serilog是一个强大的库，拥有广泛的插件和工具生态系统。我们只涉及绝对的基础知识 - 取决于您希望如何使用Serilog以及您使用的框架和平台，还有很多可以发现的地方。</p><p>这里有一些文章和扩展，供你参考：</p><ul><li><strong>Debugging and diagnostics</strong> - if you're having trouble getting Serilog or a sink to work, check out this page on <a href="https://github.com/serilog/serilog/wiki/Debugging-and-Diagnostics" target="_blank" rel="noopener">the Serilog wiki</a></li><li><strong><code>appsettings.json</code> configuration</strong> - in this article we've only shown the C# configuration API; <a href="https://github.com/serilog/serilog-settings-configuration" target="_blank" rel="noopener">Serilog.Settings.Configuration</a> adds support for logger configuration in .NET Core JSON settings</li><li><strong>XML <code>&lt;appSettings&gt;</code> configuration</strong> - <a href="https://github.com/serilog/serilog-settings-appsettings" target="_blank" rel="noopener">Serilog.Settings.AppSettings</a> adds support for reading logger configuration from .NET Framework configuration files</li><li><strong>ASP.NET Core integration</strong> - the <a href="https://github.com/serilog/serilog-aspnetcore" target="_blank" rel="noopener">Serilog.AspNetCore</a> package seamlessly integrates Serilog into ASP.NET Core 2.0 apps to take advantage of the structured log events emitted by the framework</li><li><strong>ASP.NET integration</strong> - check out <a href="https://github.com/serilog-web/classic" target="_blank" rel="noopener">SerilogWeb.Classic</a> for a quick-and-painless way to record unhandled exceptions and request timings from ASP.NET projects</li><li><strong>Smart logging middleware for ASP.NET Core</strong> - improve the quality of request logging in ASP.NET Core with the <a href="https://blog.getseq.net/smart-logging-middleware-for-asp-net-core/" target="_blank" rel="noopener">middleware from this article</a></li><li><strong>Timed operations</strong> - <a href="https://github.com/nblumhardt/serilog-timings" target="_blank" rel="noopener">SerilogTimings</a> is a small wrapper for Serilog that makes it easy to log operation timings</li><li><strong>Autofac-Serilog integration</strong> - use <a href="https://github.com/nblumhardt/autofac-serilog-integration" target="_blank" rel="noopener">AutofacSerilogIntegration</a> to inject Serilog ILoggers through Autofac with type information automatically added</li><li><strong>Code analysis for Serilog</strong> - mentioned earlier, <a href="https://github.com/suchiman/SerilogAnalyzer" target="_blank" rel="noopener">Serilog Analyzer</a> checks message template syntax in Visual Studio as-you-type, and detects many potential Serilog usage issues</li><li><strong>Dynamic filtering</strong> - <a href="https://github.com/serilog/serilog-filters-expressions" target="_blank" rel="noopener">Serilog.Filters.Expressions</a> makes it possible to filter events using a simple domain-specific language</li><li><strong>Async wrapper</strong> - the latency of logging to files or the console can be reduced further using the <a href="https://github.com/serilog/serilog-sinks-async" target="_blank" rel="noopener">Serilog.Sinks.Async</a> package</li><li><strong>Sink READMEs</strong> - most sinks, including <a href="https://github.com/serilog/serilog-sinks-file" target="_blank" rel="noopener">Serilog.Sinks.File</a>, <a href="https://github.com/serilog/serilog-sinks-console" target="_blank" rel="noopener">Serilog.Sinks.Console</a>, <a href="https://github.com/serilog/serilog-sinks-seq" target="_blank" rel="noopener">Serilog.Sinks.Seq</a> and others, have good README documents in their GitHub repositories with detailed instructions for using the sink</li><li><strong>Structured Logging Concepts in .NET series</strong> - this <a href="https://nblumhardt.com/2016/06/structured-logging-concepts-in-net-series-1/" target="_blank" rel="noopener">blog series on structured logging</a> has more detail on much of what we've covered in this tutorial</li><li><strong>F# support</strong> - if your application is written in F#, <a href="https://github.com/destructurama/fsharp" target="_blank" rel="noopener">Destructurama.FSharp</a> will let you log F# types seamlessly through Serilog</li><li><strong>JSON.NET support</strong> - <a href="https://github.com/destructurama/json-net" target="_blank" rel="noopener">Destructurama.JsonNet</a> extends Serilog to allow JSON.NET dynamic objects to be logged as structured data</li><li><strong>Exception enricher</strong> - <a href="https://github.com/RehanSaeed/Serilog.Exceptions" target="_blank" rel="noopener">Serilog.Exceptions</a> collects additional exception-type-specific information and attaches it to log events</li><li><strong>Async stack trace unmangling</strong> - <a href="https://github.com/nblumhardt/serilog-enrichers-demystify" target="_blank" rel="noopener">Serilog.Enrichers.Demystify</a> plugs in Ben Adams' Demystifier to improve the readability of exception stack traces</li></ul><h2>8. 获得帮助</h2><p>Serilog有三大优秀的社区支持渠道：</p><ul><li><a href="https://stackoverflow.com/questions/tagged/serilog" target="_blank" rel="noopener">Stack Overflow</a> - 如果您有Seri​​log使用问题，Stack Overflow上的Serilog标签是一个很好的开始; 它被积极监控，并且您将通过留下一个容易找到的答案来帮助其他人解决同一个问题</li><li><a href="https://gitter.im/serilog/serilog" target="_blank" rel="noopener">Gitter Chat</a> - 如果您的问题不符合Stack Overflow格式，或者您只是想完善检查方法，那么Gitter聊天室是与Serilog社区中的其他人联系的快捷方式</li><li><a href="https://github.com/serilog/serilog/issues" target="_blank" rel="noopener">GitHub Issues</a> - 最后，如果你发现了一个bug或者想要对Serilog进行改进，GitHub就是这个地方; <a href="https://github.com/serilog" target="_blank" rel="noopener">Serilog organization</a> 包括了serilog所有的核心库和问题跟踪。</li></ul><p>Happy logging!</p><p>原文地址<a href="http://blog.getseq.net/serilog-tutorial/" target="_blank" rel="noopener">http://blog.getseq.net/serilog-tutorial/</a></p></div><footer class="post-footer"><div class="post-eof"></div></footer></div></article><article class="post post-type-normal" itemscope itemtype="http://schema.org/Article"><div class="post-block"><link itemprop="mainEntityOfPage" href="https://xuanye.github.io/dotnetty-quickstart/"><span hidden itemprop="author" itemscope itemtype="http://schema.org/Person"><meta itemprop="name" content="Xuanye"><meta itemprop="description" content><meta itemprop="image" content="/uploads/avatar.png"></span><span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content="假正经哥哥"></span><header class="post-header"><h2 class="post-title" itemprop="name headline"><a class="post-title-link" href="/dotnetty-quickstart/" itemprop="url">使用DotNetty编写跨平台网络通信程序</a></h2><div class="post-meta"><span class="post-time"><span class="post-meta-item-icon"><i class="fa fa-calendar-o"></i> </span><span class="post-meta-item-text">Posted on</span> <time title="Post created" itemprop="dateCreated datePublished" datetime="2017-05-29T12:37:24+08:00">2017-05-29</time> </span><span class="post-category"><span class="post-meta-divider">|</span> <span class="post-meta-item-icon"><i class="fa fa-folder-o"></i> </span><span class="post-meta-item-text">In</span> <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/原创/" itemprop="url" rel="index"><span itemprop="name">原创</span></a></span></span></div></header><div class="post-body" itemprop="articleBody"><p>长久以来,.Net开发人员都非常羡慕Java有Netty这样，高效，稳定又易用的网络通信基础框架。终于微软的Azure团队，使用C#实现的Netty的版本发布。不但使用了C#和.Net平台的技术特点，并且保留了Netty原来绝大部分的编程接口。让我们在使用时，完全可以依照Netty官方的教程来学习和使用DotNetty应用程序。 DotNetty同时也是开源的，它的源代码托管在Github上:<a href="https://github.com/azure/dotnetty" target="_blank" rel="noopener">https://github.com/azure/dotnetty</a></p><p>&lt;!-- more --&gt;</p><h2>0x01 项目预览</h2><p>从github上下载最新的代码到本地，使用VS2017或者VSCode打开下载好的代码，可以看到如图所示的代码那结构，其中源码部分有9个项目组成，其中</p><blockquote><p>DotNetty.Common 是公共的类库项目，包装线程池，并行任务和常用帮助类的封装 DotNetty.Transport 是DotNetty核心的实现 DotNetty.Buffers 是对内存缓冲区管理的封装 DotNetty.Codes 是对编解码是封装，包括一些基础基类的实现，我们在项目中自定义的协议，都要继承该项目的特定基类和实现<br>DotNetty.Handlers 封装了常用的管道处理器，比如Tls编解码，超时机制，心跳检查，日志等，如果项目中没有用到可以不引用，不过一般都会用到<br>其他还有对Redis的编解码，Mqtt的编解码，Protobuf2/3的编解码项目中可根据实际情况引用 很遗憾Http协议和Websocket协议还没有实现。</p></blockquote><h2>0x02 快速开始-示例-回声程序的实现</h2><p>从上一步下载的代码中，看到有一个sample目录，有很多例子，都大同小异， 先来看这个最简单的Echo服务的实现吧.<br>Echo服务，分为服务端和客户端，服务端使用DotNetty框架启动一个Socket服务，并等待客户端链接，当客户端链接并接收客户端消息，并将接收到的消息原样返回给客户端。而客户端同样使用DotNetty框架启动一个Socket客户端服务，并链接到服务端，并发送一条Hello的字符串信息，并等待服务端返回。如此往复。</p><h3>2.1 Echo Server</h3><p>来一起看一下代码吧，我把注释都写到代码中：</p><p></p><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">async</span> Task <span class="title">RunServerAsync</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="comment">//设置输出日志到Console</span></span><br><span class="line">    ExampleHelper.SetConsoleLogger();</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 主工作线程组，设置为1个线程</span></span><br><span class="line"> 	<span class="keyword">var</span> bossGroup = <span class="keyword">new</span> MultithreadEventLoopGroup(<span class="number">1</span>);</span><br><span class="line">	<span class="comment">// 工作线程组，默认为内核数*2的线程数</span></span><br><span class="line">    <span class="keyword">var</span> workerGroup = <span class="keyword">new</span> MultithreadEventLoopGroup();</span><br><span class="line">    X509Certificate2 tlsCertificate = <span class="literal">null</span>;</span><br><span class="line">    <span class="keyword">if</span> (ServerSettings.IsSsl) <span class="comment">//如果使用加密通道</span></span><br><span class="line">            &#123;</span><br><span class="line">                tlsCertificate = <span class="keyword">new</span> X509Certificate2(Path.Combine(ExampleHelper.ProcessDirectory, <span class="string">"dotnetty.com.pfx"</span>), <span class="string">"password"</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">try</span></span><br><span class="line">            &#123;</span><br><span class="line">				</span><br><span class="line">				<span class="comment">//声明一个服务端Bootstrap，每个Netty服务端程序，都由ServerBootstrap控制，</span></span><br><span class="line">				<span class="comment">//通过链式的方式组装需要的参数</span></span><br><span class="line"></span><br><span class="line">                <span class="keyword">var</span> bootstrap = <span class="keyword">new</span> ServerBootstrap();</span><br><span class="line">                bootstrap</span><br><span class="line">                    .Group(bossGroup, workerGroup) <span class="comment">// 设置主和工作线程组</span></span><br><span class="line">                    .Channel&lt;TcpServerSocketChannel&gt;() <span class="comment">// 设置通道模式为TcpSocket</span></span><br><span class="line">                    .Option(ChannelOption.SoBacklog, <span class="number">100</span>) <span class="comment">// 设置网络IO参数等，这里可以设置很多参数，当然你对网络调优和参数设置非常了解的话，你可以设置，或者就用默认参数吧</span></span><br><span class="line">                    .Handler(<span class="keyword">new</span> LoggingHandler(<span class="string">"SRV-LSTN"</span>)) <span class="comment">//在主线程组上设置一个打印日志的处理器</span></span><br><span class="line">                    .ChildHandler(<span class="keyword">new</span> ActionChannelInitializer&lt;ISocketChannel&gt;(channel =&gt;</span><br><span class="line">                    &#123; <span class="comment">//工作线程连接器 是设置了一个管道，服务端主线程所有接收到的信息都会通过这个管道一层层往下传输</span></span><br><span class="line"><span class="comment">//同时所有出栈的消息 也要这个管道的所有处理器进行一步步处理</span></span><br><span class="line">                        IChannelPipeline pipeline = channel.Pipeline;</span><br><span class="line">                        <span class="keyword">if</span> (tlsCertificate != <span class="literal">null</span>) <span class="comment">//Tls的加解密</span></span><br><span class="line">                        &#123;</span><br><span class="line">                            pipeline.AddLast(<span class="string">"tls"</span>, TlsHandler.Server(tlsCertificate));</span><br><span class="line">                        &#125;</span><br><span class="line">						<span class="comment">//日志拦截器</span></span><br><span class="line">                        pipeline.AddLast(<span class="keyword">new</span> LoggingHandler(<span class="string">"SRV-CONN"</span>));</span><br><span class="line"><span class="comment">//出栈消息，通过这个handler 在消息顶部加上消息的长度</span></span><br><span class="line">                        pipeline.AddLast(<span class="string">"framing-enc"</span>, <span class="keyword">new</span> LengthFieldPrepender(<span class="number">2</span>));</span><br><span class="line"><span class="comment">//入栈消息通过该Handler,解析消息的包长信息，并将正确的消息体发送给下一个处理Handler，该类比较常用，后面单独说明</span></span><br><span class="line">                        pipeline.AddLast(<span class="string">"framing-dec"</span>, <span class="keyword">new</span> LengthFieldBasedFrameDecoder(<span class="keyword">ushort</span>.MaxValue, <span class="number">0</span>, <span class="number">2</span>, <span class="number">0</span>, <span class="number">2</span>));</span><br><span class="line"><span class="comment">//业务handler ，这里是实际处理Echo业务的Handler</span></span><br><span class="line">                        pipeline.AddLast(<span class="string">"echo"</span>, <span class="keyword">new</span> EchoServerHandler());</span><br><span class="line">                    &#125;));</span><br><span class="line">			</span><br><span class="line">		<span class="comment">// bootstrap绑定到指定端口的行为 就是服务端启动服务，同样的Serverbootstrap可以bind到多个端口</span></span><br><span class="line">                IChannel boundChannel = <span class="keyword">await</span> bootstrap.BindAsync(ServerSettings.Port);</span><br><span class="line"></span><br><span class="line">                Console.ReadLine();</span><br><span class="line"><span class="comment">//关闭服务</span></span><br><span class="line">                <span class="keyword">await</span> boundChannel.CloseAsync();</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">finally</span></span><br><span class="line">            &#123;</span><br><span class="line"><span class="comment">//释放工作组线程</span></span><br><span class="line">                <span class="keyword">await</span> Task.WhenAll(</span><br><span class="line">                    bossGroup.ShutdownGracefullyAsync(TimeSpan.FromMilliseconds(<span class="number">100</span>), TimeSpan.FromSeconds(<span class="number">1</span>)),</span><br><span class="line">                    workerGroup.ShutdownGracefullyAsync(TimeSpan.FromMilliseconds(<span class="number">100</span>), TimeSpan.FromSeconds(<span class="number">1</span>)));</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br></pre></td></tr></table></figure><p></p><p>来看下实际的业务代码，比较简单，也就是打印日志，并返回收到的字符串</p><p></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"> public class EchoServerHandler : ChannelHandlerAdapter //管道处理基类，较常用</span><br><span class="line">    &#123;</span><br><span class="line">//	重写基类的方法，当消息到达时触发，这里收到消息后，在控制台输出收到的内容，并原样返回了客户端</span><br><span class="line">        public override void ChannelRead(IChannelHandlerContext context, object message)</span><br><span class="line">        &#123;</span><br><span class="line"></span><br><span class="line">            var buffer = message as IByteBuffer;</span><br><span class="line">            if (buffer != null)</span><br><span class="line">            &#123;</span><br><span class="line">                Console.WriteLine(&quot;Received from client: &quot; + buffer.ToString(Encoding.UTF8));</span><br><span class="line">            &#125;</span><br><span class="line">            context.WriteAsync(message);//写入输出流</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">// 输出到客户端，也可以在上面的方法中直接调用WriteAndFlushAsync方法直接输出</span><br><span class="line">        public override void ChannelReadComplete(IChannelHandlerContext context) =&gt; context.Flush();</span><br><span class="line"></span><br><span class="line">//捕获 异常，并输出到控制台后断开链接，提示：客户端意外断开链接，也会触发</span><br><span class="line">        public override void ExceptionCaught(IChannelHandlerContext context, Exception exception)</span><br><span class="line">        &#123;</span><br><span class="line">            Console.WriteLine(&quot;Exception: &quot; + exception);</span><br><span class="line">            context.CloseAsync();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p></p><h3>2.2 Echo Client</h3><p>客户端的代码和服务端的代码相差很少，体现了Netty统一的编程模型。有几个不同点：</p><ol><li>客户端的Bootstrap不是ServerBootstrap了，</li><li>客户端不需要主线程组，只有工作线程组，消息处理管道也建立在里主线程工作组的拦截通道上。</li><li>最后不是bind而是connect</li></ol><p></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line">static async Task RunClientAsync()</span><br><span class="line">        &#123;</span><br><span class="line">            ExampleHelper.SetConsoleLogger();</span><br><span class="line"></span><br><span class="line">            var group = new MultithreadEventLoopGroup();</span><br><span class="line"></span><br><span class="line">            X509Certificate2 cert = null;</span><br><span class="line">            string targetHost = null;</span><br><span class="line">            if (ClientSettings.IsSsl)</span><br><span class="line">            &#123;</span><br><span class="line">                cert = new X509Certificate2(Path.Combine(ExampleHelper.ProcessDirectory, &quot;dotnetty.com.pfx&quot;), &quot;password&quot;);</span><br><span class="line">                targetHost = cert.GetNameInfo(X509NameType.DnsName, false);</span><br><span class="line">            &#125;</span><br><span class="line">            try</span><br><span class="line">            &#123;</span><br><span class="line">                var bootstrap = new Bootstrap();</span><br><span class="line">                bootstrap</span><br><span class="line">                    .Group(group)</span><br><span class="line">                    .Channel&lt;TcpSocketChannel&gt;()</span><br><span class="line">                    .Option(ChannelOption.TcpNodelay, true)</span><br><span class="line">                    .Handler(new ActionChannelInitializer&lt;ISocketChannel&gt;(channel =&gt;</span><br><span class="line">                    &#123;</span><br><span class="line">                        IChannelPipeline pipeline = channel.Pipeline;</span><br><span class="line"></span><br><span class="line">                        if (cert != null)</span><br><span class="line">                        &#123;</span><br><span class="line">                            pipeline.AddLast(&quot;tls&quot;, new TlsHandler(stream =&gt; new SslStream(stream, true, (sender, certificate, chain, errors) =&gt; true), new ClientTlsSettings(targetHost)));</span><br><span class="line">                        &#125;</span><br><span class="line">                        pipeline.AddLast(new LoggingHandler());</span><br><span class="line">                        pipeline.AddLast(&quot;framing-enc&quot;, new LengthFieldPrepender(2));</span><br><span class="line">                        pipeline.AddLast(&quot;framing-dec&quot;, new LengthFieldBasedFrameDecoder(ushort.MaxValue, 0, 2, 0, 2));</span><br><span class="line"></span><br><span class="line">                        pipeline.AddLast(&quot;echo&quot;, new EchoClientHandler());</span><br><span class="line">                    &#125;));</span><br><span class="line"></span><br><span class="line">                IChannel clientChannel = await bootstrap.ConnectAsync(new IPEndPoint(ClientSettings.Host, ClientSettings.Port));</span><br><span class="line"></span><br><span class="line">                Console.ReadLine();</span><br><span class="line"></span><br><span class="line">                await clientChannel.CloseAsync();</span><br><span class="line">            &#125;</span><br><span class="line">            finally</span><br><span class="line">            &#123;</span><br><span class="line">                await group.ShutdownGracefullyAsync(TimeSpan.FromMilliseconds(100), TimeSpan.FromSeconds(1));</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br></pre></td></tr></table></figure><p></p><p>业务代码</p><p></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">// 代码和服务端也相差不多，并且继承了同样的基类。</span><br><span class="line"> public class EchoClientHandler : ChannelHandlerAdapter</span><br><span class="line">    &#123;</span><br><span class="line">        readonly IByteBuffer initialMessage;</span><br><span class="line"></span><br><span class="line">        public EchoClientHandler()</span><br><span class="line">        &#123;</span><br><span class="line">            this.initialMessage = Unpooled.Buffer(ClientSettings.Size);</span><br><span class="line">            byte[] messageBytes = Encoding.UTF8.GetBytes(&quot;Hello world&quot;);</span><br><span class="line">            this.initialMessage.WriteBytes(messageBytes);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">	//重写基类方法，当链接上服务器后，马上发送Hello World消息到服务端</span><br><span class="line">        public override void ChannelActive(IChannelHandlerContext context) =&gt; context.WriteAndFlushAsync(this.initialMessage);</span><br><span class="line"></span><br><span class="line">        public override void ChannelRead(IChannelHandlerContext context, object message)</span><br><span class="line">        &#123;</span><br><span class="line">            var byteBuffer = message as IByteBuffer;</span><br><span class="line">            if (byteBuffer != null)</span><br><span class="line">            &#123;</span><br><span class="line">                Console.WriteLine(&quot;Received from server: &quot; + byteBuffer.ToString(Encoding.UTF8));</span><br><span class="line">            &#125;</span><br><span class="line">            context.WriteAsync(message);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        public override void ChannelReadComplete(IChannelHandlerContext context) =&gt; context.Flush();</span><br><span class="line"></span><br><span class="line">        public override void ExceptionCaught(IChannelHandlerContext context, Exception exception)</span><br><span class="line">        &#123;</span><br><span class="line">            Console.WriteLine(&quot;Exception: &quot; + exception);</span><br><span class="line">            context.CloseAsync();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p></p><h2>0x03 常用Handler和基类</h2><p>从Echo服务的例子中，我们可以看到Netty程序不管时服务端还是客户端都通过一个Bootstrap/ServerBootstrap来启动Socket程序，并通过设置处理Handler管道来处理出入的消息，管道中常见的拦截器有加解密，日志记录，编解码，消息头处理，业务处理等，实际业务中根据情况可以自行添加自己的业务逻辑，同时很多处理器代码在服务端和客户端是公用的，Netty本身已经提供了一些常用处理器和业务处理器的基类来简化实际开发，我们一起看一下</p><h3>3.1 TlsHandler</h3><p>Netty支持Tls加密传输，TlsHandler类可以在开发人员无须关心加密传输时字节码的变化，只关心自己的业务代码即可。在管道处理的第一个配置该类即可</p><h3>3.2 LengthFieldPrepender</h3><p>这个handler 会在实际发送前在将数据的长度放置在数据前，本例中使用2个字节来存储数据的长度。</p><h3>3.3 LengthFieldBasedFrameDecoder</h3><p>这个handler比较常用，会在解码前用于解析数据，用于读取数据包的头信息，特别是包长，并等待数据达到包长后再交由下一个handler处理。 参数说明 以下是Amp协议的参数值，并注释了意义</p><blockquote><p>InitialBytesToStrip = 0, //读取时需要跳过的字节数<br>LengthAdjustment = -5, //包实际长度的纠正，如果包长包括包头和包体，则要减去Length之前的部分<br>LengthFieldLength = 4, //长度字段的字节数 整型为4个字节<br>LengthFieldOffset = 1, //长度属性的起始（偏移）位<br>MaxFrameLength = int.MaxValue, // 最大包长</p></blockquote><h3>3.4 ChannelHandlerAdapter和SimpleChannelInboundHandler&lt;T&gt;</h3><p>业务处理的常用Handler基类，一般客户端和服务端的业务处理handler 都要继承这个这两个类，其中SimpleChannelInboundHandler&lt;T&gt;是ChannelHandlerAdapter的子类，对其简单的进行封装，并进行了类型检查。</p><h3>3.5 IdleStateHandler 链接状态检查handler</h3><p>这个handler一般用于检查链接的状态，比如写超时，读超时。在实际项目中一般在客户端添加它，并用于发送心跳包。</p><p>以下是DotBPE在客户端管道中 第一个添加IdleStateHandler 并设置触发时间</p><p></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">var bootstrap = new Bootstrap();</span><br><span class="line">           bootstrap</span><br><span class="line">               .Channel&lt;TcpSocketChannel&gt;()</span><br><span class="line">               .Option(ChannelOption.TcpNodelay, true)</span><br><span class="line">               .Option(ChannelOption.ConnectTimeout, TimeSpan.FromSeconds(3))</span><br><span class="line">               .Group(new MultithreadEventLoopGroup())</span><br><span class="line">               .Handler(new ActionChannelInitializer&lt;ISocketChannel&gt;(c =&gt;</span><br><span class="line">               &#123;</span><br><span class="line">                   var pipeline = c.Pipeline;</span><br><span class="line">                   pipeline.AddLast(new LoggingHandler(&quot;CLT-CONN&quot;));</span><br><span class="line">                   MessageMeta meta = _msgCodecs.GetMessageMeta();</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">                   // IdleStateHandler</span><br><span class="line">                   pipeline.AddLast(&quot;timeout&quot;, new IdleStateHandler(0, 0, meta.HeartbeatInterval / 1000));</span><br><span class="line">                   //消息前处理</span><br><span class="line">                   pipeline.AddLast(</span><br><span class="line">                       new LengthFieldBasedFrameDecoder(</span><br><span class="line">                           meta.MaxFrameLength,</span><br><span class="line">                           meta.LengthFieldOffset,</span><br><span class="line">                           meta.LengthFieldLength,</span><br><span class="line">                           meta.LengthAdjustment,</span><br><span class="line">                           meta.InitialBytesToStrip</span><br><span class="line">                       )</span><br><span class="line">                   );</span><br><span class="line"></span><br><span class="line">                   pipeline.AddLast(new ChannelDecodeHandler&lt;TMessage&gt;(_msgCodecs));</span><br><span class="line">                   pipeline.AddLast(new ClientChannelHandlerAdapter&lt;TMessage&gt;(this));</span><br><span class="line"></span><br><span class="line">               &#125;));</span><br><span class="line">           return bootstrap;</span><br></pre></td></tr></table></figure><p></p><p>然后在业务处理handler中处理UserEventTriggered事件</p><p></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">//ChannelHandlerAdapter 重写UserEventTriggered</span><br><span class="line">public override void UserEventTriggered(IChannelHandlerContext context, object evt)&#123;</span><br><span class="line">  if(evt is IdleStateEvent)&#123;</span><br><span class="line">     var eventState = evt as IdleStateEvent;</span><br><span class="line">     if(eventState !=null)&#123;</span><br><span class="line">	    this._bootstrap.SendHeartbeatAsync(context,eventState);</span><br><span class="line">     &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><p>更多细节可以参考 《<a href="https://www.gitbook.com/book/waylau/netty-4-user-guide/details" target="_blank" rel="noopener">Netty 4.x 用户指南</a>》</p></div><footer class="post-footer"><div class="post-eof"></div></footer></div></article><article class="post post-type-normal" itemscope itemtype="http://schema.org/Article"><div class="post-block"><link itemprop="mainEntityOfPage" href="https://xuanye.github.io/a-dotnet-core-rpc-sln-dotbpe-quickstart/"><span hidden itemprop="author" itemscope itemtype="http://schema.org/Person"><meta itemprop="name" content="Xuanye"><meta itemprop="description" content><meta itemprop="image" content="/uploads/avatar.png"></span><span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content="假正经哥哥"></span><header class="post-header"><h2 class="post-title" itemprop="name headline"><a class="post-title-link" href="/a-dotnet-core-rpc-sln-dotbpe-quickstart/" itemprop="url">基于DotNet Core的RPC框架(一) DotBPE.RPC快速开始</a></h2><div class="post-meta"><span class="post-time"><span class="post-meta-item-icon"><i class="fa fa-calendar-o"></i> </span><span class="post-meta-item-text">Posted on</span> <time title="Post created" itemprop="dateCreated datePublished" datetime="2017-05-15T20:01:07+08:00">2017-05-15</time> </span><span class="post-category"><span class="post-meta-divider">|</span> <span class="post-meta-item-icon"><i class="fa fa-folder-o"></i> </span><span class="post-meta-item-text">In</span> <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/原创/" itemprop="url" rel="index"><span itemprop="name">原创</span></a></span></span></div></header><div class="post-body" itemprop="articleBody"><h2>0x00 简介</h2><p>DotBPE.RPC是一款基于dotnet core编写的RPC框架，而它的爸爸DotBPE，目标是实现一个开箱即用的微服务框架，但是它还差点意思，还仅仅在构思和尝试的阶段。但不管怎么说RPC是微服务的基础，先来讲讲RPC的实现吧。DotBPE.RPC底层通信默认实现基于<a href="https://github.com/Azure/DotNetty" target="_blank" rel="noopener">DotNetty</a>，这是由微软Azure团队开发的C#的Netty实现，非常酷。当然你也可以替换成其他Socket通信组件。DotBPE.RPC使用的默认协议名称叫Amp,编解码使用谷歌的Protobuf3,不过这些默认实现都是可以替换的。</p><p>源码地址：<a href="https://github.com/xuanye/dotbpe.git" target="_blank" rel="noopener">https://github.com/xuanye/dotbpe.git</a></p><p>&lt;!-- more --&gt;</p><h2>0x01 关于Amp协议和Google Protobuf</h2><h3>Amp(A Message Protocol)</h3><p>Amp(A Message Protocol) ,中文名叫 <code>一个消息协议</code> ,是DotBPE.RPC默认实现的消息协议，在实际开发中，其实是不需要了解消息是如何编解码和传输的，但是了解协议有助于进一步了解框架。协议基本结构如下图所示:</p><p></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">      0        1 2 3 4   5 6 7 8     9     10 11     12 13   &lt;length&gt;-14</span><br><span class="line">+------------+----------+---------+------+-------+---------+------------+</span><br><span class="line">| &lt;ver/argc&gt; | &lt;length&gt; |  &lt;seq&gt;  |&lt;type&gt;|&lt;serId&gt;| &lt;msgid&gt; |   &lt;data&gt;   |</span><br><span class="line">+------------+----------+---------+------+-------+---------+------------+</span><br></pre></td></tr></table></figure><p></p><p>Amp协议默认消息头长为14个字节，不包含扩展包头<br>第0位：ver/argc // 为版本号，暂时来说，默认为0<br>第1-4位: length //为包总长度（含包头长度）<br>第5-8位: sequence // 为消息序列号，通过该序列号对应 请求&lt;---&gt;响应 第9位: type // 消息类型，现值有5种，如下:</p><blockquote><p>Request = 1, Response = 2, Notify = 3,NotFound = 4, ERROR = 5<br>第10-11位: serviceId//消息ID ushort类型<br>第12-13位: msgId//消息ID ushort类型<br>在Amp协议中，serviceId标识一类请求，类似应用中的模块，而msgId标识模块中的具体方法</p></blockquote><p>其后紧跟实际的数据</p><h3>Google Protobuf</h3><p>Google Protocol Buffer( 简称 Protobuf) 是 Google 公司内部的混合语言数据标准，目前已经正在使用的有超过 48,162 种报文格式定义和超过 12,183 个 .proto 文件。他们用于 RPC 系统和持续数据存储系统。</p><p>Protocol Buffers 是一种轻便高效的结构化数据存储格式，可以用于结构化数据串行化，或者说序列化。它很适合做数据存储或 RPC 数据交换格式。可用于通讯协议、数据存储等领域的语言无关、平台无关、可扩展的序列化结构数据格式。目前提供了 多种语言的API，包括C++、 C# 、GO、 JAVA、 PYTHON</p><p>我在之前的博客<a href="http://xuanye.github.io/2017/04/23/write-google-protobuf-plugin-with-csharp/">使用CSharp编写Google Protobuf插件</a>中有过介绍如果通过编写插件的方式，来通过定义proto文件，并生成我们需要的代码。</p><p>在DotBPE.RPC 中，我使用protobuf来作为服务的描述文件，并通过自定义的插件方式来生成服务端和客户端代理类。</p><h2>0x02 快速开始</h2><h3>0. 前提</h3><blockquote><p>因为DotBPE是基于dotnet core开发的，你本地必须已经有了dotnet core开发环境<br>使用github托管代码，所以你必须已经安装了git客户端<br>需要通过protoc生成模板代码，所以你必须已经安装了google protobuf命令行工具</p></blockquote><h3>1. 下载示例程序</h3><p>为了能够解释我们的快速开始程序，你需要一份本地能够运行的示例代码。从github上下载我已经写好的示例代码，可以让你快速的搭建程序，免去一些繁琐，但是又必须的步骤。</p><p></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&gt;$ # Clone the repository to get the example code:    </span><br><span class="line">&gt;$ git clone https://github.com/xuanye/dotbpe-sample.git  </span><br><span class="line">&gt;$ cd dotbpe-sample</span><br></pre></td></tr></table></figure><p></p><p>使用VS2017，或者VSCode打开下载好的代码，目录结构如下所示： <img src="http://ww1.sinaimg.cn/large/697065c1gy1ffm9r259j1j20bw0dmq3f.jpg" alt="代码结构"></p><p>如果你使用VS2017 可以自动帮你还原，如果使用VSCode的话 ，需要运行<code>dotnet restore</code> 下载依赖，成功后使用<code>dotnet build</code> 编译一下看看结果：看着很完美 <img src="http://ww1.sinaimg.cn/large/697065c1gy1ffm9ves29zj20qw08jweu.jpg" alt="编译结果"></p><h3>2. 运行程序</h3><h4>运行Server</h4><p></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&gt;$ cd HelloDotBPE.Server   </span><br><span class="line">&gt;$ dotnet run</span><br></pre></td></tr></table></figure><p></p><h4>运行Client</h4><p></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&gt;$ cd HelloDotBPE.Client   </span><br><span class="line">&gt;$ dotnet run</span><br></pre></td></tr></table></figure><p></p><p>恭喜！已经使用DotBPE.RPC运行一个Server/Client的应用程序。</p><h3>3. 来一起看一下代码吧</h3><h4>3.1 服务描述文件proto</h4><p>首先是DotBPE.RPC框架中对proto的扩展文件，所有的项目都需要这个文件，关于如何扩展proto，我的这篇<a href="http://xuanye.github.io/2017/04/23/write-google-protobuf-plugin-with-csharp/">博客</a>有比较详细的介绍,这里就不重复说了</p><p></p><figure class="highlight protobuf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//dotbpe_option.proto 文件</span></span><br><span class="line"></span><br><span class="line">syntax = <span class="string">"proto3"</span>;</span><br><span class="line"><span class="keyword">package</span> dotbpe;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">option</span> csharp_namespace = <span class="string">"DotBPE.ProtoBuf"</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> <span class="string">"google/protobuf/descriptor.proto"</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">//扩展服务</span></span><br><span class="line">extend google.protobuf.ServiceOptions &#123;</span><br><span class="line">  <span class="built_in">int32</span> service_id = <span class="number">51001</span>;</span><br><span class="line">  <span class="built_in">bool</span> disable_generic_service_client = <span class="number">51003</span>; <span class="comment">//禁止生成客户端代码</span></span><br><span class="line">  <span class="built_in">bool</span> disable_generic_service_server = <span class="number">51004</span>; <span class="comment">//禁止生成服务端代码</span></span><br><span class="line">&#125;</span><br><span class="line">extend google.protobuf.MethodOptions &#123;</span><br><span class="line">  <span class="built_in">int32</span> message_id = <span class="number">51002</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">extend google.protobuf.FileOptions &#123;</span><br><span class="line">  <span class="built_in">bool</span> disable_generic_services_client = <span class="number">51003</span>; <span class="comment">//禁止生成客户端代码</span></span><br><span class="line">  <span class="built_in">bool</span> disable_generic_services_server = <span class="number">51004</span>; <span class="comment">//禁止生成服务端代码</span></span><br><span class="line">  <span class="built_in">bool</span> generic_markdown_doc = <span class="number">51005</span>; <span class="comment">//是否生成文档 本示例中无用</span></span><br><span class="line">  <span class="built_in">bool</span> generic_objectfactory = <span class="number">51006</span>; <span class="comment">//是否生成objectfactory 本示例中无用</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><p>下面的服务描述文件 <code>greeter.proto</code> 才是真正的示例的服务描述文件：比较简单，定义一个Greeter Rpc服务，并定义一个Hello的方法</p><p></p><figure class="highlight protobuf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//greeter.proto</span></span><br><span class="line">syntax = <span class="string">"proto3"</span>;</span><br><span class="line"><span class="keyword">package</span> dotbpe;</span><br><span class="line"></span><br><span class="line"><span class="keyword">option</span> csharp_namespace = <span class="string">"HelloDotBPE.Common"</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 引入扩展</span></span><br><span class="line"><span class="keyword">import</span> public <span class="string">"dotbpe_option.proto"</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 定义一个服务</span></span><br><span class="line"><span class="class"><span class="keyword">service</span> <span class="title">Greeter</span> </span>&#123;</span><br><span class="line">  <span class="keyword">option</span> (service_id)= <span class="number">100</span> ;<span class="comment">//消息ID，全局必须唯一</span></span><br><span class="line">  <span class="comment">// Sends a greeting</span></span><br><span class="line">  <span class="function"><span class="keyword">rpc</span> Hello (HelloRequest) <span class="keyword">returns</span> (HelloResponse) &#123;</span></span><br><span class="line"><span class="function">    option (message_id)= 1 </span>;<span class="comment">//设定消息ID，同一服务内唯一</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// The request message containing the user's name.</span></span><br><span class="line"><span class="class"><span class="keyword">message</span> <span class="title">HelloRequest</span> </span>&#123;</span><br><span class="line">  <span class="built_in">string</span> name = <span class="number">1</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// The response message containing the greetings</span></span><br><span class="line"><span class="class"><span class="keyword">message</span> <span class="title">HelloResponse</span> </span>&#123;</span><br><span class="line">  <span class="built_in">string</span> <span class="class"><span class="keyword">message</span> = 1;</span></span><br><span class="line"><span class="class">&#125;</span></span><br></pre></td></tr></table></figure><p></p><p>通过protoc工具生成模板代码，示例中的代码生成到了 HelloDotBPE.Common_g 目录下，本地可以运行shell命令的同学可以直接到 dotbpe-sample\script\generate 目录运行<code>sh generate_hello.sh</code> （windows下一般安装cgywin），不能运行的同学也可以在HelloDotBPE目录下，直接运行命令行</p><p></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">protoc -I=../protos --csharp_out=./HelloDotBPE.Common/_g/ --dotbpe_out=./HelloDotBPE.Common/_g/   ../protos/dotbpe_option.proto ../protos/greeter.proto  --plugin=protoc-gen-dotbpe=../../tool/protoc_plugin/Protobuf.Gen.exe</span><br></pre></td></tr></table></figure><p></p><p>当然我还是建议大家安装以下cgywin运行环境，可以运行unix上的一些常用命令。同时在部署到正式环境的时候可以公用开发环境的一些脚本。</p><h4>3.2 服务端代码</h4><p>服务实现：</p><p></p><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 服务实现代码</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">GreeterImpl</span> : <span class="title">GreeterBase</span> </span><br><span class="line">&#123; </span><br><span class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">override</span> Task&lt;HelloResponse&gt; <span class="title">HelloAsync</span>(<span class="params">HelloRequest request</span>)</span></span><br><span class="line"><span class="function"></span>   &#123;</span><br><span class="line">		<span class="comment">// 直接返回Hello Name</span></span><br><span class="line">       <span class="keyword">return</span> Task.FromResult(<span class="keyword">new</span> HelloResponse() &#123; Message = <span class="string">"Hello "</span> + request.Name &#125;);</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><p>服务端启动类</p><p></p><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">Startup</span> : <span class="title">IStartup</span></span><br><span class="line">   &#123;</span><br><span class="line">      </span><br><span class="line">       <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">Configure</span>(<span class="params">IAppBuilder app, IHostingEnvironment env</span>)</span></span><br><span class="line"><span class="function"></span>       &#123;</span><br><span class="line">          </span><br><span class="line">       &#125;</span><br><span class="line"></span><br><span class="line">       <span class="function"><span class="keyword">public</span> IServiceProvider <span class="title">ConfigureServices</span>(<span class="params">IServiceCollection services</span>)</span></span><br><span class="line"><span class="function"></span>       &#123;</span><br><span class="line">           services.AddDotBPE(); <span class="comment">// 添加DotBPE.RPC的核心依赖</span></span><br><span class="line">           services.AddServiceActors&lt;AmpMessage&gt;(actors =&gt; &#123;</span><br><span class="line">               actors.Add&lt;GreeterImpl&gt;(); <span class="comment">// 注册服务实现</span></span><br><span class="line">           &#125;);</span><br><span class="line"></span><br><span class="line">           <span class="keyword">return</span> services.BuildServiceProvider();</span><br><span class="line">       &#125;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure><p></p><p>启动服务端</p><p></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">class Program</span><br><span class="line"> &#123;</span><br><span class="line">     static void Main(string[] args)</span><br><span class="line">     &#123;</span><br><span class="line">         Console.OutputEncoding = System.Text.Encoding.UTF8;</span><br><span class="line"></span><br><span class="line">         //在控制台输出调试日志</span><br><span class="line">         DotBPE.Rpc.Environment.SetLogger(new DotBPE.Rpc.Logging.ConsoleLogger());</span><br><span class="line"></span><br><span class="line">         var host = new RpcHostBuilder()</span><br><span class="line">             .UseServer(&quot;0.0.0.0:6201&quot;) //绑定本地端口6201</span><br><span class="line">             .UseStartup&lt;Startup&gt;()</span><br><span class="line">             .Build();</span><br><span class="line"></span><br><span class="line">         host.StartAsync().Wait();</span><br><span class="line"></span><br><span class="line">         Console.WriteLine(&quot;Press any key to quit!&quot;);</span><br><span class="line">         Console.ReadKey();</span><br><span class="line"></span><br><span class="line">         host.ShutdownAsync().Wait();</span><br><span class="line"></span><br><span class="line">     &#125;</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure><p></p><h4>3.3 客户端代码</h4><p></p><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title">Program</span></span><br><span class="line">   &#123;</span><br><span class="line">       <span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">Main</span>(<span class="params"><span class="keyword">string</span>[] args</span>)</span></span><br><span class="line"><span class="function"></span>       &#123;</span><br><span class="line">           Console.OutputEncoding = Encoding.UTF8;</span><br><span class="line"></span><br><span class="line">           <span class="keyword">var</span> client = AmpClient.Create(<span class="string">"127.0.0.1:6201"</span>); <span class="comment">//建立链接通道</span></span><br><span class="line">           <span class="keyword">var</span> greeter = <span class="keyword">new</span> GreeterClient(client); <span class="comment">//客户端代理类</span></span><br><span class="line">          </span><br><span class="line">           <span class="keyword">while</span> (<span class="literal">true</span>)</span><br><span class="line">           &#123;</span><br><span class="line">               Console.WriteLine(<span class="string">"input your name and press enter:"</span>);</span><br><span class="line">               <span class="keyword">string</span> name = Console.ReadLine();</span><br><span class="line">               <span class="keyword">if</span> (<span class="string">"bye"</span>.Equals(name))</span><br><span class="line">               &#123;</span><br><span class="line">                   <span class="keyword">break</span>;</span><br><span class="line">               &#125;</span><br><span class="line">               <span class="keyword">try</span></span><br><span class="line">               &#123;</span><br><span class="line">                   <span class="keyword">var</span> request = <span class="keyword">new</span> HelloRequest() &#123; Name = name &#125;;</span><br><span class="line">                   <span class="keyword">var</span> result = greeter.HelloAsync(request).Result;                  </span><br><span class="line">                   Console.WriteLine(<span class="string">$"---------------receive form server:<span class="subst">&#123;result.Message&#125;</span>-----------"</span>);</span><br><span class="line">                                   </span><br><span class="line">               &#125;</span><br><span class="line">               <span class="keyword">catch</span> (Exception ex)</span><br><span class="line">               &#123;</span><br><span class="line">                   Console.WriteLine(<span class="string">"发生错误："</span> + ex.Message);</span><br><span class="line">               &#125;</span><br><span class="line">           &#125;</span><br><span class="line">           Console.WriteLine(<span class="string">$"---------------close connection-----------"</span>);</span><br><span class="line">           client.CloseAsync();</span><br><span class="line">       &#125;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure><p></p><h3>0x03 下一步</h3><p>下一篇 我将详细讲述DotBPE.RPC中的主要类和调用关系，并介绍如何使用DotNetty实现RPC通信。 事实上我正在编写一个更加复杂的示例<a href="https://github.com/xuanye/PiggyMetrics.git" target="_blank" rel="noopener">https://github.com/xuanye/PiggyMetrics.git</a>， 这原是spring cloud的一个示例程序，我使用DotBPE进行改造，用示例描述DotBPE在真实场景中的应用。包括服务注册和发现，服务间调用，公开HttpApi，监控检查等功能，并通过实践进一步完善DotBPE。初步的功能已经实现，不过还没来的及写文档。该系列的后面将详细描述该系统的实现。</p></div><footer class="post-footer"><div class="post-eof"></div></footer></div></article><article class="post post-type-normal" itemscope itemtype="http://schema.org/Article"><div class="post-block"><link itemprop="mainEntityOfPage" href="https://xuanye.github.io/write-google-protobuf-plugin-with-csharp/"><span hidden itemprop="author" itemscope itemtype="http://schema.org/Person"><meta itemprop="name" content="Xuanye"><meta itemprop="description" content><meta itemprop="image" content="/uploads/avatar.png"></span><span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content="假正经哥哥"></span><header class="post-header"><h2 class="post-title" itemprop="name headline"><a class="post-title-link" href="/write-google-protobuf-plugin-with-csharp/" itemprop="url">使用CSharp编写Google Protobuf插件</a></h2><div class="post-meta"><span class="post-time"><span class="post-meta-item-icon"><i class="fa fa-calendar-o"></i> </span><span class="post-meta-item-text">Posted on</span> <time title="Post created" itemprop="dateCreated datePublished" datetime="2017-04-23T18:01:07+08:00">2017-04-23</time> </span><span class="post-category"><span class="post-meta-divider">|</span> <span class="post-meta-item-icon"><i class="fa fa-folder-o"></i> </span><span class="post-meta-item-text">In</span> <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/原创/" itemprop="url" rel="index"><span itemprop="name">原创</span></a></span></span></div></header><div class="post-body" itemprop="articleBody"><p>什么是 Google Protocol Buffer？</p><p>Google Protocol Buffer( 简称 Protobuf) 是 Google 公司内部的混合语言数据标准，目前已经正在使用的有超过 48,162 种报文格式定义和超过 12,183 个 .proto 文件。他们用于 RPC 系统和持续数据存储系统。</p><p>Protocol Buffers 是一种轻便高效的结构化数据存储格式，可以用于结构化数据串行化，或者说序列化。它很适合做数据存储或 RPC 数据交换格式。可用于通讯协议、数据存储等领域的语言无关、平台无关、可扩展的序列化结构数据格式。目前提供了 多种语言的API，包括C++、 C# 、GO、 JAVA、 PYTHON</p><p>如果你并不了解Protobuf能做什么，建议结合google搜索关键字，看一下入门级别的文章，或者看一下官方文档中的<a href="https://developers.google.com/protocol-buffers/docs/overview" target="_blank" rel="noopener">Developer Guide</a>，或者中文的<a href="http://www.jianshu.com/p/3ab14a2cb477" target="_blank" rel="noopener">开发指南</a> .官方的文档中有各种语言相关的示例，可以结合代码看一下实际的用法。</p><p>很多人说为什么不用json（或者xml), 答案很简单，Protobuf更小，更简洁，而且序列化和反序列化更快！</p><p>谷歌最新开源的<a href="http://www.grpc.io" target="_blank" rel="noopener">gRpc</a>框架就是默认使用Protobuf作为数据传输格式和服务描述文件。对于gRpc 就不做详细介绍了，有兴趣的可以看一下官网。</p><p>言归正传，在实际使用Protobuf过程中，我发现Protobuf不但可以编写描述消息（Message）的内容，同时可以表述其他方法（类似Rpc中的方法），主要是gRpc中看到的。同时在Protobuf 代码生成工具的包中，有一个这样的目录，一致以来都没搞明白是做什么用的，如下图：</p><p><img src="http://ww1.sinaimg.cn/large/697065c1gy1fevjc4j16qj20cs0aadgf.jpg" alt></p><p>在目录中存在大量已经定义好的proto文件，其实这些文件是Protobuf的描述文件，类似元数据。用本身的语法描述本身，同时通过这些文件生成对应的语言的元数据类等代码，比如在C#版本的Google.Protobuf中就能看到上述描述文件生成的类，如下图所示</p><p><img src="http://ww1.sinaimg.cn/large/697065c1gy1fevjf70qswj20fe0e0q40.jpg" alt></p><p>而这些描述文件中最重要的文件 就是<code>descriptor.proto</code> 这个文件，这个文件是整个proto语法的描述类，描述了实际Protobuf各层次语法的结构，来一起看一下这个文件的一些代码, 上面这个代码描述了proto文件定义的语法定义，如前面两个字段意思是可选的name，可选的package字段，中间是描述可多个message_type（Message），service（Rpc Service) ,enum_type（枚举）等定义，然后一层层分解下去。 基本上就可以了解Protobuf语法的全貌和扩展点了</p><p>&lt;!-- more --&gt;</p><p></p><figure class="highlight protobuf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">message</span> <span class="title">FileDescriptorProto</span> </span>&#123;</span><br><span class="line">  <span class="keyword">optional</span> <span class="built_in">string</span> name = <span class="number">1</span>;       <span class="comment">// file name, relative to root of source tree</span></span><br><span class="line">  <span class="keyword">optional</span> <span class="built_in">string</span> <span class="keyword">package</span> = <span class="number">2</span>;    <span class="comment">// e.g. "foo", "foo.bar", etc.</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// Names of files imported by this file.</span></span><br><span class="line">  <span class="keyword">repeated</span> <span class="built_in">string</span> dependency = <span class="number">3</span>;</span><br><span class="line">  <span class="comment">// Indexes of the public imported files in the dependency list above.</span></span><br><span class="line">  <span class="keyword">repeated</span> <span class="built_in">int32</span> public_dependency = <span class="number">10</span>;</span><br><span class="line">  <span class="comment">// Indexes of the weak imported files in the dependency list.</span></span><br><span class="line">  <span class="comment">// For Google-internal migration only. Do not use.</span></span><br><span class="line">  <span class="keyword">repeated</span> <span class="built_in">int32</span> weak_dependency = <span class="number">11</span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// All top-level definitions in this file.</span></span><br><span class="line">  <span class="keyword">repeated</span> DescriptorProto message_type = <span class="number">4</span>;</span><br><span class="line">  <span class="keyword">repeated</span> EnumDescriptorProto enum_type = <span class="number">5</span>;</span><br><span class="line">  <span class="keyword">repeated</span> ServiceDescriptorProto <span class="class"><span class="keyword">service</span> = 6;</span></span><br><span class="line"><span class="class">  <span class="title">repeated</span> FieldDescriptorProto extension = 7;</span></span><br><span class="line"><span class="class"></span></span><br><span class="line"><span class="class">  optional FileOptions options = 8;</span></span><br><span class="line"><span class="class"></span></span><br><span class="line"><span class="class">  // This field contains optional information about the original source code.</span></span><br><span class="line"><span class="class">  // You may safely remove this entire field without harming runtime</span></span><br><span class="line"><span class="class">  // functionality of the descriptors -- the information is needed only by</span></span><br><span class="line"><span class="class">  // development tools.</span></span><br><span class="line"><span class="class">  optional SourceCodeInfo source_code_info = 9;</span></span><br><span class="line"><span class="class"></span></span><br><span class="line"><span class="class">  // The syntax of the proto file.</span></span><br><span class="line"><span class="class">  // The supported values are "proto2" and "proto3".</span></span><br><span class="line"><span class="class">  optional string syntax = 12;</span></span><br><span class="line"><span class="class">&#125;</span></span><br></pre></td></tr></table></figure><p></p><p>同时在compiler目录下 还有一个plugin的目录，其中的plugin.proto文件很耐人寻味，先来看下这个文件中的内容</p><p></p><figure class="highlight protobuf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">syntax = <span class="string">"proto3"</span>;</span><br><span class="line"><span class="keyword">package</span> google.protobuf.compiler;</span><br><span class="line"><span class="keyword">option</span> java_package = <span class="string">"com.google.protobuf.compiler"</span>;</span><br><span class="line"><span class="keyword">option</span> java_outer_classname = <span class="string">"PluginProtos"</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">option</span> csharp_namespace = <span class="string">"Google.Protobuf.Compiler"</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">option</span> go_package = <span class="string">"plugin_go"</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> <span class="string">"google/protobuf/descriptor.proto"</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">message</span> <span class="title">CodeGeneratorRequest</span> </span>&#123;</span><br><span class="line">  <span class="keyword">repeated</span> <span class="built_in">string</span> file_to_generate = <span class="number">1</span>;</span><br><span class="line">  <span class="built_in">string</span> parameter = <span class="number">2</span>;</span><br><span class="line">  <span class="keyword">repeated</span> FileDescriptorProto proto_file = <span class="number">15</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">message</span> <span class="title">CodeGeneratorResponse</span> </span>&#123;  </span><br><span class="line">  <span class="built_in">string</span> error = <span class="number">1</span>; </span><br><span class="line">  <span class="class"><span class="keyword">message</span> <span class="title">File</span> </span>&#123;    </span><br><span class="line">    <span class="built_in">string</span> name = <span class="number">1</span>;</span><br><span class="line">    <span class="built_in">string</span> insertion_point = <span class="number">2</span>;</span><br><span class="line">    <span class="built_in">string</span> content = <span class="number">15</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">repeated</span> File file = <span class="number">15</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><p>删除了非必要的注释后，我们可以看到这个文件里面其实只定义了两个类型，一个是代码生成请求，一个是代码生成响应，而在<code>CodeGeneratorRequest</code>中又有之前我们在<code>descriptor.proto</code>中看到的<code>FileDescriptorProto</code> 这个类的信息，用大腿都可以想到这里应该就是代码生成插件获取元数据的入口了，那么怎么做呢？</p><p>从gRpc 的代码生成示例中 我们可以看到 其实Protobuf是支持自定义生成代码插件的，如下所示：</p><p></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">%</span>PROTOC% -I../../protos --csharp_out Greeter  ../../protos/helloworld.proto --grpc_out Greeter --plugin=protoc-gen-grpc=%PLUGIN%</span><br></pre></td></tr></table></figure><p></p><p>按理我们可以实现自己的插件来生成我们需要的任意格式，包括各种代码，甚至是文档。但是这个资料却非常少，几乎没有多少相关的文章，后来终于找到一片关于plugin的文章<a href="http://www.expobrain.net/2015/09/13/create-a-plugin-for-google-protocol-buffer/" target="_blank" rel="noopener">http://www.expobrain.net/2015/09/13/create-a-plugin-for-google-protocol-buffer/</a> ，大家有兴趣的可以看看，不过文章的重点是这句：</p><blockquote><p>The core part is the interface code to read a request from the <code>stdin</code>, traverse the AST and write the response on the <code>stdout</code>.</p></blockquote><p>原来插件的接口代码其实是从标准输入中读取流，然后再把你要生成的内容输出到标准输出中。这些终于知道怎么用了。。</p><p>撩起袖子开始干，通过protoc命令行生成plugin.proto的代码</p><p></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">protoc-I../../protos --csharp_out test  ../../protos/plugin.proto</span><br></pre></td></tr></table></figure><p></p><p>新建一个控制台项目，把代码copy 到项目中，并在Program.cs代码中添加测试的代码</p><p></p><figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> Google.Protobuf;</span><br><span class="line"><span class="keyword">using</span> Google.Protobuf.Compiler;</span><br><span class="line"><span class="keyword">using</span> System;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">DotBPE.ProtobufPlugin</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">class</span> <span class="title">Program</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">Main</span>(<span class="params"><span class="keyword">string</span>[] args</span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            Console.OutputEncoding = System.Text.Encoding.UTF8;</span><br><span class="line">            <span class="keyword">var</span> response = <span class="keyword">new</span> CodeGeneratorResponse();</span><br><span class="line">            <span class="keyword">try</span></span><br><span class="line">            &#123;</span><br><span class="line">                CodeGeneratorRequest request;</span><br><span class="line">                <span class="keyword">using</span> (<span class="keyword">var</span> inStream = Console.OpenStandardInput())</span><br><span class="line">                &#123;</span><br><span class="line">                    request = CodeGeneratorRequest.Parser.ParseFrom(inStream);</span><br><span class="line">                &#125;</span><br><span class="line">                ParseCode(request, response);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">catch</span> (Exception e)</span><br><span class="line">            &#123;</span><br><span class="line">                response.Error += e.ToString();</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">using</span> (<span class="keyword">var</span> output = Console.OpenStandardOutput())</span><br><span class="line">            &#123;</span><br><span class="line">                response.WriteTo(output);</span><br><span class="line">                output.Flush();</span><br><span class="line"></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">ParseCode</span>(<span class="params">CodeGeneratorRequest request, CodeGeneratorResponse response</span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">           DotbpeGen.Generate(request,response);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><p>哈哈 开始编译，然而编译不通过！，坑爹啊！ 原来C#版本中 Google.Protobuf已经生成好的类 都是internal访问权限，不能从外部引用。。。但是Google.Protobuf是开源的。。而且我需要用的类 我也可以通过protoc命令自己生成到同一个项目中，或者设置成public访问权限。。方便起见，我直接copy了Google.Protobuf的源码到我们的项目中，这次再次编译 ，代码就完美运行了，接下来的工作 不过是填充<code>DotbpeGen.Generate</code> 的代码了，这不过是体力活。</p><p>至于CodeGeneratorRequest和CodeGeneratorResponse 到底有什么方法，其实看proto文件就能知道。以下是我自己在项目中使用的生成代码类 供大家参考</p><p></p><figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> Google.Protobuf.Compiler;</span><br><span class="line"><span class="keyword">using</span> Google.Protobuf.Reflection;</span><br><span class="line"><span class="keyword">using</span> System;</span><br><span class="line"><span class="keyword">using</span> System.Collections.Generic;</span><br><span class="line"><span class="keyword">using</span> System.IO;</span><br><span class="line"><span class="keyword">using</span> System.Linq;</span><br><span class="line"><span class="keyword">using</span> System.Text;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">DotBPE.ProtobufPlugin</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title">DotbpeGen</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">Generate</span>(<span class="params">CodeGeneratorRequest request, CodeGeneratorResponse response</span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            <span class="keyword">foreach</span> (<span class="keyword">var</span> protofile <span class="keyword">in</span> request.ProtoFile)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">try</span>&#123;</span><br><span class="line">                    GenerateByProtoFile(protofile, response);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">catch</span>(Exception ex)&#123;</span><br><span class="line">                    <span class="keyword">using</span> (Stream stream = File.Create(<span class="string">"./error.txt"</span>))</span><br><span class="line">                    &#123;</span><br><span class="line">                        <span class="keyword">byte</span>[] err = Encoding.UTF8.GetBytes(ex.Message+ex.StackTrace);</span><br><span class="line">                        stream.Write(err,<span class="number">0</span>,err.Length);</span><br><span class="line">                    &#125;</span><br><span class="line">                    response.Error += ex.Message;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">GenerateSourceInfo</span>(<span class="params">FileDescriptorProto protofile, CodeGeneratorResponse response</span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            <span class="keyword">bool</span> genericDoc;</span><br><span class="line">            protofile.Options.CustomOptions.TryGetBool(DotBPEOptions.GENERIC_MARKDOWN_DOC,<span class="keyword">out</span> genericDoc);</span><br><span class="line">            <span class="keyword">if</span> (!genericDoc)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            StringBuilder sb = <span class="keyword">new</span> StringBuilder();</span><br><span class="line">            <span class="keyword">foreach</span> (<span class="keyword">var</span> location <span class="keyword">in</span> protofile.SourceCodeInfo.Location)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">string</span> path = String.Join(<span class="string">","</span>, location.Path);</span><br><span class="line">                <span class="keyword">string</span> span = String.Join(<span class="string">","</span>, location.Span);</span><br><span class="line">                <span class="keyword">string</span> leadingDetachedComments = String.Join(<span class="string">"\r"</span>, location.LeadingDetachedComments);</span><br><span class="line">                <span class="keyword">string</span> trailingComments = String.Join(<span class="string">"\r"</span>, location.TrailingComments);</span><br><span class="line">                sb.AppendLine(<span class="string">"&#123;\"Path\",\""</span>+path+<span class="string">"\",\"Span\",\""</span>+span+<span class="string">"\",\"LeadingComments\",\""</span>+ location.LeadingComments + <span class="string">"\",\"LeadingDetachedComments\",\""</span>+ leadingDetachedComments + <span class="string">"\",\"TrailingComments\",\""</span>+ trailingComments + <span class="string">"\"&#125;"</span>);</span><br><span class="line">                </span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">var</span> nfile = <span class="keyword">new</span> CodeGeneratorResponse.Types.File</span><br><span class="line">            &#123;</span><br><span class="line">                Name = GetFileName(protofile.Name) + <span class="string">"SI.txt"</span>,</span><br><span class="line">                Content = sb.ToString()</span><br><span class="line">            &#125;;</span><br><span class="line">            response.File.Add(nfile);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">GenerateByProtoFile</span>(<span class="params">FileDescriptorProto protofile, CodeGeneratorResponse response</span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            GenerateSourceInfo(protofile, response);</span><br><span class="line">            GenerateServer(protofile, response);</span><br><span class="line">            GenerateClient(protofile, response);</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">GenerateServer</span>(<span class="params">FileDescriptorProto protofile, CodeGeneratorResponse response</span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            <span class="keyword">bool</span> genericServer;</span><br><span class="line">            protofile.Options.CustomOptions.TryGetBool(DotBPEOptions.DISABLE_GENERIC_SERVICES_SERVER, <span class="keyword">out</span> genericServer);</span><br><span class="line">            <span class="keyword">if</span> (genericServer)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (protofile.Service == <span class="literal">null</span> || protofile.Service.Count &lt;= <span class="number">0</span>) <span class="keyword">return</span>;</span><br><span class="line">            <span class="comment">//生成文件头</span></span><br><span class="line">            StringBuilder sb = <span class="keyword">new</span> StringBuilder();</span><br><span class="line">            sb.AppendLine(<span class="string">"// Generated by the protocol buffer compiler.  DO NOT EDIT!"</span>);</span><br><span class="line">            sb.AppendLine(<span class="string">$"// source: <span class="subst">&#123;protofile.Name&#125;</span>"</span>);</span><br><span class="line">            <span class="comment">//还可以生成注释</span></span><br><span class="line"></span><br><span class="line">            sb.AppendLine(<span class="string">"#region Designer generated code"</span>);</span><br><span class="line">            sb.AppendLine(<span class="string">""</span>);</span><br><span class="line">            sb.AppendLine(<span class="string">"using System; "</span>);</span><br><span class="line">            sb.AppendLine(<span class="string">"using System.Threading.Tasks; "</span>);</span><br><span class="line">            sb.AppendLine(<span class="string">"using DotBPE.Rpc; "</span>);</span><br><span class="line">            sb.AppendLine(<span class="string">"using DotBPE.Protocol.Amp; "</span>);</span><br><span class="line">            sb.AppendLine(<span class="string">"using Google.Protobuf; "</span>);</span><br><span class="line">            sb.AppendLine(<span class="string">""</span>);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">string</span> ns = GetFileNamespace(protofile);</span><br><span class="line">            sb.AppendLine(<span class="string">"namespace "</span> + ns + <span class="string">" &#123;"</span>);</span><br><span class="line">            <span class="comment">//生成代码</span></span><br><span class="line">            <span class="keyword">foreach</span> (ServiceDescriptorProto t <span class="keyword">in</span> protofile.Service)</span><br><span class="line">            &#123;</span><br><span class="line">                t.Options.CustomOptions.TryGetBool(DotBPEOptions.DISABLE_GENERIC_SERVICES_SERVER, <span class="keyword">out</span> genericServer);</span><br><span class="line">                <span class="keyword">if</span> (genericServer)</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="keyword">continue</span>;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                sb.AppendLine(<span class="string">""</span>);</span><br><span class="line">                sb.AppendLine(<span class="string">"//start for class Abstract"</span>+t.Name);</span><br><span class="line">                GenerateServiceForServer(t, sb);</span><br><span class="line">                sb.AppendLine(<span class="string">"//end for class Abstract"</span>+t.Name);</span><br><span class="line">            &#125;</span><br><span class="line">            sb.AppendLine(<span class="string">"&#125;\n"</span>);</span><br><span class="line">            sb.AppendLine(<span class="string">"#endregion\n"</span>);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">var</span> nfile = <span class="keyword">new</span> CodeGeneratorResponse.Types.File</span><br><span class="line">            &#123;</span><br><span class="line">                Name = GetFileName(protofile.Name) + <span class="string">"Server.cs"</span>,</span><br><span class="line">                Content = sb.ToString()</span><br><span class="line">            &#125;;</span><br><span class="line">            response.File.Add(nfile);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">GenerateClient</span>(<span class="params">FileDescriptorProto protofile, CodeGeneratorResponse response</span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            <span class="keyword">bool</span> genericClient;</span><br><span class="line">            protofile.Options.CustomOptions.TryGetBool(DotBPEOptions.DISABLE_GENERIC_SERVICES_CLIENT, <span class="keyword">out</span> genericClient);</span><br><span class="line">            <span class="keyword">if</span> (genericClient)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (protofile.Service == <span class="literal">null</span> || protofile.Service.Count &lt;= <span class="number">0</span>) <span class="keyword">return</span>;</span><br><span class="line">            <span class="comment">//生成文件头</span></span><br><span class="line">            StringBuilder sb = <span class="keyword">new</span> StringBuilder();</span><br><span class="line">            sb.AppendLine(<span class="string">"// Generated by the protocol buffer compiler.  DO NOT EDIT!"</span>);</span><br><span class="line">            sb.AppendLine(<span class="string">$"// source: <span class="subst">&#123;protofile.Name&#125;</span>"</span>);</span><br><span class="line">            <span class="comment">//还可以生成注释</span></span><br><span class="line"></span><br><span class="line">            sb.AppendLine(<span class="string">"#region Designer generated code"</span>);</span><br><span class="line">            sb.AppendLine(<span class="string">""</span>);</span><br><span class="line">            sb.AppendLine(<span class="string">"using System; "</span>);</span><br><span class="line">            sb.AppendLine(<span class="string">"using System.Threading.Tasks; "</span>);</span><br><span class="line">            sb.AppendLine(<span class="string">"using DotBPE.Rpc; "</span>);</span><br><span class="line">            sb.AppendLine(<span class="string">"using DotBPE.Protocol.Amp; "</span>);</span><br><span class="line">            sb.AppendLine(<span class="string">"using DotBPE.Rpc.Exceptions; "</span>);</span><br><span class="line">            sb.AppendLine(<span class="string">"using Google.Protobuf; "</span>);</span><br><span class="line">            sb.AppendLine(<span class="string">""</span>);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">string</span> ns = GetFileNamespace(protofile);</span><br><span class="line">            sb.AppendLine(<span class="string">"namespace "</span> + ns + <span class="string">" &#123;"</span>);</span><br><span class="line">            <span class="comment">//生成代码</span></span><br><span class="line"></span><br><span class="line">            <span class="keyword">foreach</span> (ServiceDescriptorProto t <span class="keyword">in</span> protofile.Service)</span><br><span class="line">            &#123;</span><br><span class="line">                t.Options.CustomOptions.TryGetBool(DotBPEOptions.DISABLE_GENERIC_SERVICES_CLIENT, <span class="keyword">out</span> genericClient);</span><br><span class="line">                <span class="keyword">if</span> (genericClient)</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="keyword">continue</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                sb.AppendLine(<span class="string">""</span>);</span><br><span class="line">                sb.AppendLine(<span class="string">"//start for class "</span>+t.Name+<span class="string">"Client"</span>);</span><br><span class="line">                GenerateServiceForClient(t, sb);</span><br><span class="line">                sb.AppendLine(<span class="string">"//end for class "</span>+t.Name+<span class="string">"Client"</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            sb.AppendLine(<span class="string">"&#125;"</span>);</span><br><span class="line">            sb.AppendLine(<span class="string">"#endregion"</span>);</span><br><span class="line"></span><br><span class="line">            <span class="comment">//生成文件</span></span><br><span class="line">            <span class="keyword">var</span> nfile = <span class="keyword">new</span> CodeGeneratorResponse.Types.File</span><br><span class="line">            &#123;</span><br><span class="line">                Name = GetFileName(protofile.Name) + <span class="string">"Client.cs"</span>,</span><br><span class="line">                Content = sb.ToString()</span><br><span class="line">            &#125;;</span><br><span class="line">            response.File.Add(nfile);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">GenerateServiceForClient</span>(<span class="params">ServiceDescriptorProto service, StringBuilder sb</span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            <span class="keyword">int</span> serviceId;</span><br><span class="line">            <span class="keyword">bool</span> hasServiceId = service.Options.CustomOptions.TryGetInt32(DotBPEOptions.SERVICE_ID, <span class="keyword">out</span> serviceId);</span><br><span class="line">            <span class="keyword">if</span> (!hasServiceId || serviceId &lt;= <span class="number">0</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> Exception(<span class="string">"Service="</span> + service.Name + <span class="string">" ServiceId NOT_FOUND"</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (serviceId &gt;= <span class="keyword">ushort</span>.MaxValue)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> Exception(<span class="string">"Service="</span> + service.Name + <span class="string">"ServiceId too large"</span>);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            sb.AppendFormat(<span class="string">"public sealed class &#123;0&#125;Client : AmpInvokeClient \n"</span>,service.Name);</span><br><span class="line">            sb.AppendLine(<span class="string">"&#123;"</span>);</span><br><span class="line">            <span class="comment">//构造函数</span></span><br><span class="line">            sb.AppendLine(<span class="string">$"public <span class="subst">&#123;service.Name&#125;</span>Client(IRpcClient&lt;AmpMessage&gt; client) : base(client)"</span>);</span><br><span class="line">            sb.AppendLine(<span class="string">"&#123;"</span>);</span><br><span class="line">            sb.AppendLine(<span class="string">"&#125;"</span>);</span><br><span class="line"></span><br><span class="line">            <span class="comment">//循环方法</span></span><br><span class="line">            <span class="keyword">foreach</span> (<span class="keyword">var</span> method <span class="keyword">in</span> service.Method)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">int</span> msgId ;</span><br><span class="line">                <span class="keyword">bool</span> hasMsgId= method.Options.CustomOptions.TryGetInt32(DotBPEOptions.MESSAGE_ID,<span class="keyword">out</span> msgId);</span><br><span class="line">                <span class="keyword">if</span> (!hasMsgId || msgId &lt;= <span class="number">0</span>)</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> Exception(<span class="string">"Service"</span> + service.Name + <span class="string">"."</span> + method.Name + <span class="string">" ' MessageId NOT_FINDOUT "</span>);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">if</span> (msgId &gt;= <span class="keyword">ushort</span>.MaxValue)</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> Exception(<span class="string">"Service"</span> + service.Name + <span class="string">"."</span> + method.Name + <span class="string">" is too large"</span>);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">//异步方法</span></span><br><span class="line">                <span class="keyword">string</span> outType = GetTypeName(method.OutputType);</span><br><span class="line">                <span class="keyword">string</span> inType = GetTypeName(method.InputType);</span><br><span class="line"></span><br><span class="line">                sb.AppendLine(<span class="string">$"public async Task&lt;<span class="subst">&#123;outType&#125;</span>&gt; <span class="subst">&#123;method.Name&#125;</span>Asnyc(<span class="subst">&#123;inType&#125;</span> request,int timeOut=3000)"</span>);</span><br><span class="line">                sb.AppendLine(<span class="string">"&#123;"</span>);</span><br><span class="line">                sb.AppendLine(<span class="string">$"AmpMessage message = AmpMessage.CreateRequestMessage(<span class="subst">&#123;serviceId&#125;</span>, <span class="subst">&#123;msgId&#125;</span>);"</span>);</span><br><span class="line">                sb.AppendLine(<span class="string">"message.Data = request.ToByteArray();"</span>);</span><br><span class="line">                sb.AppendLine(<span class="string">"var response = await base.CallInvoker.AsyncCall(message,timeOut);"</span>);</span><br><span class="line">                sb.AppendLine(<span class="string">"if (response != null &amp;&amp; response.Data !=null)"</span>);</span><br><span class="line">                sb.AppendLine(<span class="string">"&#123;"</span>);</span><br><span class="line">                sb.AppendLine(<span class="string">$"return <span class="subst">&#123;outType&#125;</span>.Parser.ParseFrom(response.Data);"</span>);</span><br><span class="line">                sb.AppendLine(<span class="string">"&#125;"</span>);</span><br><span class="line">                sb.AppendLine(<span class="string">"throw new RpcException(\"请求出错，请检查!\");"</span>);</span><br><span class="line">                sb.AppendLine(<span class="string">"&#125;"</span>);</span><br><span class="line">                sb.AppendLine();</span><br><span class="line">                sb.AppendLine(<span class="string">"//同步方法"</span>);</span><br><span class="line">                sb.AppendLine(<span class="string">$"public <span class="subst">&#123;outType&#125;</span> <span class="subst">&#123;method.Name&#125;</span>(<span class="subst">&#123;inType&#125;</span> request)"</span>);</span><br><span class="line">                sb.AppendLine(<span class="string">"&#123;"</span>);</span><br><span class="line">                sb.AppendLine(<span class="string">$"AmpMessage message = AmpMessage.CreateRequestMessage(<span class="subst">&#123;serviceId&#125;</span>, <span class="subst">&#123;msgId&#125;</span>);"</span>);</span><br><span class="line">                sb.AppendLine(<span class="string">"message.Data = request.ToByteArray();"</span>);</span><br><span class="line">                sb.AppendLine(<span class="string">"var response =  base.CallInvoker.BlockingCall(message);"</span>);</span><br><span class="line">                sb.AppendLine(<span class="string">"if (response != null &amp;&amp; response.Data !=null)"</span>);</span><br><span class="line">                sb.AppendLine(<span class="string">"&#123;"</span>);</span><br><span class="line">                sb.AppendLine(<span class="string">$"return <span class="subst">&#123;outType&#125;</span>.Parser.ParseFrom(response.Data);"</span>);</span><br><span class="line">                sb.AppendLine(<span class="string">"&#125;"</span>);</span><br><span class="line">                sb.AppendLine(<span class="string">"throw new RpcException(\"请求出错，请检查!\");"</span>);</span><br><span class="line">                sb.AppendLine(<span class="string">"&#125;"</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">//循环方法end</span></span><br><span class="line"></span><br><span class="line">            sb.AppendLine(<span class="string">"&#125;"</span>);</span><br><span class="line">            <span class="comment">//类结束</span></span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">GenerateServiceForServer</span>(<span class="params">ServiceDescriptorProto service, StringBuilder sb</span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            <span class="keyword">int</span> serviceId;</span><br><span class="line">            <span class="keyword">bool</span> hasServiceId = service.Options.CustomOptions.TryGetInt32(DotBPEOptions.SERVICE_ID, <span class="keyword">out</span> serviceId);</span><br><span class="line">            <span class="keyword">if</span>(!hasServiceId || serviceId&lt;=<span class="number">0</span>)&#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> Exception(<span class="string">"Service="</span>+service.Name+<span class="string">" ServiceId NOT_FOUND"</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span>(serviceId&gt;=<span class="keyword">ushort</span>.MaxValue)&#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> Exception(<span class="string">"Service="</span>+service.Name+ <span class="string">"ServiceId too large"</span> );</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            sb.AppendFormat(<span class="string">"public abstract class &#123;0&#125;Base : IServiceActor&lt;AmpMessage&gt; \n"</span>, service.Name);</span><br><span class="line">            sb.AppendLine(<span class="string">"&#123;"</span>);</span><br><span class="line">            sb.AppendLine(<span class="string">"public string Id =&gt; \""</span>+serviceId+<span class="string">"$0\";"</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">            StringBuilder sbIfState = <span class="keyword">new</span> StringBuilder();</span><br><span class="line"></span><br><span class="line">            <span class="comment">//循环方法</span></span><br><span class="line">            <span class="keyword">foreach</span> (<span class="keyword">var</span> method <span class="keyword">in</span> service.Method)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">int</span> msgId ;</span><br><span class="line">                <span class="keyword">bool</span> hasMsgId= method.Options.CustomOptions.TryGetInt32(DotBPEOptions.MESSAGE_ID,<span class="keyword">out</span> msgId);</span><br><span class="line">                <span class="keyword">if</span>(!hasMsgId || msgId&lt;=<span class="number">0</span>)&#123;</span><br><span class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> Exception(<span class="string">"Service"</span>+service.Name+<span class="string">"."</span>+method.Name+<span class="string">" ' MessageId NOT_FINDOUT "</span>);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">if</span>(msgId&gt;=<span class="keyword">ushort</span>.MaxValue)&#123;</span><br><span class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> Exception(<span class="string">"Service"</span> + service.Name+<span class="string">"."</span>+method.Name+<span class="string">" is too large"</span>);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">//异步方法</span></span><br><span class="line">                <span class="keyword">string</span> outType = GetTypeName(method.OutputType);</span><br><span class="line">                <span class="keyword">string</span> inType = GetTypeName(method.InputType);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">                sb.AppendLine(<span class="string">"//调用委托"</span>);</span><br><span class="line">                sb.AppendLine(</span><br><span class="line">                    <span class="string">$"private async Task Receive<span class="subst">&#123;method.Name&#125;</span>Async(IRpcContext&lt;AmpMessage&gt; context, AmpMessage req)"</span>);</span><br><span class="line">                sb.AppendLine(<span class="string">"&#123;"</span>);</span><br><span class="line">                sb.AppendLine(<span class="string">$"var request = <span class="subst">&#123;inType&#125;</span>.Parser.ParseFrom(req.Data);"</span>);</span><br><span class="line">                sb.AppendLine(<span class="string">$"var data = await <span class="subst">&#123;method.Name&#125;</span>Async(request);"</span>);</span><br><span class="line">                sb.AppendLine(<span class="string">"var response = AmpMessage.CreateResponseMessage(req.ServiceId, req.MessageId);"</span>);</span><br><span class="line">                sb.AppendLine(<span class="string">"response.Sequence = req.Sequence;"</span>);</span><br><span class="line">                sb.AppendLine(<span class="string">"response.Data = data.ToByteArray();"</span>);</span><br><span class="line">                sb.AppendLine(<span class="string">"await context.SendAsync(response);"</span>);</span><br><span class="line">                sb.AppendLine(<span class="string">"&#125;"</span>);</span><br><span class="line"></span><br><span class="line">                sb.AppendLine();</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">                sb.AppendLine(<span class="string">"//抽象方法"</span>);</span><br><span class="line">                sb.AppendLine(<span class="string">$"public abstract Task&lt;<span class="subst">&#123;outType&#125;</span>&gt; <span class="subst">&#123;method.Name&#125;</span>Async(<span class="subst">&#123;inType&#125;</span> request);"</span>);</span><br><span class="line"></span><br><span class="line">                <span class="comment">//拼装if调用语句</span></span><br><span class="line">                sbIfState.AppendFormat(<span class="string">"//方法&#123;0&#125;.&#123;1&#125;\n"</span>,service.Name,method.Name);</span><br><span class="line">                sbIfState.AppendLine(<span class="string">"if(req.MessageId == "</span>+msgId+<span class="string">")&#123;return this.Receive"</span>+method.Name+<span class="string">"Async(context, req);&#125;"</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">//循环方法end</span></span><br><span class="line">            <span class="comment">//生成主调用代码</span></span><br><span class="line">            sb.AppendLine(<span class="string">"public Task ReceiveAsync(IRpcContext&lt;AmpMessage&gt; context, AmpMessage req)"</span>);</span><br><span class="line">            sb.AppendLine(<span class="string">"&#123;"</span>);</span><br><span class="line">            sb.Append(sbIfState);</span><br><span class="line">            sb.AppendLine(<span class="string">"return Task.CompletedTask;"</span>);</span><br><span class="line">            sb.AppendLine(<span class="string">"&#125;"</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">            sb.AppendLine(<span class="string">"&#125;"</span>);</span><br><span class="line">            <span class="comment">//类结束</span></span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">string</span> <span class="title">GetFileNamespace</span>(<span class="params">FileDescriptorProto protofile</span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            <span class="keyword">string</span> ns = protofile.Options.CsharpNamespace;</span><br><span class="line">            <span class="keyword">if</span> (<span class="keyword">string</span>.IsNullOrEmpty(ns))</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> Exception(<span class="string">""</span> + protofile.Name + <span class="string">".proto did not set csharp_namespace"</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> ConvertCamelCase(ns);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">string</span> <span class="title">GetFileName</span>(<span class="params"><span class="keyword">string</span> fileProto</span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            <span class="keyword">string</span> nomalName = fileProto.Split(<span class="string">'.'</span>)[<span class="number">0</span>];</span><br><span class="line">            <span class="keyword">return</span> ConvertCamelCase(nomalName);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">string</span> <span class="title">ConvertCamelCase</span>(<span class="params"><span class="keyword">string</span> nomalName</span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            <span class="keyword">return</span> String.Join(<span class="string">""</span>, nomalName.Split(<span class="string">'_'</span>).Select(_ =&gt; _.Substring(<span class="number">0</span>, <span class="number">1</span>).ToUpper() + _.Substring(<span class="number">1</span>)));</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">string</span> <span class="title">GetTypeName</span>(<span class="params"><span class="keyword">string</span> typeFullName</span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            <span class="keyword">return</span> ConvertCamelCase(typeFullName.Split(<span class="string">'.'</span>).Last());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><p>然后我们编写一个proto文件测试以下</p><p></p><figure class="highlight protobuf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//benchmark.proto</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">syntax = <span class="string">"proto3"</span>;</span><br><span class="line"><span class="keyword">package</span> dotbpe;</span><br><span class="line"></span><br><span class="line"><span class="keyword">option</span> csharp_namespace = <span class="string">"DotBPE.IntegrationTesting"</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> public <span class="string">"dotbpe_option.proto"</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">option</span> optimize_for = SPEED;</span><br><span class="line"></span><br><span class="line"><span class="comment">//Benchmark测试服务</span></span><br><span class="line"><span class="class"><span class="keyword">service</span> <span class="title">BenchmarkTest</span></span>&#123;</span><br><span class="line">    <span class="keyword">option</span> (service_id)= <span class="number">50000</span> ;<span class="comment">//设定服务ID</span></span><br><span class="line">    <span class="comment">//测试发送Echo消息</span></span><br><span class="line">    <span class="function"><span class="keyword">rpc</span> Echo (BenchmarkMessage) <span class="keyword">returns</span> (BenchmarkMessage)&#123;</span></span><br><span class="line"><span class="function">        option (message_id)= 1 </span>;<span class="comment">//设定消息ID</span></span><br><span class="line">    &#125;;<span class="comment">//Echo尾部的注释</span></span><br><span class="line">    <span class="comment">// 测试发送退出消息</span></span><br><span class="line">    <span class="function"><span class="keyword">rpc</span> Quit (Void) <span class="keyword">returns</span> (Void)&#123;</span></span><br><span class="line"><span class="function">        option (message_id)= 10000 </span>;<span class="comment">//设定消息ID</span></span><br><span class="line">    &#125;;<span class="comment">//Quit尾部的注释</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//我是void消息</span></span><br><span class="line"><span class="class"><span class="keyword">message</span> <span class="title">Void</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//我是BenchmarkMessage消息</span></span><br><span class="line"><span class="class"><span class="keyword">message</span> <span class="title">BenchmarkMessage</span> </span>&#123;</span><br><span class="line">  <span class="comment">//字段前的注释</span></span><br><span class="line">  <span class="built_in">string</span> field1 = <span class="number">1</span>; <span class="comment">//字段后的注释</span></span><br><span class="line">  <span class="comment">//字段前的注释 多行</span></span><br><span class="line">  <span class="comment">//字段前的字数多行</span></span><br><span class="line">  <span class="built_in">int32</span> field2 = <span class="number">2</span>; <span class="comment">//字段后的注释</span></span><br><span class="line"></span><br><span class="line">  /**</span><br><span class="line">  * 字段前注释特殊格式</span><br><span class="line">  * 字段前注释特殊格式多行</span><br><span class="line">  */</span><br><span class="line">  <span class="built_in">int32</span> field3 = <span class="number">3</span>;</span><br><span class="line">  <span class="built_in">string</span> field4 = <span class="number">4</span>;</span><br><span class="line">  <span class="keyword">repeated</span> <span class="built_in">fixed64</span> field5 = <span class="number">5</span>;</span><br><span class="line">  <span class="built_in">string</span> field9 = <span class="number">9</span>;</span><br><span class="line">  <span class="built_in">string</span> field18 = <span class="number">18</span>;</span><br><span class="line">  <span class="built_in">bool</span> field80 = <span class="number">80</span>;</span><br><span class="line">  <span class="built_in">bool</span> field81 = <span class="number">81</span>;</span><br><span class="line"></span><br><span class="line">  <span class="built_in">int32</span> field280 = <span class="number">280</span> ;</span><br><span class="line">  <span class="built_in">int32</span> field6 = <span class="number">6</span>;</span><br><span class="line">  <span class="built_in">int64</span> field22 = <span class="number">22</span> ;</span><br><span class="line"></span><br><span class="line">  <span class="built_in">bool</span> field59 = <span class="number">59</span> ;</span><br><span class="line">  <span class="built_in">string</span> field7 = <span class="number">7</span>;</span><br><span class="line">  <span class="built_in">int32</span> field16 = <span class="number">16</span> ;</span><br><span class="line">  <span class="built_in">int32</span> field130 = <span class="number">130</span> ;</span><br><span class="line">  <span class="built_in">bool</span> field12 = <span class="number">12</span> ;</span><br><span class="line">  <span class="built_in">bool</span> field17 = <span class="number">17</span>;</span><br><span class="line">  <span class="built_in">bool</span> field13 = <span class="number">13</span>;</span><br><span class="line">  <span class="built_in">bool</span> field14 = <span class="number">14</span>;</span><br><span class="line">  <span class="built_in">int32</span> field104 = <span class="number">104</span> ;</span><br><span class="line">  <span class="built_in">int32</span> field100 = <span class="number">100</span> ;</span><br><span class="line">  <span class="built_in">int32</span> field101 = <span class="number">101</span> ;</span><br><span class="line">  <span class="built_in">string</span> field102 = <span class="number">102</span>;</span><br><span class="line">  <span class="built_in">string</span> field103 = <span class="number">103</span>;</span><br><span class="line">  <span class="built_in">int32</span> field29 = <span class="number">29</span> ;</span><br><span class="line">  <span class="built_in">bool</span> field30 = <span class="number">30</span> ;</span><br><span class="line">  <span class="built_in">int32</span> field60 = <span class="number">60</span> ;</span><br><span class="line">  <span class="built_in">int32</span> field271 = <span class="number">271</span> ;</span><br><span class="line">  <span class="built_in">int32</span> field272 = <span class="number">272</span>;</span><br><span class="line">  <span class="built_in">int32</span> field150 = <span class="number">150</span>;</span><br><span class="line">  <span class="built_in">int32</span> field23 = <span class="number">23</span>;</span><br><span class="line">  <span class="built_in">bool</span> field24 = <span class="number">24</span>;</span><br><span class="line">  <span class="built_in">int32</span> field25 = <span class="number">25</span> ;</span><br><span class="line">  <span class="built_in">bool</span> field78 = <span class="number">78</span> ;</span><br><span class="line">  <span class="built_in">int32</span> field67 = <span class="number">67</span>;</span><br><span class="line">  <span class="built_in">int32</span> field68 = <span class="number">68</span> ;</span><br><span class="line">  <span class="built_in">int32</span> field128 = <span class="number">128</span> ;</span><br><span class="line">  <span class="built_in">string</span> field129 = <span class="number">129</span> ;</span><br><span class="line">  <span class="built_in">int32</span> field131 = <span class="number">131</span> ;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><p></p><figure class="highlight protobuf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// dotbpe_option.proto</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// [START declaration]</span></span><br><span class="line">syntax = <span class="string">"proto3"</span>;</span><br><span class="line"><span class="keyword">package</span> dotbpe;</span><br><span class="line"><span class="comment">// [END declaration]</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// [START csharp_declaration]</span></span><br><span class="line"><span class="keyword">option</span> csharp_namespace = <span class="string">"DotBPE.ProtoBuf"</span>;</span><br><span class="line"><span class="comment">// [END csharp_declaration]</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> <span class="string">"google/protobuf/descriptor.proto"</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">//扩展服务</span></span><br><span class="line">extend google.protobuf.ServiceOptions &#123;</span><br><span class="line">  <span class="built_in">int32</span> service_id = <span class="number">51001</span>;</span><br><span class="line">  <span class="built_in">bool</span> disable_generic_service_client = <span class="number">51003</span>; <span class="comment">//是否生成客户端代码</span></span><br><span class="line">  <span class="built_in">bool</span> disable_generic_service_server = <span class="number">51004</span>; <span class="comment">//是否生成服务端代码</span></span><br><span class="line">&#125;</span><br><span class="line">extend google.protobuf.MethodOptions &#123;</span><br><span class="line">  <span class="built_in">int32</span> message_id = <span class="number">51002</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">extend google.protobuf.FileOptions &#123;</span><br><span class="line">  <span class="built_in">bool</span> disable_generic_services_client = <span class="number">51003</span>; <span class="comment">//是否生成客户端代码</span></span><br><span class="line">  <span class="built_in">bool</span> disable_generic_services_server = <span class="number">51004</span>; <span class="comment">//是否生成服务端代码</span></span><br><span class="line">  <span class="built_in">bool</span> generic_markdown_doc = <span class="number">51005</span>; <span class="comment">//是否生成文档</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><p>上面的dotbpe_option.proto 我们proto文件进行了自定义的扩展，添加一些自己需要的额外信息，其实所有扩展都是对<code>descriptor.proto</code>中消息的扩展。</p><p>然后我们通过命令来生成一下，这里有个特殊的约定，一定要注意当我们设置</p><p>protoc-gen-<strong>dotbpe</strong>=../../tool/ampplugin/dotbpe_amp.exe 插件的名称protoc-gen-<strong>dotbpe</strong>时，那么输出的目录一定要写成--<strong>dotbpe</strong>_out ，两个名字一点要匹配哦</p><p></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">set -ex</span><br><span class="line"></span><br><span class="line">cd $(dirname $0)/../../test/IntegrationTesting/</span><br><span class="line"></span><br><span class="line">PROTOC=protoc</span><br><span class="line">PLUGIN=protoc-gen-dotbpe=../../tool/ampplugin/dotbpe_amp.exe</span><br><span class="line">IntegrationTesting_DIR=./DotBPE.IntegrationTesting/</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">$</span>PROTOC  -I=./protos --csharp_out=$IntegrationTesting_DIR --dotbpe_out=$IntegrationTesting_DIR \</span><br><span class="line">    ./protos/benchmark.proto  --plugin=$PLUGIN</span><br></pre></td></tr></table></figure><p></p><p>差不多就结束了，相关的代码可以在<a href="https://github.com/xuanye/dotbpe/tree/develop/src/tool" target="_blank" rel="noopener">https://github.com/xuanye/dotbpe/tree/develop/src/tool</a> 查看到，这是我最近在写的一个C#的rpc框架，现在完成了基本的功能，还需要进一步完善，有机会再介绍把。</p><p><strong>descriptor.proto信息挖掘</strong></p><p>我们注意到在descriptor.proto文件中包含有这样的一个message: SourceCodeInfo, 这个消息体里有如下字段</p><p></p><figure class="highlight protobuf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">optional</span> <span class="built_in">string</span> leading_comments = <span class="number">3</span>;</span><br><span class="line"><span class="keyword">optional</span> <span class="built_in">string</span> trailing_comments = <span class="number">4</span>;</span><br><span class="line"><span class="keyword">repeated</span> <span class="built_in">string</span> leading_detached_comments = <span class="number">6</span>;</span><br></pre></td></tr></table></figure><p></p><p>这是非常有意思的定义，意思是可以在运行时获取到proto文件中的注释。这可以帮助我们生成 文档或者代码注释，但是读取逻辑比较复杂，其内部有一个通过Path和Span来定位元素的逻辑。因为在实际的情况中，一般都是要获取Service和Message上的注释，那么就来专门讨论一下如何获取这两个类型的注释吧。</p><p>下面是 <code>SourceCodeInfo.Location</code> 中我们需要用到Path示例</p><p></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">* [4, m] - Message的注释</span><br><span class="line">* [4, m, 2, f] - Message 中 字段（field）的注释</span><br><span class="line">* [6, s] - Service的注释</span><br><span class="line">* [6, s, 2, r] - Service中Rpc方法的注释</span><br></pre></td></tr></table></figure><p></p><p>where:</p><ul><li><code>m</code> - proto文件中Message的索引（就是第几个定义的Message）, 从0开始</li><li><code>f</code> - Message中Field字段的索引（就是第几个字段）, 从0开始</li><li><code>s</code> - proto文件中Service的索引, 从0开始</li><li><code>r</code> - Service中Rpc方法的索引, 从0开始</li></ul><p>like this:</p><p></p><figure class="highlight protobuf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// [4, 0] 就是这里的注释 </span></span><br><span class="line"><span class="class"><span class="keyword">message</span> <span class="title">MyMessage</span> </span>&#123;</span><br><span class="line">  <span class="comment">// [4, 0, 2, 0] 在这里</span></span><br><span class="line">  <span class="built_in">int32</span> field1 = <span class="number">1</span>; <span class="comment">// [4, 0, 2, 0] 也在这里</span></span><br><span class="line">&#125;<span class="comment">// [4, 0] 就是这里的注释 </span></span><br><span class="line"></span><br><span class="line"><span class="comment">// [6, 0] 在这里!</span></span><br><span class="line"><span class="class"><span class="keyword">service</span> <span class="title">MyService</span> </span>&#123;</span><br><span class="line">  <span class="comment">// [6, 0, 2, 0] 在这里!</span></span><br><span class="line">  <span class="function"><span class="keyword">rpc</span> (MyMessage) <span class="keyword">returns</span> (MyMessage)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><p>想要了解全部内容可以去看下<code>descriptor.proto</code>中的注释内容 吧</p></div><footer class="post-footer"><div class="post-eof"></div></footer></div></article></section><nav class="pagination"><span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><a class="page-number" href="/page/3/">3</a><a class="extend next" rel="next" href="/page/2/"><i class="fa fa-angle-right"></i></a></nav></div></div><div class="sidebar-toggle"><div class="sidebar-toggle-line-wrap"><span class="sidebar-toggle-line sidebar-toggle-line-first"></span> <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span> <span class="sidebar-toggle-line sidebar-toggle-line-last"></span></div></div><aside id="sidebar" class="sidebar"><div class="sidebar-inner"><section class="site-overview-wrap sidebar-panel sidebar-panel-active"><div class="site-overview"><div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person"><img class="site-author-image" itemprop="image" src="/uploads/avatar.png" alt="Xuanye"><p class="site-author-name" itemprop="name">Xuanye</p><p class="site-description motion-element" itemprop="description"></p></div><nav class="site-state motion-element"><div class="site-state-item site-state-posts"><a href="/archives/"><span class="site-state-item-count">17</span> <span class="site-state-item-name">posts</span></a></div><div class="site-state-item site-state-categories"><a href="/categories/index.html"><span class="site-state-item-count">4</span> <span class="site-state-item-name">categories</span></a></div><div class="site-state-item site-state-tags"><a href="/tags/index.html"><span class="site-state-item-count">28</span> <span class="site-state-item-name">tags</span></a></div></nav><div class="feed-link motion-element"><a href="/atom.xml" rel="alternate"><i class="fa fa-rss"></i> RSS</a></div><div class="links-of-author motion-element"><span class="links-of-author-item"><a href="https://github.com/xuanye" target="_blank" title="GitHub" rel="external nofollow"><i class="fa fa-fw fa-github"></i>GitHub</a> </span><span class="links-of-author-item"><a href="https://twitter.com/xuanyewong" target="_blank" title="Twitter" rel="external nofollow"><i class="fa fa-fw fa-twitter"></i>Twitter</a></span></div></div></section></div></aside></div></main><footer id="footer" class="footer"><div class="footer-inner"><div class="copyright">&copy; 2014 &mdash; <span itemprop="copyrightYear">2020</span> <span class="with-love"><i class="fa fa-heart"></i> </span><span class="author" itemprop="copyrightHolder">Xuanye</span></div><div class="powered-by">Powered by <a class="theme-link" target="_blank" rel="external nofollow" href="https://hexo.io">Hexo</a></div><span class="post-meta-divider">|</span><div class="theme-info">Theme &mdash; <a class="theme-link" target="_blank" rel="external nofollow" href="https://github.com/theme-next/hexo-theme-next">NexT.Gemini</a></div></div></footer><div class="back-to-top"><i class="fa fa-arrow-up"></i></div></div><script type="text/javascript">if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }</script><script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script><script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script><script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script><script type="text/javascript" src="/lib/three/three.min.js"></script><script type="text/javascript" src="/lib/three/canvas_lines.min.js"></script><script type="text/javascript" src="/lib/reading_progress/reading_progress.js"></script><script type="text/javascript" src="/js/src/utils.js?v=6.0.3"></script><script type="text/javascript" src="/js/src/motion.js?v=6.0.3"></script><script type="text/javascript" src="/js/src/affix.js?v=6.0.3"></script><script type="text/javascript" src="/js/src/schemes/pisces.js?v=6.0.3"></script><script type="text/javascript" src="/js/src/bootstrap.js?v=6.0.3"></script><!-- LOCAL: You can save these files to your site and update links --><link rel="stylesheet" href="https://aimingoo.github.io/gitmint/style/default.css"><script src="https://aimingoo.github.io/gitmint/dist/gitmint.browser.js"></script><!-- END LOCAL --><script type="text/javascript">// Popup Window;
    var isfetched = false;
    var isXml = true;
    // Search DB path;
    var search_path = "search.xml";
    if (search_path.length === 0) {
      search_path = "search.xml";
    } else if (/json$/i.test(search_path)) {
      isXml = false;
    }
    var path = "/" + search_path;
    // monitor main search box;

    var onPopupClose = function (e) {
      $('.popup').hide();
      $('#local-search-input').val('');
      $('.search-result-list').remove();
      $('#no-result').remove();
      $(".local-search-pop-overlay").remove();
      $('body').css('overflow', '');
    }

    function proceedsearch() {
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay"></div>')
        .css('overflow', 'hidden');
      $('.search-popup-overlay').click(onPopupClose);
      $('.popup').toggle();
      var $localSearchInput = $('#local-search-input');
      $localSearchInput.attr("autocapitalize", "none");
      $localSearchInput.attr("autocorrect", "off");
      $localSearchInput.focus();
    }

    // search function;
    var searchFunc = function(path, search_id, content_id) {
      'use strict';

      // start loading animation
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay">' +
          '<div id="search-loading-icon">' +
          '<i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>' +
          '</div>' +
          '</div>')
        .css('overflow', 'hidden');
      $("#search-loading-icon").css('margin', '20% auto 0 auto').css('text-align', 'center');

      

      $.ajax({
        url: path,
        dataType: isXml ? "xml" : "json",
        async: true,
        success: function(res) {
          // get the contents from search data
          isfetched = true;
          $('.popup').detach().appendTo('.header-inner');
          var datas = isXml ? $("entry", res).map(function() {
            return {
              title: $("title", this).text(),
              content: $("content",this).text(),
              url: $("url" , this).text()
            };
          }).get() : res;
          var input = document.getElementById(search_id);
          var resultContent = document.getElementById(content_id);
          var inputEventFunction = function() {
            var searchText = input.value.trim().toLowerCase();
            var keywords = searchText.split(/[\s\-]+/);
            if (keywords.length > 1) {
              keywords.push(searchText);
            }
            var resultItems = [];
            if (searchText.length > 0) {
              // perform local searching
              datas.forEach(function(data) {
                var isMatch = false;
                var hitCount = 0;
                var searchTextCount = 0;
                var title = data.title.trim();
                var titleInLowerCase = title.toLowerCase();
                var content = data.content.trim().replace(/<[^>]+>/g,"");
                
                var contentInLowerCase = content.toLowerCase();
                var articleUrl = decodeURIComponent(data.url);
                var indexOfTitle = [];
                var indexOfContent = [];
                // only match articles with not empty titles
                if(title != '') {
                  keywords.forEach(function(keyword) {
                    function getIndexByWord(word, text, caseSensitive) {
                      var wordLen = word.length;
                      if (wordLen === 0) {
                        return [];
                      }
                      var startPosition = 0, position = [], index = [];
                      if (!caseSensitive) {
                        text = text.toLowerCase();
                        word = word.toLowerCase();
                      }
                      while ((position = text.indexOf(word, startPosition)) > -1) {
                        index.push({position: position, word: word});
                        startPosition = position + wordLen;
                      }
                      return index;
                    }

                    indexOfTitle = indexOfTitle.concat(getIndexByWord(keyword, titleInLowerCase, false));
                    indexOfContent = indexOfContent.concat(getIndexByWord(keyword, contentInLowerCase, false));
                  });
                  if (indexOfTitle.length > 0 || indexOfContent.length > 0) {
                    isMatch = true;
                    hitCount = indexOfTitle.length + indexOfContent.length;
                  }
                }

                // show search results

                if (isMatch) {
                  // sort index by position of keyword

                  [indexOfTitle, indexOfContent].forEach(function (index) {
                    index.sort(function (itemLeft, itemRight) {
                      if (itemRight.position !== itemLeft.position) {
                        return itemRight.position - itemLeft.position;
                      } else {
                        return itemLeft.word.length - itemRight.word.length;
                      }
                    });
                  });

                  // merge hits into slices

                  function mergeIntoSlice(text, start, end, index) {
                    var item = index[index.length - 1];
                    var position = item.position;
                    var word = item.word;
                    var hits = [];
                    var searchTextCountInSlice = 0;
                    while (position + word.length <= end && index.length != 0) {
                      if (word === searchText) {
                        searchTextCountInSlice++;
                      }
                      hits.push({position: position, length: word.length});
                      var wordEnd = position + word.length;

                      // move to next position of hit

                      index.pop();
                      while (index.length != 0) {
                        item = index[index.length - 1];
                        position = item.position;
                        word = item.word;
                        if (wordEnd > position) {
                          index.pop();
                        } else {
                          break;
                        }
                      }
                    }
                    searchTextCount += searchTextCountInSlice;
                    return {
                      hits: hits,
                      start: start,
                      end: end,
                      searchTextCount: searchTextCountInSlice
                    };
                  }

                  var slicesOfTitle = [];
                  if (indexOfTitle.length != 0) {
                    slicesOfTitle.push(mergeIntoSlice(title, 0, title.length, indexOfTitle));
                  }

                  var slicesOfContent = [];
                  while (indexOfContent.length != 0) {
                    var item = indexOfContent[indexOfContent.length - 1];
                    var position = item.position;
                    var word = item.word;
                    // cut out 100 characters
                    var start = position - 20;
                    var end = position + 80;
                    if(start < 0){
                      start = 0;
                    }
                    if (end < position + word.length) {
                      end = position + word.length;
                    }
                    if(end > content.length){
                      end = content.length;
                    }
                    slicesOfContent.push(mergeIntoSlice(content, start, end, indexOfContent));
                  }

                  // sort slices in content by search text's count and hits' count

                  slicesOfContent.sort(function (sliceLeft, sliceRight) {
                    if (sliceLeft.searchTextCount !== sliceRight.searchTextCount) {
                      return sliceRight.searchTextCount - sliceLeft.searchTextCount;
                    } else if (sliceLeft.hits.length !== sliceRight.hits.length) {
                      return sliceRight.hits.length - sliceLeft.hits.length;
                    } else {
                      return sliceLeft.start - sliceRight.start;
                    }
                  });

                  // select top N slices in content

                  var upperBound = parseInt('10');
                  if (upperBound >= 0) {
                    slicesOfContent = slicesOfContent.slice(0, upperBound);
                  }

                  // highlight title and content

                  function highlightKeyword(text, slice) {
                    var result = '';
                    var prevEnd = slice.start;
                    slice.hits.forEach(function (hit) {
                      result += text.substring(prevEnd, hit.position);
                      var end = hit.position + hit.length;
                      result += '<b class="search-keyword">' + text.substring(hit.position, end) + '</b>';
                      prevEnd = end;
                    });
                    result += text.substring(prevEnd, slice.end);
                    return result;
                  }

                  var resultItem = '';

                  if (slicesOfTitle.length != 0) {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + highlightKeyword(title, slicesOfTitle[0]) + "</a>";
                  } else {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + title + "</a>";
                  }

                  slicesOfContent.forEach(function (slice) {
                    resultItem += "<a href='" + articleUrl + "'>" +
                      "<p class=\"search-result\">" + highlightKeyword(content, slice) +
                      "...</p>" + "</a>";
                  });

                  resultItem += "</li>";
                  resultItems.push({
                    item: resultItem,
                    searchTextCount: searchTextCount,
                    hitCount: hitCount,
                    id: resultItems.length
                  });
                }
              })
            };
            if (keywords.length === 1 && keywords[0] === "") {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-search fa-5x" /></div>'
            } else if (resultItems.length === 0) {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-frown-o fa-5x" /></div>'
            } else {
              resultItems.sort(function (resultLeft, resultRight) {
                if (resultLeft.searchTextCount !== resultRight.searchTextCount) {
                  return resultRight.searchTextCount - resultLeft.searchTextCount;
                } else if (resultLeft.hitCount !== resultRight.hitCount) {
                  return resultRight.hitCount - resultLeft.hitCount;
                } else {
                  return resultRight.id - resultLeft.id;
                }
              });
              var searchResultList = '<ul class=\"search-result-list\">';
              resultItems.forEach(function (result) {
                searchResultList += result.item;
              })
              searchResultList += "</ul>";
              resultContent.innerHTML = searchResultList;
            }
          }

          if ('auto' === 'auto') {
            input.addEventListener('input', inputEventFunction);
          } else {
            $('.search-icon').click(inputEventFunction);
            input.addEventListener('keypress', function (event) {
              if (event.keyCode === 13) {
                inputEventFunction();
              }
            });
          }

          // remove loading animation
          $(".local-search-pop-overlay").remove();
          $('body').css('overflow', '');

          proceedsearch();
        }
      });
    }

    // handle and trigger popup window;
    $('.popup-trigger').click(function(e) {
      e.stopPropagation();
      if (isfetched === false) {
        searchFunc(path, 'local-search-input', 'local-search-result');
      } else {
        proceedsearch();
      };
    });

    $('.popup-btn-close').click(onPopupClose);
    $('.popup').click(function(e){
      e.stopPropagation();
    });
    $(document).on('keyup', function (event) {
      var shouldDismissSearchPopup = event.which === 27 &&
        $('.search-popup').is(':visible');
      if (shouldDismissSearchPopup) {
        onPopupClose();
      }
    });</script></body></html>